# Implementation Plan: 市場監控頁面交易所快速連結

**Branch**: `008-specify-scripts-bash` | **Date**: 2025-11-06 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/008-specify-scripts-bash/spec.md`

## Summary

在市場監控頁面的每個交易所費率欄位中新增可點擊的外部連結圖示，讓用戶可以快速跳轉到對應交易所的永續合約頁面。此功能為純前端 UI 增強，不涉及後端 API 或資料庫變更。

**Technical Approach**:
- 建立 URL Builder 模組，集中管理四個交易所的 URL 模板和符號格式轉換
- 開發 ExchangeLink React 元件，使用 Radix UI Tooltip 和 Lucide React 圖示
- 整合到現有的 RateRow 元件中
- 使用多層次測試策略（單元測試、元件測試、E2E 測試）

## Technical Context

**Language/Version**: TypeScript 5.6 + Node.js 20.x LTS
**Primary Dependencies**: React 18, Next.js 14 App Router, Tailwind CSS, Radix UI Tooltip, Lucide React
**Storage**: N/A（純前端功能，無資料持久化）
**Testing**: Vitest（單元測試和元件測試）, Playwright（E2E 測試）
**Target Platform**: Web（桌面和移動裝置瀏覽器）
**Project Type**: Web application（Next.js 14 App Router with TypeScript）
**Performance Goals**:
- URL 生成時間 < 1ms
- 元件首次渲染時間 < 5ms
- 圖示載入時間 < 50ms（inline SVG）
- Tooltip 顯示延遲 200ms（Radix UI 預設）
**Constraints**:
- 圖示尺寸 16x16px 以避免視覺混亂
- 必須符合 WCAG 無障礙標準
- 必須使用 `rel="noopener noreferrer"` 確保安全性
- 必須支援鍵盤導航
**Scale/Scope**:
- 支援 4 個交易所（Binance, OKX, MEXC, Gate.io）
- 每個市場監控頁面顯示 10-50 個交易對
- 每個交易對有 4 個交易所連結
- 預估新增程式碼 < 500 行

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Trading Safety First (Principle I)

✅ **N/A - 不適用**

**Rationale**: 此功能為純 UI 增強，不涉及交易執行、訂單管理或資金操作。無需交易安全機制。

### Complete Observability (Principle II)

✅ **PASS - 符合要求**

**Rationale**:
- 此功能為純前端操作，無後端 API 呼叫
- URL 生成錯誤會在元件層級處理並顯示為禁用狀態
- 如果未來需要追蹤點擊行為，可在 ExchangeLink 元件中添加 onClick callback
- 當前階段無需額外日誌記錄（符合需求）

### Defensive Programming (Principle III)

✅ **PASS - 符合要求**

**Implementation**:
- **輸入驗證**: URL Builder 驗證交易所名稱和交易對符號格式
- **錯誤處理**: 使用 `UrlBuilderResult` 類型返回錯誤，避免拋出異常
- **優雅降級**: 當 URL 生成失敗或交易對不可用時，圖示顯示為灰色且不可點擊
- **類型安全**: 使用 TypeScript 嚴格類型，在編譯時捕獲錯誤

**No External API Calls**: 純計算，無網路請求，無需 retry 邏輯。

### Data Integrity (Principle IV)

✅ **N/A - 不適用**

**Rationale**: 此功能不涉及資料庫操作或資料持久化。

### Incremental Delivery (Principle V)

✅ **PASS - 符合要求**

**Implementation Strategy**:
- **獨立功能**: 此功能為獨立的 UI 增強，不依賴其他未完成功能
- **可獨立測試**: 單元測試、元件測試、E2E 測試都可獨立執行
- **可獨立交付**: 功能完成後可立即合併到主分支並部署
- **無阻塞**: 不會阻塞其他功能的開發

**Testing Strategy**:
- 單元測試（URL Builder）→ 元件測試（ExchangeLink）→ 整合測試（RateRow）→ E2E 測試
- 所有測試可在本地環境執行，無需特殊環境

### Post-Design Re-check

*To be completed after Phase 1*

## Project Structure

### Documentation (this feature)

```
specs/008-specify-scripts-bash/
├── plan.md              # This file
├── research.md          # ✅ Phase 0 output (completed)
├── data-model.md        # ✅ Phase 1 output (completed)
├── quickstart.md        # ✅ Phase 1 output (completed)
├── contracts/           # ✅ Phase 1 output (completed)
│   └── types.ts         # TypeScript type definitions
└── tasks.md             # Phase 2 output (to be generated by /speckit.tasks)
```

### Source Code (repository root)

```
src/
├── types/
│   └── exchange-links.ts            # 類型定義（從 contracts/types.ts 複製）
│
├── lib/
│   └── exchanges/
│       ├── url-builder.ts           # URL 生成邏輯（新增）
│       └── constants.ts             # 交易所配置常數（新增）
│
└── components/
    └── market/
        └── ExchangeLink.tsx         # 連結元件（新增）

app/
└── (dashboard)/
    └── market-monitor/
        └── components/
            └── RateRow.tsx          # 修改：整合 ExchangeLink

tests/
├── unit/
│   ├── lib/
│   │   └── url-builder.test.ts     # URL Builder 單元測試（新增）
│   └── components/
│       └── ExchangeLink.test.tsx   # 元件測試（新增）
│
└── e2e/
    └── market-monitor-exchange-links.spec.ts  # E2E 測試（新增）
```

**Structure Decision**: 使用 Option 1（Single project）結構，因為專案已經是單一的 Next.js 應用，前後端共用同一個 codebase。

## Complexity Tracking

**No violations requiring justification**. 此功能遵循所有專案憲法原則：

- 沒有引入新的依賴複雜度（Radix UI Tooltip 是標準 UI 元件庫）
- 沒有增加系統架構複雜度（純前端功能）
- 沒有違反安全或效能要求
- 符合增量交付原則

## Phase 0: Research (✅ Completed)

See [research.md](./research.md) for complete research findings.

**Key Decisions**:
1. **URL 映射管理**: 建立獨立的 URL Builder 模組
2. **視覺呈現**: 圖示 + Tooltip（使用 Radix UI 和 Lucide React）
3. **圖示位置**: 在費率數值旁邊（16x16px 小圖示）
4. **符號格式轉換**: 在 URL Builder 中集中處理
5. **測試策略**: 多層次測試（單元、元件、E2E）

**All NEEDS CLARIFICATION resolved**: ✅

## Phase 1: Design & Contracts (✅ Completed)

### Data Model

See [data-model.md](./data-model.md) for complete data model specification.

**Key Interfaces**:
- `ExchangeUrlConfig`: 交易所 URL 配置
- `ExchangeLinkProps`: React 元件屬性
- `UrlBuilderResult`: URL 生成結果
- `SupportedExchange`: 支援的交易所類型

**No Database Changes Required**: 純前端功能。

### Contracts

See [contracts/types.ts](./contracts/types.ts) for TypeScript type definitions.

**Exported Types**:
- Type definitions for all interfaces
- Constants (SUPPORTED_EXCHANGES, EXCHANGE_DISPLAY_NAMES, SYMBOL_FORMAT_REGEX)
- Type guards (isSupportedExchange, isValidSymbolFormat)
- Custom error class (ExchangeLinkError)

### Quickstart Guide

See [quickstart.md](./quickstart.md) for step-by-step implementation guide.

**Estimated Implementation Time**: 4-6 hours

### Agent Context Update

執行 agent context 更新腳本：

```bash
.specify/scripts/bash/update-agent-context.sh claude
```

**Technologies to Add**:
- `@radix-ui/react-tooltip`: UI 元件庫，用於無障礙的 Tooltip
- `lucide-react`: 圖示庫（已存在，無需更新）

### Constitution Re-check

**Post-Design Verification**: ✅ All principles still satisfied

- **Principle I (Trading Safety)**: N/A
- **Principle II (Observability)**: ✅ 錯誤處理在前端完成
- **Principle III (Defensive)**: ✅ 完整的輸入驗證和錯誤處理
- **Principle IV (Data Integrity)**: N/A
- **Principle V (Incremental)**: ✅ 可獨立交付和測試

**No new violations introduced**.

## Phase 2: Tasks (To be generated)

Run `/speckit.tasks` command to generate detailed task breakdown.

**Expected Task Count**: 15-20 tasks

**Task Categories**:
1. **Setup**: 安裝依賴、複製類型定義
2. **Core Implementation**: URL Builder、ExchangeLink 元件
3. **Integration**: 整合到 RateRow 元件
4. **Testing**: 單元測試、元件測試、E2E 測試
5. **Documentation**: 更新相關文件
6. **Review**: Code review 和 QA

## Dependencies

### External Dependencies

**New**:
```json
{
  "@radix-ui/react-tooltip": "^1.0.0"
}
```

**Existing (Reused)**:
- `lucide-react`: ExternalLink 圖示
- `next`: Next.js 框架
- `react`: React 庫
- `tailwindcss`: CSS 框架
- `vitest`: 測試框架
- `playwright`: E2E 測試

### Internal Dependencies

**Existing Components**:
- `app/(dashboard)/market-monitor/components/RateRow.tsx`: 需要修改以整合 ExchangeLink
- `app/(dashboard)/market-monitor/components/RatesTable.tsx`: 可能需要傳遞額外 props

**Existing Utilities**:
- `src/lib/utils.ts`: 使用 `cn()` 函數合併 className

## Testing Strategy

### Unit Tests (Vitest)

**Files**:
- `tests/unit/lib/url-builder.test.ts`

**Coverage**:
- 有效輸入測試（4 個交易所 × 多個交易對）
- 無效輸入測試（不支援的交易所、無效符號格式、空字串）
- 邊界情況（特殊符號、極長符號）
- 符號格式轉換（每個交易所的格式規則）

### Component Tests (Vitest + React Testing Library)

**Files**:
- `tests/unit/components/ExchangeLink.test.tsx`

**Coverage**:
- 正常渲染（有效 exchange 和 symbol）
- 禁用狀態（isAvailable=false）
- Tooltip 顯示
- 點擊事件
- 無障礙屬性（aria-label, tabIndex）

### Integration Tests

**Approach**: 在 RateRow 元件測試中驗證 ExchangeLink 正確整合

### E2E Tests (Playwright)

**Files**:
- `tests/e2e/market-monitor-exchange-links.spec.ts`

**Coverage**:
- 圖示顯示測試
- 新分頁開啟測試（每個交易所）
- Tooltip 顯示測試
- 不可用狀態測試
- 跨瀏覽器測試（Chromium, Firefox, WebKit）

### Test Coverage Target

- **Unit Tests**: 95%+ coverage for url-builder.ts
- **Component Tests**: 90%+ coverage for ExchangeLink.tsx
- **E2E Tests**: All critical user flows covered

## Security Considerations

### XSS Prevention

✅ **Mitigated**:
- 交易對符號在後端已驗證
- 前端僅進行格式轉換（replace 操作）
- 不直接使用 `dangerouslySetInnerHTML`

### External Link Security

✅ **Implemented**:
- 使用 `rel="noopener noreferrer"` 防止新分頁存取 window.opener
- 使用 `target="_blank"` 在新分頁開啟
- URL Builder 僅接受已知的交易所名稱（白名單）

### CSRF Protection

✅ **N/A**: 此功能不涉及資料修改或後端 API 呼叫。

## Performance Optimization

### Bundle Size

- **ExchangeLink 元件**: ~2KB (minified + gzipped)
- **URL Builder**: ~1KB (minified + gzipped)
- **Radix UI Tooltip**: ~15KB (tree-shakeable)
- **Total Impact**: < 20KB

### Runtime Performance

- **URL 生成**: O(1) 時間複雜度，< 1ms
- **元件渲染**: React 標準元件，< 5ms
- **Tooltip**: 僅在 hover 時渲染，lazy load

### Optimization Techniques

- 使用 `React.memo` 包裝 ExchangeLink（可選）
- URL Builder 結果可 memoize（如果需要）
- SVG 圖示 inline，無需額外載入

## Accessibility (a11y)

### WCAG 2.1 Compliance

✅ **Level AA Compliance**:
- **1.1.1 Non-text Content**: 圖示有 aria-label
- **1.3.1 Info and Relationships**: 使用語義化 HTML（`<a>` 標籤）
- **2.1.1 Keyboard**: 可通過 Tab 鍵訪問
- **2.4.4 Link Purpose**: aria-label 清楚描述連結目的
- **2.4.7 Focus Visible**: 提供 focus indicator（Tailwind focus:ring）
- **3.2.2 On Input**: 點擊行為可預測（開啟新分頁）

### Screen Reader Support

- 連結有描述性的 aria-label：「前往 {交易所} 查看 {交易對} 永續合約」
- Tooltip 內容與 aria-label 一致
- 禁用狀態有明確的 aria-label：「此交易所不支援此交易對」

### Keyboard Navigation

- Tab 鍵：移動到下一個連結
- Enter 鍵：開啟連結
- Shift+Tab：移動到上一個連結
- 禁用的連結：tabIndex=-1，無法 focus

## Monitoring & Observability

**Current Scope**: 不需要額外監控

**Future Enhancements** (Out of Scope for this feature):
- 點擊追蹤：記錄哪些交易所最常被訪問
- 錯誤追蹤：記錄 URL 生成失敗的頻率
- 效能監控：測量元件渲染時間

## Rollback Plan

### Rollback Complexity

✅ **Low Risk - Easy Rollback**

**Rationale**:
- 純前端功能，無資料庫遷移
- 無後端 API 變更
- 只修改單一元件（RateRow）
- 新增的模組可獨立移除

### Rollback Steps

1. **Revert Git Commit**: `git revert <commit-hash>`
2. **Remove Dependency**: `pnpm remove @radix-ui/react-tooltip`
3. **Verify**: 確認市場監控頁面正常運作
4. **Deploy**: 部署回滾版本

**Estimated Rollback Time**: < 10 minutes

## Deployment Checklist

Before merging to main:

- [ ] All unit tests pass (`pnpm test`)
- [ ] All E2E tests pass (`pnpm test:e2e`)
- [ ] TypeScript compilation succeeds (`pnpm build`)
- [ ] ESLint checks pass (`pnpm lint`)
- [ ] Code reviewed by at least 1 developer
- [ ] Quickstart guide tested by reviewer
- [ ] Constitution compliance verified
- [ ] Accessibility tested with keyboard and screen reader
- [ ] Tested on Chrome, Firefox, Safari
- [ ] Tested on mobile devices (iOS and Android)

## Success Metrics

### Acceptance Criteria (from spec.md)

- ✅ SC-001: 用戶可以在 1 秒內點擊圖示並開啟正確的交易所頁面
- ✅ SC-002: 對於每個支援的交易對，四個交易所的連結準確率達到 100%
- ✅ SC-003: 95% 的用戶能夠在首次使用時，無需額外說明就能理解圖示的功能並成功使用
- ✅ SC-004: 在行動裝置上，圖示的點擊成功率達到 95% 以上
- ✅ SC-005: 當用戶點擊不可用的交易對時，系統能夠正確處理

### Post-Launch Metrics (Optional)

- Click-through rate per exchange
- Mobile vs desktop usage
- Error rate (URL generation failures)

## Known Limitations

1. **Static URL Templates**: 交易所 URL 格式硬編碼，如果交易所變更 URL 結構需要更新程式碼
   - **Mitigation**: URL 模板集中管理在 constants.ts，易於更新

2. **No URL Validation**: 不驗證生成的 URL 是否真的可訪問
   - **Mitigation**: 使用已知且穩定的交易所 URL 模板

3. **Language Hardcoded**: URL 中的語言參數（zh-TC, zh-hant）硬編碼為繁體中文
   - **Future Enhancement**: 根據用戶語言設定動態調整

## Future Enhancements (Out of Scope)

1. **URL 健康檢查**: 定期驗證交易所 URL 是否有效
2. **多語言支援**: 根據用戶偏好語言生成對應的 URL
3. **點擊追蹤**: 記錄用戶點擊行為用於分析
4. **自定義交易所**: 允許用戶新增自定義交易所連結
5. **快捷鍵**: 支援鍵盤快捷鍵（如 Ctrl+Click 在當前分頁開啟）

## References

- **Specification**: [spec.md](./spec.md)
- **Research**: [research.md](./research.md)
- **Data Model**: [data-model.md](./data-model.md)
- **Quickstart**: [quickstart.md](./quickstart.md)
- **Type Contracts**: [contracts/types.ts](./contracts/types.ts)
- **Constitution**: [.specify/memory/constitution.md](../../.specify/memory/constitution.md)
- **Radix UI Tooltip**: https://www.radix-ui.com/primitives/docs/components/tooltip
- **Lucide React**: https://lucide.dev/

## Sign-off

**Plan Status**: ✅ Complete - Ready for `/speckit.tasks`

**Reviewed By**: [To be filled during code review]

**Date**: 2025-11-06

---

**Next Command**: `/speckit.tasks` to generate detailed task breakdown
