# Feature Specification: 市場監控頁面穩定排序

**Feature Branch**: `009-specify-scripts-bash`
**Created**: 2025-11-12
**Status**: Draft
**Input**: User description: "市場監控頁面需要固定排序避免資料跳動"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 預設穩定排序顯示 (Priority: P1)

交易員在市場監控頁面上持續觀察多個交易對的資金費率變化時，希望列表中的交易對位置保持固定，即使資料即時更新也不會跳來跳去，以便追蹤特定交易對的趨勢變化。

**Why this priority**: 這是核心問題的直接解決方案。目前的跳動問題嚴重影響用戶體驗，導致無法有效追蹤特定交易對的變化。解決此問題可立即提升平台可用性，是最小可行方案（MVP）。

**Independent Test**: 可以獨立測試：開啟市場監控頁面，觀察 30 秒內交易對列表是否因資料更新而重新排列。測試成功標準是列表順序保持穩定，只有數值更新。

**Acceptance Scenarios**:

1. **Given** 用戶開啟市場監控頁面並顯示 30 個交易對，**When** WebSocket 推送資金費率更新，**Then** 交易對在列表中的位置不改變，只有費率數值和狀態標籤更新
2. **Given** 列表按交易對名稱（字母順序）預設排序，**When** 某個交易對的費率差異從 0.3% 變為 0.8%，**Then** 該交易對仍保持在原本的字母順序位置，不會跳到列表頂部
3. **Given** 用戶正在查看列表中間的某個交易對，**When** 連續收到多次 WebSocket 更新，**Then** 用戶視線範圍內的交易對位置保持不變，無需重新定位
4. **Given** 頁面初始載入完成後顯示 30 個交易對，**When** 5 分鐘內持續接收資料更新，**Then** 列表始終保持 30 個交易對，順序不變
5. **Given** 用戶選擇不同的交易對群組（如從 top10 切換到 top30），**When** 群組切換完成，**Then** 新群組的交易對按預設順序顯示並保持穩定

---

### User Story 2 - 用戶自訂排序並保持穩定 (Priority: P2)

交易員希望能夠根據自己的需求（如費率差異、年化收益等）對交易對列表進行排序，排序後列表順序應保持穩定，不會因為即時資料更新而重新排列。

**Why this priority**: 在 P1 穩定顯示的基礎上，增加用戶自訂排序功能可提供更大的靈活性。這是重要的增強功能，但不是解決核心問題的必要條件，因此優先級較低。

**Independent Test**: 可以獨立測試：用戶點擊「費率差異」欄位標題進行排序，然後觀察 30 秒內列表是否保持該排序順序。測試成功標準是排序後的順序穩定，即使資料更新也不重新排列。

**Acceptance Scenarios**:

1. **Given** 用戶在市場監控頁面，**When** 點擊「費率差異」欄位標題，**Then** 列表按費率差異降序排列，且在後續資料更新時保持此排序順序
2. **Given** 列表已按費率差異排序，**When** 某個交易對的費率差異數值更新（如從 0.5% 變為 0.3%），**Then** 該交易對在列表中的位置不變，只有數值更新
3. **Given** 用戶點擊同一欄位標題兩次，**When** 排序方向從降序切換為升序，**Then** 列表重新排列為升序，且在後續更新時保持此升序
4. **Given** 用戶在不同排序欄位間切換（如從「費率差異」切換到「年化收益」），**When** 排序切換完成，**Then** 列表按新的排序標準穩定顯示
5. **Given** 列表按交易對名稱字母順序排序，**When** 用戶滾動到列表底部並接收資料更新，**Then** 當前視窗中的交易對位置不變，不會因為資料更新而跳回頂部

---

### User Story 3 - 排序偏好記憶 (Priority: P3)

交易員希望系統能記住其上次選擇的排序方式，下次開啟頁面時自動套用相同的排序設定，無需重新設定。

**Why this priority**: 這是便利性功能，可提升用戶體驗但不影響核心功能。用戶可以在每次訪問時手動設定排序，因此不是必須功能。

**Independent Test**: 可以獨立測試：用戶設定排序為「費率差異降序」，關閉頁面後重新開啟，驗證排序設定是否自動恢復。測試成功標準是排序偏好在瀏覽器會話之間保持。

**Acceptance Scenarios**:

1. **Given** 用戶將列表排序設定為「費率差異降序」，**When** 關閉並重新開啟市場監控頁面，**Then** 列表自動套用「費率差異降序」排序
2. **Given** 用戶選擇「交易對名稱升序」排序，**When** 切換到其他頁面（如套利機會頁）後返回市場監控，**Then** 排序設定仍為「交易對名稱升序」
3. **Given** 用戶在設定排序後重新整理頁面，**When** 頁面重新載入完成，**Then** 先前的排序設定自動套用
4. **Given** 用戶從未設定過排序偏好，**When** 首次開啟市場監控頁面，**Then** 套用系統預設排序（交易對名稱字母順序）

---

### Edge Cases

- **資料初始載入時**：當頁面首次載入且尚未收到完整資料時，如何處理排序？系統應顯示載入指示器，待資料完整後再套用排序。
- **交易對數量變化**：當用戶切換交易對群組（如從 10 個切換到 30 個）時，如何處理排序？系統應套用相同的排序規則到新的交易對列表。
- **排序欄位數值相同**：當多個交易對的排序欄位值相同時（如兩個交易對費率差異都是 0.5%），如何決定順序？系統應使用次要排序標準（交易對名稱字母順序）。
- **WebSocket 連線中斷**：當 WebSocket 斷線重連後，列表順序是否會改變？系統應保持當前排序設定，重連後繼續套用相同排序。
- **多個視窗同時開啟**：當用戶在不同瀏覽器視窗開啟市場監控頁面並設定不同排序時，排序偏好如何處理？每個視窗獨立管理排序狀態，最後關閉的視窗的設定會被儲存。
- **極端資料更新頻率**：當 WebSocket 推送非常頻繁（如每秒多次）時，是否會影響排序穩定性？系統應確保任何更新頻率下排序都保持穩定。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須在頁面初始載入時，按預設排序標準（交易對名稱字母順序）顯示交易對列表
- **FR-002**: 系統必須在接收 WebSocket 資料更新時，保持當前排序順序不變，僅更新交易對的數值資料（費率、價格、狀態等）
- **FR-003**: 系統必須提供排序功能，允許用戶點擊欄位標題（交易對名稱、費率差異、年化收益）來改變排序標準
- **FR-004**: 系統必須在用戶改變排序標準時，重新排列列表一次，然後在後續資料更新時保持新的排序順序
- **FR-005**: 系統必須支援排序方向切換（升序/降序），當用戶點擊同一欄位標題兩次時切換方向
- **FR-006**: 系統必須在排序欄位值相同時，使用交易對名稱字母順序作為次要排序標準
- **FR-007**: 系統必須確保列表中顯示的交易對數量固定（根據選擇的群組），不會因資料更新而增減
- **FR-008**: 系統必須將用戶選擇的排序設定（排序欄位和方向）儲存到瀏覽器本地儲存
- **FR-009**: 系統必須在頁面重新載入時，從本地儲存讀取並套用上次的排序設定
- **FR-010**: 系統必須在用戶切換交易對群組時，保持當前的排序設定並套用到新的交易對列表
- **FR-011**: 系統必須在 WebSocket 連線中斷重連後，保持當前的排序設定不變
- **FR-012**: 系統必須在列表排序期間保持視覺穩定性，避免閃爍或抖動

### Key Entities

本功能主要涉及前端顯示邏輯，不引入新的資料實體，但會影響以下現有實體的呈現：

- **交易對費率記錄 (Market Rate)**: 包含交易對名稱、各交易所費率、費率差異、年化收益、狀態等屬性，是排序和顯示的基礎資料
- **排序設定 (Sort Preference)**: 用戶選擇的排序欄位（交易對名稱、費率差異、年化收益等）和排序方向（升序/降序），儲存在瀏覽器本地儲存

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用戶在持續觀察列表期間（至少 2 分鐘），列表中交易對的位置不會因資料更新而改變，實現 100% 的位置穩定性
- **SC-002**: 用戶點擊排序欄位標題後，列表在 500 毫秒內完成重新排列並顯示
- **SC-003**: 在設定排序後的 5 分鐘內接收多次 WebSocket 更新（每分鐘至少 6 次），列表順序保持完全一致，穩定性達到 100%
- **SC-004**: 用戶關閉並重新開啟頁面後，排序設定恢復準確率達到 100%（在支援本地儲存的瀏覽器中）
- **SC-005**: 在切換交易對群組時（如從 10 個切換到 30 個），列表在 1 秒內完成重新載入並套用排序設定
- **SC-006**: 95% 的用戶能夠在首次使用時，無需額外指導就能理解並成功使用排序功能

## Dependencies & Assumptions *(mandatory if applicable)*

### Dependencies

- 現有的市場監控頁面和 WebSocket 即時更新機制已正常運作
- 前端已實作交易對列表顯示和基本的表格功能
- 瀏覽器支援 localStorage API（用於儲存排序偏好）

### Assumptions

- 用戶主要使用現代瀏覽器（Chrome、Firefox、Safari、Edge）訪問市場監控頁面，這些瀏覽器都支援 localStorage
- WebSocket 資料更新頻率為每分鐘 1-10 次，不會過於頻繁導致效能問題
- 交易對列表的最大數量不超過 50 個（基於 top30 群組最多 30 個的現況）
- 用戶期望的預設排序為交易對名稱字母順序，這是最直觀的排序方式
- 排序功能不需要支援多欄位組合排序（如先按費率差異排序，再按年化收益排序），單一欄位排序已足夠

## Out of Scope *(mandatory)*

- 自訂排序欄位（如允許用戶新增自訂計算欄位並進行排序）
- 進階篩選功能（如根據費率範圍、交易所可用性等條件篩選交易對）
- 列表的拖曳排序（手動調整交易對順序）
- 排序動畫效果（如平滑過渡動畫）
- 多欄位組合排序（同時按多個欄位排序）
- 排序設定的雲端同步（跨裝置同步排序偏好）
- 排序歷史記錄（記錄用戶過去使用過的排序設定）
- 匯出排序後的列表資料
