# Feature Specification: 套利機會自動偵測系統

**Feature Branch**: `005-arbitrage-opportunity-detection`
**Created**: 2025-10-21
**Status**: Draft
**Input**: User description: "實作套利機會自動偵測功能。系統需要：

1. 根據可配置的閾值（預設 0.05%）自動判斷資金費率差異是否達到套利條件
2. 當偵測到套利機會時，即時通知使用者（支援多種通知方式）
3. 追蹤機會的生命週期（出現、持續、消失）
4. 支援多幣別同時偵測，並按潛在收益排序
5. 計算預期年化收益率（考慮資金費率結算頻率）
6. 提供機會歷史記錄查詢

技術要求：
- 整合到現有的 FundingRateMonitor 服務
- 使用事件驅動架構發送通知
- 支援閾值動態調整
- 提供 CLI 指令查看當前機會和歷史記錄
- 資料持久化到 PostgreSQL（機會記錄表）"

## User Scenarios & Testing *(mandatory)*

<!--
  IMPORTANT: User stories should be PRIORITIZED as user journeys ordered by importance.
  Each user story/journey must be INDEPENDENTLY TESTABLE - meaning if you implement just ONE of them,
  you should still have a viable MVP (Minimum Viable Product) that delivers value.
  
  Assign priorities (P1, P2, P3, etc.) to each story, where P1 is the most critical.
  Think of each story as a standalone slice of functionality that can be:
  - Developed independently
  - Tested independently
  - Deployed independently
  - Demonstrated to users independently
-->

### User Story 1 - 自動偵測套利機會並即時通知 (Priority: P1)

使用者希望系統能自動監控資金費率差異，當差異達到設定的閾值時立即收到通知，無需手動持續監看。系統會持續追蹤 BTC、ETH、SOL 等多個幣別，並在發現套利機會時主動提醒。

**Why this priority**: 這是套利機會偵測的核心功能，讓使用者能及時掌握獲利機會。自動化偵測可節省使用者時間，避免錯過短暫的套利窗口。這是整個偵測系統的基礎，沒有這個功能，使用者必須手動監控，失去自動化套利的價值。

**Independent Test**: 可以透過設定閾值（例如 0.05%）並模擬不同的資金費率數據，驗證系統是否能正確識別達到閾值的機會並發出通知。無需實際執行交易即可測試完整流程。

**Acceptance Scenarios**:

1. **Given** 系統設定套利閾值為 0.05%，**When** BTC 在幣安和 OKX 的資金費率差異達到 0.06%，**Then** 系統立即偵測為套利機會並發送通知給使用者
2. **Given** 系統正在監控 ETH，資金費率差異為 0.03%，**When** 差異未達到 0.05% 閾值，**Then** 系統持續監控但不發出通知
3. **Given** 系統已偵測到 SOL 的套利機會並通知使用者，**When** 費率差異回落至 0.04%（低於閾值），**Then** 系統自動移除該機會標記並通知使用者機會已消失
4. **Given** 系統正在運行，**When** 使用者透過 CLI 指令動態調整閾值從 0.05% 改為 0.08%，**Then** 系統立即套用新閾值，並重新評估所有監控中的幣別

---

### User Story 2 - 多幣別機會排序與優先級 (Priority: P1)

當系統同時偵測到多個幣別的套利機會時，使用者希望能看到按照潛在收益排序的清單，以便優先處理獲利最高的機會。系統需要計算每個機會的預期年化收益率，並提供清晰的比較。

**Why this priority**: 在市場波動時，可能同時出現多個套利機會，但使用者的資金有限，需要優先選擇收益最高的機會。排序功能讓使用者能快速做出最佳決策，這與自動偵測同等重要。

**Independent Test**: 可以透過模擬同時存在 3 個不同幣別的套利機會（不同的費率差異和預期收益），驗證系統是否能正確計算年化收益率並按照收益由高到低排序顯示。

**Acceptance Scenarios**:

1. **Given** 系統同時偵測到 BTC（費率差 0.06%）、ETH（費率差 0.08%）、SOL（費率差 0.07%）的套利機會，**When** 使用者查詢當前機會列表，**Then** 系統顯示按照費率差異排序的列表（ETH > SOL > BTC）
2. **Given** 系統偵測到多個機會，**When** 使用者查看機會詳情，**Then** 每個機會都顯示預期年化收益率（考慮資金費率每 8 小時結算一次，年化 = 費率差 × 3 × 365）
3. **Given** 系統有 5 個活躍的套利機會，**When** 其中 2 個機會的費率差異發生變化，**Then** 系統即時重新計算並更新排序
4. **Given** 某個機會的費率差異降至閾值以下，**When** 該機會從列表中移除，**Then** 系統自動調整剩餘機會的排序

---

### User Story 3 - 機會生命週期追蹤與歷史記錄 (Priority: P2)

使用者希望能追蹤每個套利機會的完整生命週期（從出現到消失），並查詢歷史記錄以分析過往機會的模式和特性。這有助於優化閾值設定和交易策略。

**Why this priority**: 歷史數據分析可以幫助使用者了解市場規律，但這不是即時決策的必要功能，因此優先級稍低。然而，對於長期優化策略仍然很有價值。

**Independent Test**: 可以透過建立模擬的機會記錄（包含出現時間、持續時長、最大費率差異、消失時間），驗證系統是否能正確儲存並查詢這些歷史數據。

**Acceptance Scenarios**:

1. **Given** 系統偵測到一個新的 BTC 套利機會，**When** 機會出現，**Then** 系統記錄機會的開始時間、初始費率差異、兩個交易所的費率數值
2. **Given** 一個套利機會持續存在 15 分鐘，**When** 期間費率差異波動（0.06% → 0.09% → 0.05%），**Then** 系統記錄最大費率差異值和發生時間
3. **Given** 一個套利機會已消失，**When** 使用者查詢該機會的歷史記錄，**Then** 系統顯示完整的生命週期資訊（開始時間、持續時長、最大費率差、消失時間、總計通知次數）
4. **Given** 系統已累積 100 筆歷史機會記錄，**When** 使用者透過 CLI 查詢最近 24 小時的機會，**Then** 系統返回符合時間範圍的所有記錄，並顯示統計摘要（總機會數、平均持續時長、最大費率差）

---

### User Story 4 - 多通道通知機制 (Priority: P3)

使用者希望能選擇接收通知的方式（終端機輸出、桌面通知、日誌檔案），並能配置通知的詳細程度，避免資訊過載。

**Why this priority**: 通知方式的多樣性可以提升使用者體驗，但基本的終端輸出已能滿足核心需求。這是錦上添花的功能，優先級最低。

**Independent Test**: 可以透過配置不同的通知設定（例如只開啟終端輸出，或同時開啟桌面通知和日誌），驗證系統是否能根據配置正確發送通知。

**Acceptance Scenarios**:

1. **Given** 使用者設定通知方式為「終端輸出 + 日誌檔案」，**When** 系統偵測到套利機會，**Then** 通知同時出現在終端機和日誌檔案中
2. **Given** 使用者設定通知詳細程度為「簡潔」，**When** 收到通知，**Then** 只顯示幣別、費率差異、年化收益率等關鍵資訊
3. **Given** 使用者設定通知詳細程度為「詳細」，**When** 收到通知，**Then** 額外顯示兩個交易所的具體費率、下次結算時間、歷史平均費率差等進階資訊
4. **Given** 系統在短時間內偵測到同一幣別的多次機會變化，**When** 使用者開啟「合併通知」選項，**Then** 系統將 1 分鐘內的多次變化合併為單一通知，避免通知轟炸

---

### Edge Cases

- 當費率差異在閾值附近快速波動（例如在 0.04% 和 0.06% 之間頻繁切換）時，系統如何避免發送過多的「機會出現」和「機會消失」通知？
- 當某個交易所 API 暫時無法連線導致無法取得最新費率時，系統應該如何處理現有的機會記錄？是標記為「資料過期」還是保持原狀？
- 當系統正在計算年化收益率時，如果資金費率結算頻率發生變化（例如從每 8 小時改為每 4 小時），系統如何更新計算邏輯？
- 當資料庫寫入失敗導致機會記錄無法儲存時，系統是否仍然發送通知給使用者？如何確保資料一致性？
- 當使用者快速調整閾值多次（例如 5 秒內調整 3 次），系統如何確保只使用最新的閾值，並避免重複計算？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須支援可配置的套利閾值，預設值為 0.05%，使用者可透過 CLI 指令或配置檔案動態調整
- **FR-002**: 系統必須在資金費率差異達到或超過閾值時，立即識別為套利機會並觸發通知
- **FR-003**: 系統必須追蹤每個套利機會的生命週期，包含出現時間、持續期間、最大費率差異、消失時間
- **FR-004**: 系統必須計算每個套利機會的預期年化收益率，基於資金費率差異和結算頻率（預設每 8 小時結算）
- **FR-005**: 系統必須支援多幣別同時偵測，並將所有活躍機會按照費率差異由高到低排序
- **FR-006**: 系統必須在機會消失（費率差異回落至閾值以下）時，自動移除機會標記並通知使用者
- **FR-007**: 系統必須將所有套利機會記錄持久化到資料庫，包含完整的生命週期資訊
- **FR-008**: 系統必須提供 CLI 指令查詢當前活躍的套利機會列表，顯示排序後的結果
- **FR-009**: 系統必須提供 CLI 指令查詢歷史套利機會記錄，支援時間範圍篩選（例如最近 24 小時、最近 7 天）
- **FR-010**: 系統必須在偵測到機會時發送通知，預設通知方式為終端輸出，支援擴展其他通知管道
- **FR-011**: 系統必須避免在閾值附近頻繁波動時產生過多通知，實作防抖動機制（debounce），預設為 30 秒內相同幣別只通知一次
- **FR-012**: 系統必須在無法取得某個交易所最新資料時，標記該幣別的機會狀態為「資料過期」，並在恢復後自動更新
- **FR-013**: 系統必須記錄每個機會的通知次數，用於歷史分析和系統優化

### Key Entities

- **ArbitrageOpportunity（套利機會）**: 代表一個被偵測到的套利機會，包含幣別、兩個交易所的費率、費率差異、開始時間、最大費率差、狀態（活躍/已消失）、通知次數
- **OpportunityHistory（機會歷史）**: 記錄已消失的套利機會完整生命週期，包含持續時長、最大費率差異、總通知次數、消失原因（費率回落/資料異常）
- **NotificationLog（通知日誌）**: 記錄每次發送的通知，包含時間戳、幣別、通知內容、通知方式，用於追蹤和除錯

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 系統能在資金費率差異達到閾值後 5 秒內偵測到機會並發送通知
- **SC-002**: 系統能同時監控至少 10 個幣別的套利機會，並即時更新排序
- **SC-003**: 使用者能透過 CLI 指令在 2 秒內查詢到最近 24 小時的所有歷史機會記錄
- **SC-004**: 系統的機會偵測準確率達到 99%（即達到閾值的費率差異都能被正確識別）
- **SC-005**: 防抖動機制能有效減少通知數量，在費率頻繁波動時，通知數量減少至少 80%
- **SC-006**: 系統能在單個交易所 API 失敗時，仍然標記資料過期並在 API 恢復後 10 秒內更新狀態
- **SC-007**: 使用者能在 30 秒內透過 CLI 動態調整閾值，並看到系統即時重新評估所有機會
- **SC-008**: 歷史記錄查詢能支援至少 30 天的資料範圍，查詢回應時間在 3 秒內

## Assumptions

- 資金費率結算頻率固定為每 8 小時一次（符合永續合約市場標準）
- 年化收益率計算公式：費率差異 × 3（每天 3 次結算）× 365（天）
- 防抖動機制的預設時間窗口為 30 秒，可透過配置調整
- 通知的預設方式為終端輸出，其他方式（桌面通知、Webhook）視為選用功能
- 歷史記錄預設保留 90 天，可透過配置調整
- 單個幣別的機會狀態變化（出現/消失）視為獨立事件，不與其他幣別互相影響

## Dependencies

- 依賴現有的 FundingRateMonitor 服務提供即時的資金費率資料
- 依賴 PostgreSQL 資料庫儲存機會記錄和歷史資料
- 依賴現有的 Logger 模組記錄系統日誌
- 依賴現有的 CLI 框架（Commander.js）新增指令

