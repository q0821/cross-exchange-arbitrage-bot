# Feature Specification: 持倉詳情查看功能

**Feature Branch**: `045-position-details-view`
**Created**: 2025-12-28
**Status**: Draft
**Input**: User description: "我想要在現有的持倉管理中，能夠查看目前持倉的詳細情況：1. 開倉價格 2. 已經產生的資金費率明細 3. 未實現損益 4. 如果可以的話有包含手續費最好了 5. 現在價格。請問這樣是有辦法計算預估年化的嗎？Api 的部分，請使用展開詳情的時候再去取得資訊就好。不要去新增資料庫欄位"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看持倉詳情 (Priority: P1)

用戶在持倉管理頁面，想要查看某個持倉的詳細情況，包括開倉價格、現在價格、未實現損益等資訊，以便評估是否要平倉。

**Why this priority**: 這是核心功能，用戶必須能夠查看持倉詳情才能做出交易決策。所有其他功能都依賴於此基礎。

**Independent Test**: 可以透過在持倉卡片上點擊「查看詳情」按鈕，確認能展開顯示開倉價格、現在價格、未實現損益等資訊。

**Acceptance Scenarios**:

1. **Given** 用戶有一個狀態為「持倉中」的持倉, **When** 用戶點擊該持倉卡片的「查看詳情」按鈕, **Then** 系統展開顯示多頭和空頭的開倉價格、現在價格、持倉數量
2. **Given** 詳情面板已展開, **When** 系統成功取得即時價格, **Then** 顯示未實現損益（含價差損益）
3. **Given** 詳情面板已展開, **When** 用戶再次點擊「收起詳情」, **Then** 詳情面板收起

---

### User Story 2 - 查看資金費率明細 (Priority: P2)

用戶想要查看持倉期間已經產生的資金費率結算明細，以便驗證資金費率收支是否正確。

**Why this priority**: 資金費率是套利收益的主要來源，用戶需要能夠驗證每筆結算是否正確。

**Independent Test**: 可以透過展開持倉詳情，確認顯示多頭和空頭各自的資金費率結算記錄列表。

**Acceptance Scenarios**:

1. **Given** 用戶展開持倉詳情, **When** 系統查詢資金費率歷史, **Then** 顯示多頭交易所的資金費率結算記錄（時間、金額）
2. **Given** 用戶展開持倉詳情, **When** 系統查詢資金費率歷史, **Then** 顯示空頭交易所的資金費率結算記錄（時間、金額）
3. **Given** 資金費率明細已顯示, **When** 用戶查看, **Then** 能看到多頭總計、空頭總計、以及整體總計

---

### User Story 3 - 查看預估年化報酬率 (Priority: P3)

用戶想要知道目前持倉的預估年化報酬率，以便評估套利策略的效益。

**Why this priority**: 年化報酬率是重要的績效指標，但需要先有損益資料才能計算，因此優先級較低。

**Independent Test**: 可以透過展開持倉詳情，確認顯示預估年化報酬率百分比。

**Acceptance Scenarios**:

1. **Given** 用戶展開持倉詳情且有任何損益資料, **When** 系統計算年化報酬率, **Then** 顯示預估年化報酬率（百分比）
2. **Given** 持倉時間極短（少於 1 分鐘）且無任何損益, **When** 用戶展開持倉詳情, **Then** 顯示「資料不足，無法計算年化」提示
3. **Given** 年化報酬率已計算, **When** 用戶查看, **Then** 能看到計算依據（總損益、持倉時間、保證金）

---

### User Story 4 - 查看手續費資訊 (Priority: P4)

用戶想要查看開倉時產生的手續費，以便更準確評估總成本。

**Why this priority**: 手續費是成本的一部分，但已在開倉時記錄，屬於補充資訊。

**Independent Test**: 可以透過展開持倉詳情，確認顯示開倉手續費資訊。

**Acceptance Scenarios**:

1. **Given** 用戶展開持倉詳情, **When** 系統顯示手續費, **Then** 顯示多頭開倉手續費和空頭開倉手續費
2. **Given** 手續費資訊已顯示, **When** 用戶查看, **Then** 能看到手續費總計

---

### Edge Cases

- 當交易所 API 無法取得即時價格時，顯示「無法取得即時價格」並使用快取價格或顯示 N/A
- 當資金費率查詢失敗時，顯示錯誤訊息但不影響其他資訊的顯示
- 當持倉時間極短（< 1 分鐘）且無損益資料時，年化報酬率無法計算，應顯示提示
- 當持倉已平倉（狀態為 CLOSED），不應顯示「查看詳情」功能（已有 Trade 頁面）
- 當網路中斷時，顯示載入失敗並提供重試按鈕

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統 MUST 在持倉卡片上提供「查看詳情」展開/收起按鈕
- **FR-002**: 系統 MUST 在展開詳情時即時從交易所 API 取得當前價格
- **FR-003**: 系統 MUST 顯示多頭和空頭各自的開倉價格（從資料庫取得）
- **FR-004**: 系統 MUST 顯示多頭和空頭各自的當前價格（從交易所即時取得）
- **FR-005**: 系統 MUST 計算並顯示未實現損益（價差損益）
- **FR-006**: 系統 MUST 查詢並顯示資金費率結算明細（開倉時間至現在）
- **FR-007**: 系統 MUST 顯示資金費率的多頭總計、空頭總計、整體總計
- **FR-008**: 系統 MUST 計算並顯示預估年化報酬率（當有損益資料時）
- **FR-009**: 系統 SHOULD 顯示開倉時的手續費資訊
- **FR-010**: 系統 MUST 在 API 查詢期間顯示載入狀態
- **FR-011**: 系統 MUST 在 API 查詢失敗時顯示錯誤訊息並提供重試選項
- **FR-012**: 系統 MUST NOT 新增任何資料庫欄位（僅使用現有資料 + 即時查詢）

### Key Entities

- **Position**: 持倉記錄，包含開倉價格、持倉數量、開倉時間等（已存在）
- **PositionDetails**: 即時查詢的詳情資料，包含當前價格、資金費率明細、未實現損益（不持久化）
- **FundingFeeEntry**: 單筆資金費率結算記錄，包含時間和金額（從交易所查詢）

### API 設計說明

由於用戶要求「展開詳情的時候再去取得資訊」且「不要去新增資料庫欄位」，API 設計如下：

- 新增 `GET /api/positions/[id]/details` 端點
- 此端點在被呼叫時即時查詢：
  1. 從資料庫取得 Position 基本資訊（開倉價格、持倉數量等）
  2. 從交易所 API 取得當前價格
  3. 從交易所 API 取得資金費率歷史（開倉時間至現在）
  4. 計算未實現損益和預估年化報酬率
- 不儲存查詢結果，每次展開都重新查詢以確保資料最新

### 年化報酬率計算公式

```
年化報酬率 = (總損益 / 保證金) × (365 × 24 / 持倉小時數) × 100%

其中：
- 總損益 = 未實現價差損益 + 資金費率損益
- 保證金 = (多頭持倉價值 + 空頭持倉價值) / 槓桿倍數
- 持倉小時數 = (現在時間 - 開倉時間) / 3600000
```

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用戶能在 3 秒內看到持倉詳情資訊（含 API 查詢時間）
- **SC-002**: 資金費率明細與交易所後台記錄一致，準確率 100%
- **SC-003**: 未實現損益計算誤差不超過 0.01%
- **SC-004**: 年化報酬率顯示格式清晰，用戶無需額外說明即可理解
- **SC-005**: API 查詢失敗時，用戶能明確知道失敗原因並可重試

## Assumptions

- 用戶已有有效的交易所 API Key 並且有權限查詢資金費率歷史
- 交易所 API 在正常情況下回應時間不超過 2 秒
- 開倉手續費資訊可從現有 Position 記錄或相關 Trade 記錄中取得
- 持倉狀態為「持倉中」(OPEN) 的記錄才顯示「查看詳情」功能
