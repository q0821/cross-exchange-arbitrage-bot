# Feature Specification: 用戶密碼管理

**Feature Branch**: `061-password-management`
**Created**: 2026-01-09
**Status**: Completed
**Input**: User description: "用戶變更密碼、忘記密碼的功能"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 已登入用戶變更密碼 (Priority: P1)

已登入的用戶希望能夠主動更改自己的帳戶密碼，以維護帳戶安全。用戶需要在設定頁面中找到密碼變更功能，輸入目前的密碼和新密碼後完成變更。

**Why this priority**: 這是主動式的安全維護功能，是用戶管理帳戶安全的基本需求。比忘記密碼更常用，因為用戶可能定期更換密碼或發現密碼可能洩漏時需要立即更改。

**Independent Test**: 可通過登入帳戶 → 進入設定頁面 → 變更密碼 → 登出 → 使用新密碼登入來驗證功能完整性。

**Acceptance Scenarios**:

1. **Given** 用戶已登入系統, **When** 用戶在設定頁面輸入正確的目前密碼和符合規則的新密碼, **Then** 系統成功更新密碼並顯示成功訊息
2. **Given** 用戶已登入系統, **When** 用戶輸入錯誤的目前密碼, **Then** 系統拒絕變更並顯示「目前密碼不正確」的錯誤訊息
3. **Given** 用戶已登入系統, **When** 用戶輸入的新密碼不符合密碼強度要求, **Then** 系統拒絕變更並顯示具體的密碼規則提示
4. **Given** 用戶已登入系統, **When** 用戶輸入的新密碼與確認密碼不一致, **Then** 系統拒絕變更並顯示「密碼不一致」的錯誤訊息

---

### User Story 2 - 忘記密碼重設流程 (Priority: P2)

用戶忘記密碼無法登入時，希望能夠通過註冊時使用的電子郵件來重設密碼，以恢復帳戶存取權限。

**Why this priority**: 這是被動式的帳戶恢復功能，對無法登入的用戶至關重要。雖然使用頻率較低，但在用戶真正需要時是不可或缺的功能。

**Independent Test**: 可通過登入頁面 → 點擊忘記密碼 → 輸入電子郵件 → 收到重設郵件 → 點擊連結 → 設定新密碼 → 使用新密碼登入來驗證完整流程。

**Acceptance Scenarios**:

1. **Given** 用戶在登入頁面, **When** 用戶點擊「忘記密碼」並輸入已註冊的電子郵件, **Then** 系統發送包含重設連結的郵件並顯示「已發送重設郵件」的提示
2. **Given** 用戶收到重設郵件, **When** 用戶在連結有效期內點擊連結並設定符合規則的新密碼, **Then** 系統成功重設密碼並引導用戶登入
3. **Given** 用戶在登入頁面, **When** 用戶輸入未註冊的電子郵件請求重設密碼, **Then** 系統顯示相同的「已發送重設郵件」提示（防止帳戶探測）
4. **Given** 用戶收到重設郵件, **When** 用戶在連結過期後點擊連結, **Then** 系統顯示「連結已過期，請重新申請」的訊息

---

### User Story 3 - 密碼強度即時回饋 (Priority: P3)

用戶在設定新密碼時，希望能夠即時看到密碼強度指示，了解自己設定的密碼是否足夠安全。

**Why this priority**: 這是使用者體驗優化功能，幫助用戶設定更安全的密碼，但不影響核心功能運作。

**Independent Test**: 可通過在密碼輸入欄位輸入不同複雜度的密碼，觀察強度指示器的變化來驗證。

**Acceptance Scenarios**:

1. **Given** 用戶正在設定新密碼, **When** 用戶輸入僅包含數字的密碼, **Then** 系統顯示「弱」的強度指示
2. **Given** 用戶正在設定新密碼, **When** 用戶輸入包含大小寫字母和數字的密碼, **Then** 系統顯示「中」的強度指示
3. **Given** 用戶正在設定新密碼, **When** 用戶輸入包含大小寫字母、數字和特殊符號且長度超過 12 位的密碼, **Then** 系統顯示「強」的強度指示

---

### Edge Cases

- 用戶在密碼重設連結有效期內多次點擊連結會如何處理？（第一次使用後連結失效）
- 用戶短時間內多次請求重設密碼會如何處理？（限制發送頻率，例如每 60 秒一次）
- 用戶設定的新密碼與舊密碼相同會如何處理？（允許，不強制禁止）
- 用戶在變更密碼過程中 session 過期會如何處理？（重新導向登入頁面）
- 重設密碼連結被其他人截獲並使用會如何處理？（連結為一次性使用，使用後立即失效）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統 MUST 提供已登入用戶變更密碼的功能入口（在設定頁面）
- **FR-002**: 系統 MUST 在變更密碼時驗證用戶輸入的目前密碼是否正確
- **FR-003**: 系統 MUST 驗證新密碼符合密碼強度要求（至少 8 個字元，包含大小寫字母和數字）
- **FR-004**: 系統 MUST 在登入頁面提供「忘記密碼」的連結
- **FR-005**: 系統 MUST 發送包含唯一重設連結的電子郵件給請求重設密碼的用戶
- **FR-006**: 系統 MUST 設定重設連結的有效期限（1 小時）
- **FR-007**: 系統 MUST 確保重設連結為一次性使用（使用後立即失效）
- **FR-008**: 系統 MUST 在密碼變更或重設成功後，使該用戶的其他登入 session 失效
- **FR-009**: 系統 MUST 對重設密碼請求進行頻率限制（每個電子郵件地址每 60 秒最多 1 次）
- **FR-010**: 系統 MUST 在密碼輸入時提供即時的密碼強度指示
- **FR-011**: 系統 MUST NOT 在忘記密碼流程中洩漏帳戶是否存在的資訊
- **FR-012**: 系統 MUST 在連續 5 次密碼輸入錯誤後鎖定帳戶 15 分鐘（暴力破解保護）
- **FR-013**: 系統 MUST 在郵件發送失敗時顯示「郵件發送失敗，請稍後再試」錯誤訊息
- **FR-014**: 系統 MUST 記錄所有密碼相關操作的審計日誌（時間、用戶、操作類型、IP 地址）
- **FR-015**: 系統 MUST 在帳戶因連續失敗嘗試被鎖定時發送郵件通知用戶（包含鎖定原因及解鎖時間）

### Key Entities

- **PasswordResetToken**: 代表一個密碼重設請求，包含唯一識別碼、關聯用戶、建立時間、過期時間、是否已使用
- **User**: 現有用戶實體，新增密碼相關欄位（密碼雜湊、上次變更時間、失敗嘗試次數、鎖定截止時間）
- **PasswordAuditLog**: 密碼操作審計日誌，包含時間戳、用戶識別碼、操作類型（變更/重設/失敗嘗試）、IP 地址、結果狀態

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用戶可在 2 分鐘內完成密碼變更流程（從進入設定頁面到完成變更）
- **SC-002**: 用戶可在 5 分鐘內完成忘記密碼重設流程（從點擊忘記密碼到成功登入）
- **SC-003**: 密碼重設郵件在請求後 30 秒內送達用戶信箱
- **SC-004**: 95% 的用戶在首次嘗試即可成功完成密碼變更或重設
- **SC-005**: 系統正確阻擋所有不符合密碼強度規則的密碼設定嘗試

## Assumptions

- 系統已有用戶認證機制和用戶資料庫
- 系統已有電子郵件發送功能可供使用
- 用戶註冊時已提供有效的電子郵件地址
- 密碼以安全的雜湊方式儲存，不以明文形式存在

## Clarifications

### Session 2026-01-09

- Q: 當用戶連續輸入錯誤密碼時，系統應如何保護帳戶免受暴力破解攻擊？ → A: 連續 5 次失敗後鎖定帳戶 15 分鐘
- Q: 當密碼重設郵件因郵件服務暫時不可用而發送失敗時，系統應如何處理？ → A: 顯示「郵件發送失敗，請稍後再試」錯誤訊息
- Q: 系統是否應該禁止用戶重複使用最近用過的密碼？ → A: 允許重複使用舊密碼（不檢查密碼歷史）
- Q: 密碼相關操作是否需要記錄審計日誌？ → A: 記錄所有密碼操作（時間、用戶、操作類型、IP）
- Q: 當帳戶因連續失敗嘗試而被鎖定時，是否應該發送通知郵件給用戶？ → A: 發送郵件通知用戶帳戶已被鎖定及解鎖時間
