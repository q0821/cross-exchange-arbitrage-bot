# Feature Specification: 標準化資金費率時間與淨收益計算

**Feature Branch**: `012-specify-scripts-bash`
**Created**: 2025-01-15
**Status**: Draft
**Input**: User description: "現在資金費率的計算時間看起來會浮動，有的交易隊在不同交易所的結算時間不一致，有時候是1小時一次，有時候是4小時一次，有時候是8小時一次，我想要把它計算成固定的時間，這樣的資金費率的差比較一致，顯示在市場監控，並且重新確認套利的可能性，淨收益的欄位的計算方式我覺得有點怪，可能要重新思考如何比較正確。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 標準化資金費率時間顯示 (Priority: P1)

交易者在市場監控頁面查看不同交易所的資金費率時，需要能夠以統一的時間基準來比較費率差異，而不受各交易所不同結算週期（1小時、4小時、8小時）的影響。系統應自動將所有資金費率標準化為相同的時間基準（例如每小時或每8小時），讓交易者能夠直接比較不同交易所的費率，而無需手動換算。

**Why this priority**: 這是核心功能，直接影響交易者判斷套利機會的準確性。沒有標準化的時間基準，交易者無法正確比較不同交易所的資金費率，可能導致錯誤的套利決策。

**Independent Test**: 可以通過在市場監控頁面選擇兩個具有不同結算週期的交易所（例如 Binance 8小時 vs OKX 1小時），驗證系統是否正確將費率標準化並顯示為相同時間基準的費率值。

**Acceptance Scenarios**:

1. **Given** 交易者查看 BTCUSDT 在 Binance（8小時結算）和 OKX（1小時結算）的資金費率，**When** 系統顯示標準化後的費率，**Then** 兩個交易所的費率都以相同的時間基準顯示（例如「每8小時費率」），且費率值已按比例調整
2. **Given** 某交易所的資金費率為 0.01%/小時，**When** 交易者選擇以「每8小時」為基準查看，**Then** 系統顯示該費率為 0.08%（0.01% × 8）
3. **Given** 交易者在市場監控頁面查看多個交易對，**When** 每個交易對在不同交易所有不同的結算週期，**Then** 所有費率都以統一的時間基準顯示，且清楚標示時間基準（例如「費率（每8小時）」）

---

### User Story 2 - 重新計算淨收益邏輯 (Priority: P1)

交易者需要看到正確的淨收益計算，考慮標準化後的資金費率以及實際的套利成本（主要是交易手續費）。現有的淨收益計算方式不夠準確，可能誤導交易者對套利機會的判斷。系統應提供更精確的淨收益計算，包含費率差收益和雙邊手續費成本。

**Why this priority**: 淨收益是交易者決定是否執行套利的關鍵指標。錯誤的計算會導致虛假的套利機會或遺漏真實的機會，直接影響交易決策和獲利能力。

**Independent Test**: 可以通過選擇一個具體的套利場景（例如 BTCUSDT 在 Binance long 和 OKX short），手動計算預期淨收益（包含費率差、手續費），並與系統顯示的淨收益進行比對驗證。

**Acceptance Scenarios**:

1. **Given** BTCUSDT 在 Binance 的標準化資金費率為 0.08%/8h，OKX 為 -0.04%/8h，**When** 交易者查看淨收益，**Then** 系統顯示費率差收益為 0.12%/8h（0.08% - (-0.04%)）
2. **Given** 交易者使用預設手續費率（雙邊 Taker 0.05%，總計 0.1%），**When** 系統計算淨收益，**Then** 淨收益 = 費率差收益 - 雙邊手續費成本（0.1%）
3. **Given** 某套利機會的費率差為 0.1%/8h，但手續費為 0.15%，**When** 系統計算淨收益，**Then** 系統顯示淨收益為負值（-0.05%），並清楚標示此機會不適合套利

---

### User Story 3 - 市場監控頁面顯示優化 (Priority: P2)

交易者在市場監控頁面應能清楚看到每個交易對的標準化資金費率、費率差異、以及考慮成本後的淨收益，並能快速識別出最佳套利機會。頁面應提供排序和篩選功能，讓交易者能夠依淨收益、費率差異等指標來排序交易對。

**Why this priority**: 提升使用者體驗和決策效率。雖然不影響計算邏輯，但好的顯示介面能幫助交易者更快找到最佳套利機會。

**Independent Test**: 可以通過在市場監控頁面測試排序功能（按淨收益排序），驗證排序結果是否正確，以及是否能快速找到最高淨收益的交易對。

**Acceptance Scenarios**:

1. **Given** 市場監控頁面顯示 10 個交易對，**When** 交易者點擊「淨收益」欄位標題，**Then** 所有交易對按淨收益從高到低排序
2. **Given** 交易者查看某個交易對的資金費率，**When** 費率已標準化為每8小時基準，**Then** 頁面清楚標示「費率（每8小時）」，並顯示原始結算週期資訊（例如「原始：每1小時」）
3. **Given** 某交易對在多個交易所有報價，**When** 系統計算最佳套利對（例如 Binance long vs OKX short），**Then** 頁面清楚標示最佳組合、預期淨收益、以及所需持倉時間

---

### Edge Cases

- 當某交易所的資金費率資料暫時無法取得時，系統如何處理該交易對的淨收益計算？是否顯示「資料不足」或使用最近一次的費率？
- 當交易所更改結算週期（例如從 8 小時改為 1 小時）時，系統是否能自動偵測並調整標準化計算？
- 當用戶自定義手續費率或滑點假設時，淨收益計算是否即時更新？
- 當多個交易對有相同的淨收益時，排序的次要依據是什麼？（例如交易量、流動性）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須能夠識別每個交易所每個交易對的資金費率結算週期（1小時、4小時、8小時或其他）
- **FR-002**: 系統必須提供統一的時間基準選項供用戶選擇（例如「每小時」、「每8小時」、「每24小時」）
- **FR-003**: 系統必須自動將所有資金費率轉換為用戶選擇的統一時間基準（例如：0.01%/小時 → 0.08%/8小時）
- **FR-004**: 系統必須在市場監控頁面清楚標示當前使用的時間基準（例如「費率（每8小時）」）
- **FR-005**: 系統必須使用以下公式計算淨收益：淨收益 = 費率差收益 - 雙邊手續費成本（不考慮滑點和其他成本）
- **FR-006**: 系統必須允許用戶自定義手續費率假設（預設值：建倉和平倉均使用 Taker 費率 0.05%，總計雙邊 0.1%）
- **FR-007**: 系統必須在顯示淨收益時同時顯示計算依據（費率差、雙邊手續費的詳細數值）
- **FR-008**: 系統必須提供按淨收益、費率差異、交易對名稱排序的功能
- **FR-009**: 系統必須在淨收益為負值時清楚標示（例如紅色顯示或特殊圖示）
- **FR-010**: 系統必須儲存用戶選擇的時間基準偏好，下次登入時自動套用

### Key Entities

- **標準化資金費率**: 將不同結算週期的資金費率轉換為統一時間基準的費率值，包含原始費率、原始結算週期、目標時間基準、標準化後費率
- **淨收益計算參數**: 用於計算淨收益的各項參數，包含費率差、雙邊手續費率（建倉和平倉均使用 Taker 費率）
- **最佳套利對**: 對於每個交易對，在所有可能的交易所組合中，找出淨收益最高的 long-short 組合，包含交易所對、預期淨收益、風險評估

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 交易者能在 5 秒內找到淨收益最高的 3 個套利機會
- **SC-002**: 標準化資金費率的計算誤差小於 0.0001%（1個基點）
- **SC-003**: 90% 的用戶能在第一次使用時理解標準化時間基準的意義（透過清楚的標示和說明）
- **SC-004**: 淨收益計算包含所有主要成本因素，預測誤差與實際套利結果相差小於 20%
- **SC-005**: 市場監控頁面的資料更新延遲不超過 5 秒（從交易所獲取新費率到顯示標準化結果）

## Assumptions

- 假設大多數交易所的資金費率結算週期為 1 小時、4 小時或 8 小時三種
- 假設交易者主要關心每 8 小時的費率差（因為這是最常見的結算週期）
- 假設手續費率預設為建倉和平倉均使用 Taker 0.05%，總計雙邊 0.1%
- 假設交易者使用市價單開倉和平倉（Taker 費率），不考慮限價單（Maker 費率）的情況
- 假設不考慮價格滑點、資金占用成本和機會成本（淨收益計算僅包含費率差和手續費）
