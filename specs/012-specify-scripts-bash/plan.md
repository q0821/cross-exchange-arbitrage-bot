# Implementation Plan: 標準化資金費率時間與淨收益計算

**Branch**: `012-specify-scripts-bash` | **Date**: 2025-01-15 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/012-specify-scripts-bash/spec.md`

## Summary

本功能實作資金費率時間標準化和淨收益計算邏輯優化。核心需求包含：

1. **標準化資金費率顯示**：將不同交易所的資金費率（1小時、4小時、8小時結算週期）標準化為統一時間基準（例如每8小時），使交易者能直接比較
2. **重新計算淨收益**：修正淨收益計算公式，正確計算 4 筆交易的手續費（long 開倉 + long 平倉 + short 開倉 + short 平倉 = 0.2%）
3. **市場監控頁面優化**：提供清楚的標準化費率顯示、淨收益計算依據、以及排序篩選功能

**技術方法**：
- 前端：擴展現有 WebSocket 資料結構，新增標準化費率欄位和淨收益詳細資訊
- 後端：在 CLI 監控服務中計算標準化費率和淨收益，寫入資料庫
- 資料庫：擴展現有 schema 儲存標準化費率、淨收益詳情、用戶偏好設定
- 前端 UI：修改市場監控頁面表格顯示，新增排序功能和費率詳情 tooltip

## Technical Context

**Language/Version**: TypeScript 5.6 + Node.js 20.x LTS
**Primary Dependencies**:
- Frontend: Next.js 14 App Router, React 18, Tailwind CSS, Radix UI, Socket.io-client 4.8
- Backend: Socket.io 4.8, Prisma 5.x, Decimal.js 10.x
- CLI: ccxt 4.x, @binance/connector 3.x, Decimal.js 10.x

**Storage**: PostgreSQL 15 + TimescaleDB (已配置於 Docker Compose)
**Testing**: Vitest (unit/integration), Playwright (E2E)
**Target Platform**: Web (瀏覽器 + Node.js 伺服器)
**Project Type**: Hybrid (CLI backend + Next.js frontend)

**Performance Goals**:
- 標準化計算延遲 < 10ms (per symbol)
- 市場監控頁面更新延遲 < 5秒 (from exchange API → display)
- WebSocket 訊息頻率 <= 1 update/5s (避免過度更新)

**Constraints**:
- 必須向後相容現有 WebSocket 契約
- 必須保持現有資料庫 schema 的完整性
- 不能影響現有套利機會偵測邏輯

**Scale/Scope**:
- ~50 交易對同時監控
- ~4 交易所資料源
- ~100 用戶同時線上（預估）

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Trading Safety First ✅ NOT APPLICABLE
- 本功能不涉及交易執行，僅涉及數據顯示和計算
- 無需 Saga pattern、交易補償機制等

### Principle II: Complete Observability ✅ PASS
- **Required**: 標準化計算錯誤必須記錄（含原始費率、目標時間基準、計算結果）
- **Required**: 淨收益計算錯誤必須記錄（含費率差、手續費、計算公式）
- **Implementation**: 使用現有 Pino 結構化日誌，新增 `fundingRateNormalizer` 和 `netProfitCalculator` logger context

### Principle III: Defensive Programming ✅ PASS
- **Required**: 處理交易所資金費率資料缺失（使用最近一次有效費率或顯示「資料不足」）
- **Required**: 處理交易所結算週期變更（自動偵測並重新計算）
- **Required**: 驗證用戶輸入的時間基準選項（只允許 1h, 8h, 24h）
- **Implementation**:
  - 使用 Zod schema 驗證用戶輸入
  - 實作 fallback 邏輯處理資料缺失
  - 記錄所有驗證失敗和資料異常

### Principle IV: Data Integrity ✅ PASS
- **Required**: 使用 Prisma migrations 擴展 schema
- **Required**: 使用 Decimal 類型進行所有財務計算（費率、淨收益）
- **Required**: 保持原始費率資料不變，標準化費率和淨收益為衍生欄位
- **Implementation**:
  - 新增 `UserPreferences` model 儲存時間基準偏好
  - 擴展現有 WebSocket 資料結構（不修改資料庫 schema，在 runtime 計算）
  - 所有計算使用 `Decimal.js`

### Principle V: Incremental Delivery ✅ PASS
- **MVP Scope**: User Story 1 (標準化資金費率) 可獨立測試和部署
- **Testing Strategy**:
  1. Unit tests: 標準化計算邏輯
  2. Integration tests: WebSocket 資料流
  3. E2E tests: 市場監控頁面顯示和排序
- **Rollout Plan**: 可以先部署 User Story 1，再逐步啟用 User Story 2 和 3

### Principle VI: System Architecture Boundaries ✅ PASS
- **CLI Responsibilities**:
  - ✅ 從交易所 API 取得資金費率（現有功能）
  - ✅ **NEW**: 識別結算週期（1h/4h/8h）
  - ✅ **NEW**: 計算標準化費率（根據用戶偏好或預設 8h）
  - ✅ **NEW**: 計算淨收益（費率差 - 0.2% 手續費）
  - ✅ **NEW**: 寫入計算結果到記憶體快取（for WebSocket broadcast）
- **Web Responsibilities**:
  - ✅ 訂閱 WebSocket 接收標準化費率和淨收益
  - ✅ 顯示標準化費率、原始結算週期、淨收益詳情
  - ✅ 提供用戶介面選擇時間基準（1h/8h/24h）
  - ✅ 實作排序和篩選功能（前端 state 管理）
- **Data Flow**:
  ```
  CLI Monitor → 計算標準化費率/淨收益 → 記憶體快取 → WebSocket Server
                                                            ↓
                                               Browser Client (React)
  ```
- **Compliance**:
  - ✅ Web 不直接呼叫交易所 API
  - ✅ CLI 不處理複雜 UI 邏輯
  - ✅ 資料流單向（CLI → Web）

### Gate Result: ✅ PASS - 可以進入 Phase 0 研究

## Project Structure

### Documentation (this feature)

```
specs/012-specify-scripts-bash/
├── plan.md              # This file
├── research.md          # Phase 0: Technology decisions
├── data-model.md        # Phase 1: Data structures
├── quickstart.md        # Phase 1: Development guide
├── contracts/           # Phase 1: API/WebSocket schemas
│   └── websocket.md     # WebSocket event definitions
└── tasks.md             # Phase 2: Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```
# Existing structure (no major changes needed)
src/
├── models/              # Existing: domain models
├── services/
│   ├── monitor/        # Existing: FundingRateMonitor
│   │   └── **NEW**: FundingRateNormalizer.ts
│   ├── calculation/    # **NEW**: Net profit calculation
│   │   └── NetProfitCalculator.ts
│   └── websocket/      # Existing: WebSocket handlers
│       └── **MODIFY**: MarketRatesHandler.ts (add normalized rates)
├── repositories/        # Existing: data access
│   └── **NEW**: UserPreferencesRepository.ts
├── lib/                 # Existing: utilities
│   └── **NEW**: fundingRateUtils.ts (normalization helpers)
└── cli/                 # Existing: CLI commands

app/(dashboard)/market-monitor/
├── **MODIFY**: page.tsx              # Add time basis selector
├── **MODIFY**: useMarketRates.ts     # Handle normalized rates from WebSocket
├── components/
│   ├── **MODIFY**: RatesTable.tsx    # Display normalized rates
│   ├── **MODIFY**: RateRow.tsx       # Show net profit details
│   └── **NEW**: TimeBasisSelector.tsx # User preference UI
└── utils/
    └── **NEW**: rateNormalization.ts  # Frontend formatting helpers

tests/
├── unit/
│   ├── **NEW**: FundingRateNormalizer.test.ts
│   └── **NEW**: NetProfitCalculator.test.ts
├── integration/
│   └── **NEW**: normalized-rates-websocket.test.ts
└── e2e/
    └── **NEW**: market-monitor-sorting.spec.ts
```

**Structure Decision**:
- 採用現有 hybrid 架構（CLI backend + Next.js frontend）
- 最小化檔案變更，優先擴展現有模組
- 新增服務層處理標準化和計算邏輯
- 前端新增 UI 組件但保持現有資料流架構

## Complexity Tracking

*No Constitution violations - this section is not applicable*

