# Feature Specification: 分單開倉（獨立持倉）

**Feature Branch**: `060-split-position-open`
**Created**: 2026-01-07
**Status**: Draft
**Input**: User description: "分單開倉（獨立持倉）功能：開倉時可指定「開幾組」，每組都是獨立的持倉記錄。例如原本 600 顆開 1 單，可改成 300 顆開 2 單（2 個獨立持倉）。好處：減少單筆滑價、可分批平倉、各自獨立管理停損停利。執行方式採串行開倉（第 1 組完成後才開第 2 組），避免同時下單造成的市場衝擊。前端在開倉對話框新增「開倉組數」參數，後端循環調用現有開倉 API。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 分單開倉減少滑價 (Priority: P1) 🎯 MVP

用戶想要開一個較大的套利持倉，但擔心一次性下單會造成較大的滑價損失。透過分單開倉功能，用戶可以將原本的大單拆分成多個小單，串行執行以減少市場衝擊。

**Why this priority**: 這是分單開倉的核心價值，直接解決用戶的主要痛點（滑價問題）。

**Independent Test**: 用戶在開倉對話框指定開倉組數，系統依序建立多個獨立持倉，每個持倉有獨立的資料記錄。

**Acceptance Scenarios**:

1. **Given** 用戶在開倉對話框選擇 BTCUSDT，總數量 600，開倉組數 2，**When** 用戶確認開倉，**Then** 系統依序建立 2 個獨立持倉，每個持倉數量為 300
2. **Given** 用戶設定開倉組數為 3，總數量 900，**When** 開倉執行中，**Then** 系統顯示「正在建立第 1/3 組持倉...」的進度提示
3. **Given** 第 1 組持倉建立成功，**When** 系統開始建立第 2 組，**Then** 第 2 組使用與第 1 組相同的交易對和交易所組合，但為獨立的持倉記錄

---

### User Story 2 - 分組持倉獨立管理 (Priority: P2)

用戶希望每個分組持倉都有獨立的停損停利設定，可以根據市場變化分別調整或平倉。

**Why this priority**: 獨立管理是分單開倉的延伸價值，建立在 US1 的基礎上。

**Independent Test**: 在持倉列表中，每個分組持倉都獨立顯示，可以單獨設定停損停利或平倉。

**Acceptance Scenarios**:

1. **Given** 用戶已建立 3 組分單持倉，**When** 用戶查看持倉列表，**Then** 每組持倉獨立顯示，各有獨立的 ID 和狀態
2. **Given** 用戶查看分組持倉詳情，**When** 用戶修改其中一組的停損設定，**Then** 只有該組持倉的設定被修改，其他組不受影響
3. **Given** 用戶想要部分獲利了結，**When** 用戶平倉其中一組，**Then** 只有該組被平倉，其他組繼續持有

---

### User Story 3 - 分單開倉錯誤處理 (Priority: P3)

當分單開倉過程中某一組失敗時，系統需要妥善處理已建立的持倉，並清楚告知用戶失敗原因和後續處理方式。

**Why this priority**: 錯誤處理是確保系統穩定性的重要環節，但不是核心功能。

**Independent Test**: 模擬中間某組開倉失敗，驗證系統的錯誤處理和用戶提示。

**Acceptance Scenarios**:

1. **Given** 用戶設定開倉 3 組，**When** 第 2 組開倉失敗（如餘額不足），**Then** 系統停止後續開倉，並顯示「已完成 1/3 組，第 2 組失敗：餘額不足」
2. **Given** 分單開倉部分失敗，**When** 用戶查看持倉列表，**Then** 已成功建立的持倉正常顯示並可操作
3. **Given** 第 1 組開倉就失敗，**When** 系統顯示錯誤訊息，**Then** 用戶可以修正問題後重新嘗試開倉

---

### Edge Cases

- 當用戶輸入的組數導致每組數量低於交易所最小交易量時，系統應提示調整
- 當開倉過程中網路斷線，已完成的持倉應保留，未完成的應有明確狀態
- 當用戶設定組數為 1 時，行為應與現有單一開倉完全相同
- 當總數量無法平均分配時（如 100 分 3 組），系統應合理分配（如 34+33+33）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須在開倉對話框中提供「開倉組數」參數，允許用戶指定分組數量
- **FR-002**: 系統必須支援 1-10 組的分組範圍，預設值為 1
- **FR-003**: 系統必須自動計算每組的數量（總數量 ÷ 組數），並合理處理無法整除的情況
- **FR-004**: 系統必須採用串行方式執行分組開倉（完成前一組後才開始下一組）
- **FR-005**: 系統必須為每組持倉建立獨立的記錄，包含獨立的 ID 和狀態
- **FR-006**: 系統必須在開倉過程中顯示當前進度（如「正在建立第 2/3 組...」）
- **FR-007**: 當某組開倉失敗時，系統必須停止後續開倉並顯示錯誤詳情
- **FR-008**: 系統必須驗證每組數量是否符合交易所最小交易量要求
- **FR-009**: 每組持倉必須能夠獨立設定停損停利，獨立平倉
- **FR-010**: 組數為 1 時，系統行為必須與現有單一開倉功能完全一致

### Key Entities

- **Position（持倉）**: 每組分單開倉都是獨立的持倉記錄，包含交易對、數量、開倉價格、停損停利設定等
- **PositionGroup（持倉組）**: 同一次分單開倉操作產生的多個持倉可透過共同的批次識別碼關聯（可選，用於追蹤同批次持倉）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用戶可在 3 秒內完成開倉組數設定並看到每組預估數量
- **SC-002**: 分組開倉的總執行時間不超過單組開倉時間 × 組數 × 1.2（允許 20% 額外開銷）
- **SC-003**: 100% 的成功分組持倉在持倉列表中獨立顯示並可操作
- **SC-004**: 當分組開倉部分失敗時，已成功的持倉保持完整可用
- **SC-005**: 用戶滿意度：分單開倉功能減少至少 50% 的大額交易滑價顧慮（用戶反饋）

## Assumptions

- 現有的單一開倉流程已經穩定運作，可被重複調用
- 交易所速率限制不會在短時間內（如 10 秒）限制連續的開倉請求
- 用戶理解分單開倉的執行時間會比單一開倉更長（串行執行）
- 每組持倉的停損停利設定預設與第一組相同，用戶可事後單獨修改

## Out of Scope

- 並行開倉（同時執行多組開倉）：本次僅實作串行模式
- 智能分組建議（根據市場深度自動計算最佳組數）：用戶手動指定
- 跨交易對分單（同時開多個不同交易對）：本次只處理單一交易對的分組
