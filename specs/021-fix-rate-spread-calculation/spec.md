# Feature Specification: 修正費率差異計算的時間基準一致性

**Feature Branch**: `021-fix-rate-spread-calculation`
**Created**: 2025-01-21
**Status**: Draft
**Input**: User description: "修正市場監控費率差異計算的時間基準一致性問題"

## 問題背景

當用戶在市場監控頁面切換時間基準（1h, 4h, 8h, 24h）時，費率差異顯示值與年化報酬計算不一致，導致訪客困惑。

### 當前問題
1. 費率差異不會根據選擇的時間基準動態變動
2. 年化報酬計算使用固定的 8 小時週期，未根據 timeBasis 參數調整
3. 例如：選擇 1 小時基準時，顯示費率差異 0.6012%（8 小時基準的值），但年化報酬 658.30% 卻是基於 1 小時計算的

### 根本原因
後端年化收益計算使用固定值：`spread * 365 * 3 * 100`（固定 8 小時週期），應該改為動態計算：`spread * 365 * (24 / timeBasis) * 100`

## User Scenarios & Testing

### User Story 1 - 切換時間基準查看正確的費率差異 (Priority: P1)

作為市場監控用戶，我希望當我切換不同的時間基準（1h, 4h, 8h, 24h）時，費率差異能夠正確地根據該時間基準重新計算並顯示，這樣我才能準確評估不同結算週期下的套利機會。

**Why this priority**: 這是核心功能缺陷，直接影響用戶對套利機會的判斷準確性。錯誤的費率差異會導致用戶誤判套利機會的大小，可能造成交易決策失誤。

**Independent Test**: 可以通過在市場監控頁面切換時間基準選項（1h → 4h → 8h → 24h），觀察費率差異欄位的數值變化來測試。預期看到費率差異隨時間基準成比例變動。

**Acceptance Scenarios**:

1. **Given** 用戶在市場監控頁面查看某個交易對（如 MMTUSDT）且選擇 1 小時時間基準，**When** 系統計算並顯示費率差異，**Then** 顯示的費率差異應該是標準化為 1 小時基準的值（例如：0.075%）
2. **Given** 用戶當前選擇 1 小時基準且看到費率差異為 0.075%，**When** 用戶切換到 8 小時基準，**Then** 費率差異應該更新為標準化為 8 小時基準的值（約為 0.6%，即 0.075% × 8）
3. **Given** 用戶查看多個不同的交易對，**When** 切換時間基準，**Then** 所有交易對的費率差異都應該相應地重新計算並更新顯示
4. **Given** 用戶選擇任一時間基準，**When** 系統計算費率差異，**Then** 使用的費率值必須是標準化為該時間基準的費率

---

### User Story 2 - 查看一致的年化報酬計算結果 (Priority: P1)

作為市場監控用戶，我希望無論選擇哪個時間基準，同一個套利機會的年化報酬都保持一致，因為實際的年化收益不會因為我查看時選擇的時間基準不同而改變。

**Why this priority**: 這是計算邏輯的核心正確性問題。年化報酬是用戶評估套利機會價值的關鍵指標，必須確保計算正確且一致。

**Independent Test**: 可以通過記錄某個交易對在不同時間基準下的費率差異和年化報酬，驗證公式 `年化報酬 = 費率差異 × (365 × 24 / 時間基準)` 在所有時間基準下都成立。

**Acceptance Scenarios**:

1. **Given** 某個交易對在 1 小時基準下顯示費率差異 0.075% 和年化報酬 658.3%，**When** 切換到 8 小時基準，**Then** 費率差異應更新為 0.6%，但年化報酬應保持 658.3%
2. **Given** 用戶選擇 4 小時時間基準，**When** 系統計算年化報酬，**Then** 使用的結算次數應該是 `365 × (24 / 4) = 2190`
3. **Given** 任意時間基準和費率差異，**When** 系統計算年化報酬，**Then** 公式應為 `費率差異 × (365 × 24 / 時間基準)`
4. **Given** 同一個交易對在不同時間基準下，**When** 計算年化報酬，**Then** 所有時間基準下的年化報酬數值應該相同（允許微小的浮點數誤差）

---

### User Story 3 - 驗證計算邏輯的正確性 (Priority: P2)

作為開發團隊，我們需要通過自動化測試驗證費率差異和年化報酬的計算邏輯在所有時間基準（1h, 4h, 8h, 24h）下都是正確的，確保修正後的邏輯不會引入新的問題。

**Why this priority**: 這是質量保證的必要步驟，確保修正的正確性和完整性，防止回歸問題。

**Independent Test**: 可以通過單元測試和集成測試來獨立驗證計算邏輯，不依賴於其他功能。

**Acceptance Scenarios**:

1. **Given** 測試環境中有模擬的費率數據，**When** 執行單元測試驗證 getNormalizedRate 函數，**Then** 所有時間基準下都返回正確的標準化費率
2. **Given** 測試環境中有完整的費率數據，**When** 執行集成測試驗證 bestPair 計算，**Then** 費率差異和年化報酬的計算結果符合預期公式
3. **Given** 各個時間基準的測試案例，**When** 執行端到端測試，**Then** 前端顯示的數值與後端計算的數值一致

---

### Edge Cases

- **當標準化費率數據缺失時**：系統應該使用降級邏輯（即時計算標準化值或返回原始費率並記錄警告），不應該導致顯示錯誤或崩潰
- **當原始費率週期等於選擇的時間基準時**：系統應該直接使用原始費率，不需要標準化轉換
- **當時間基準參數無效或缺失時**：系統應該使用預設的 8 小時基準，並記錄警告
- **當費率值為零或極小值時**：系統應該正確處理，避免除零錯誤或精度損失
- **當用戶快速切換時間基準時**：系統應該確保計算和顯示的同步，避免顯示過時的數據

## Requirements

### Functional Requirements

- **FR-001**: 系統必須根據用戶選擇的時間基準（1h, 4h, 8h, 24h）動態計算費率差異
- **FR-002**: 後端計算年化報酬時必須使用動態的時間基準參數，公式為：`spread × 365 × (24 / timeBasis) × 100`
- **FR-003**: 前端 `getNormalizedRate` 函數必須正確返回標準化為目標時間基準的費率值
- **FR-004**: 當標準化費率數據存在時，系統必須優先使用標準化值；當缺失時，必須使用降級邏輯（即時計算或原始費率）
- **FR-005**: 系統必須確保前後端使用相同的計算邏輯和公式，避免不一致
- **FR-006**: 系統必須在所有時間基準下正確計算每年結算次數：`365 × (24 / timeBasis)`
- **FR-007**: 系統必須在切換時間基準時重新計算所有交易對的 bestPair，確保顯示的費率差異和年化報酬都是基於新的時間基準
- **FR-008**: 系統必須處理標準化數據缺失的情況，使用即時計算或降級邏輯，並記錄相應的警告日誌

### Key Entities

- **FundingRate（資金費率）**: 包含原始費率、標準化費率（針對 1h, 4h, 8h, 24h）、原始結算週期
- **BestArbitragePair（最佳套利對）**: 包含做多交易所、做空交易所、費率差異（spread）、費率差異百分比（spreadPercent）、年化報酬（annualizedReturn）
- **TimeBasis（時間基準）**: 用戶選擇的結算週期基準（1, 4, 8, 或 24 小時）

## Success Criteria

### Measurable Outcomes

- **SC-001**: 用戶切換時間基準時，費率差異在 100 毫秒內更新並正確顯示對應的標準化值
- **SC-002**: 對於同一個交易對，在所有時間基準（1h, 4h, 8h, 24h）下計算的年化報酬數值相同（允許 0.01% 的浮點數誤差）
- **SC-003**: 費率差異的計算公式正確實現：`spreadPercent = |rate1 - rate2| × 100`，其中 rate1 和 rate2 是標準化為目標時間基準的費率
- **SC-004**: 年化報酬的計算公式正確實現：`annualizedReturn = spread × (365 × 24 / timeBasis) × 100`
- **SC-005**: 所有單元測試和集成測試通過，測試覆蓋率達到 90% 以上（針對修改的計算邏輯）
- **SC-006**: 在各個時間基準下，費率差異的數值關係符合比例：`spread_8h = spread_1h × 8`、`spread_4h = spread_1h × 4` 等
- **SC-007**: 系統在標準化數據缺失時不會崩潰，能夠使用降級邏輯並記錄警告（警告日誌正確記錄）

## Assumptions

1. 後端已經正確計算並推送了所有時間基準（1h, 4h, 8h, 24h）的標準化費率數據
2. WebSocket 推送的數據結構包含 `normalized` 和 `originalInterval` 欄位
3. 前端的 `getNormalizedRate` 函數邏輯與後端一致
4. 時間基準參數在前後端之間正確傳遞
5. 浮點數計算精度足夠，不會導致顯著的累積誤差
6. 用戶期望看到的費率差異是相對於選擇的時間基準標準化後的值
7. 年化報酬的定義是：假設以當前費率差異進行套利，一年內所有結算週期累積的總收益率

## Dependencies

- 依賴後端 `FundingRateNormalizer` 服務正確計算標準化費率
- 依賴 WebSocket `MarketRatesHandler` 正確推送標準化數據
- 依賴前端 `useMarketRates` hook 正確管理時間基準狀態
- 依賴現有的費率數據結構和類型定義

## Out of Scope

- 不涉及新增時間基準選項（僅支援現有的 1h, 4h, 8h, 24h）
- 不涉及修改費率數據的來源或獲取方式
- 不涉及 UI/UX 的重大改變（僅修正計算邏輯）
- 不涉及新增或修改資料庫 schema
- 不涉及修改標準化費率的計算公式（僅修正使用方式）
