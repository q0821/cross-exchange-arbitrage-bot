# Feature Specification: 跨交易所資金費率套利平台

**Feature Branch**: `001-funding-rate-arbitrage`
**Created**: 2025-10-17
**Status**: Draft
**Input**: User description: "專為永續合約市場設計的跨交易所資金費率套利平台。它自動偵測各交易所間的資金費率差異,並在條件符合時執行雙邊對沖交易,讓使用者在市場波動中持續獲取穩定收益,同時降低風險與操作成本。一開始先追蹤幣安及okx兩個交易所就好,幣別追蹤 BTC、ETH、SOL 就好"

## Clarifications

### Session 2025-10-20

- Q: 當系統需要儲存交易所 API 金鑰時（用於自動交易），這些敏感憑證應該如何管理？ → A: 環境變數 + 作業系統金鑰鏈（macOS Keychain / Linux Secret Service）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 即時監控資金費率差異 (Priority: P1)

使用者希望能夠即時查看幣安 (Binance) 和 OKX 兩個交易所之間的資金費率差異,以便識別潛在的套利機會。系統會持續追蹤 BTC、ETH 和 SOL 三種幣別的永續合約資金費率。

**Why this priority**: 這是套利平台的核心功能,沒有即時的資金費率數據,就無法進行後續的套利決策。這是整個系統的基礎。

**Independent Test**: 可以透過啟動監控服務,驗證系統是否能成功從兩個交易所取得資金費率數據,並計算出費率差異。不需要實際執行交易即可測試。

**Acceptance Scenarios**:

1. **Given** 系統已連線至幣安和 OKX 交易所,**When** 使用者查詢 BTC 的資金費率,**Then** 系統顯示兩個交易所的當前資金費率及其差異百分比
2. **Given** 系統正在運行,**When** 任一交易所的資金費率發生變化,**Then** 系統在 5 秒內更新資金費率數據
3. **Given** 系統正在監控 ETH 和 SOL,**When** 使用者查看監控狀態,**Then** 系統顯示所有追蹤幣別的最新資金費率及更新時間
4. **Given** 某個交易所 API 暫時無法連線,**When** 系統偵測到連線失敗,**Then** 系統記錄錯誤並在恢復連線後自動重新開始監控

---

### User Story 2 - 自動偵測套利機會 (Priority: P1)

系統能夠根據預設的閾值條件,自動判斷當前的資金費率差異是否達到套利條件,並即時通知使用者。

**Why this priority**: 自動偵測能讓使用者不需要持續手動監控,這是自動化套利的關鍵功能,與即時監控同等重要。

**Independent Test**: 可以透過模擬不同的資金費率差異場景,驗證系統是否能正確識別達到閾值的套利機會,並發出通知。

**Acceptance Scenarios**:

1. **Given** 系統設定套利閾值為資金費率差異大於 0.05%,**When** BTC 在兩個交易所的費率差異達到 0.06%,**Then** 系統標記為套利機會並通知使用者
2. **Given** 資金費率差異為 0.03%,**When** 差異未達到閾值,**Then** 系統持續監控但不發出通知
3. **Given** 系統偵測到套利機會,**When** 費率差異回落至閾值以下,**Then** 系統移除該套利機會標記
4. **Given** 同時存在多個幣別的套利機會,**When** 使用者查看套利列表,**Then** 系統按照潛在收益由高到低排序顯示

---

### User Story 3 - 執行雙邊對沖交易 (Priority: P2)

當偵測到符合條件的套利機會時,系統能夠自動在兩個交易所執行相反方向的永續合約交易,實現資金費率套利。

**Why this priority**: 這是套利獲利的執行階段,雖然重要,但必須建立在前兩個故事的基礎之上,因此優先級稍低。

**Independent Test**: 可以透過在測試環境中模擬套利機會,驗證系統是否能正確下單並在兩個交易所建立對沖部位。

**Acceptance Scenarios**:

1. **Given** 偵測到 ETH 的套利機會且使用者設定為自動執行,**When** 系統決定執行交易,**Then** 系統同時在幣安做多、在 OKX 做空相同金額的 ETH 永續合約
2. **Given** 系統準備執行套利交易,**When** 任一交易所的可用餘額不足,**Then** 系統取消交易並通知使用者餘額不足
3. **Given** 系統正在執行雙邊開倉,**When** 其中一邊的訂單失敗,**Then** 系統立即取消或平倉另一邊的訂單,避免單邊風險
4. **Given** 雙邊交易已成功建立,**When** 使用者查看持倉狀態,**Then** 系統顯示兩個交易所的部位、保證金使用率和預期收益

---

### User Story 4 - 自動平倉與收益結算 (Priority: P2)

系統能夠監控已建立的對沖部位,在適當的時機自動平倉,實現套利收益。

**Why this priority**: 完整的套利循環需要平倉來實現收益,但這可以在開倉功能穩定後再實現。

**Independent Test**: 可以透過模擬已存在的對沖部位,驗證系統是否能根據設定的條件自動平倉並計算收益。

**Acceptance Scenarios**:

1. **Given** 系統持有 BTC 的對沖部位,**When** 資金費率結算時間到達,**Then** 系統自動平倉並計算實際收益
2. **Given** 對沖部位已持有一段時間,**When** 資金費率差異反轉超過設定的止損閾值,**Then** 系統執行止損平倉以降低損失
3. **Given** 系統準備平倉,**When** 市場流動性不足導致滑價過大,**Then** 系統暫緩平倉並等待更好的市場條件
4. **Given** 平倉完成,**When** 使用者查看交易歷史,**Then** 系統顯示完整的套利週期記錄,包括開倉時間、平倉時間、手續費和淨收益

---

### User Story 5 - 風險管理與監控 (Priority: P3)

系統提供風險管理功能,包括設定每次交易的最大金額、總倉位限制、以及異常情況的自動處理。

**Why this priority**: 風險管理是保護資金安全的重要功能,但可以在基本交易功能驗證後再加強。

**Independent Test**: 可以透過設定不同的風險參數,驗證系統是否能正確執行風險控制邏輯。

**Acceptance Scenarios**:

1. **Given** 使用者設定單次交易最大金額為 10,000 USDT,**When** 系統計劃執行一筆 15,000 USDT 的套利交易,**Then** 系統將交易金額限制在 10,000 USDT
2. **Given** 總倉位已達到使用者設定的上限,**When** 新的套利機會出現,**Then** 系統不執行新交易並通知使用者倉位已滿
3. **Given** 系統偵測到某個交易所出現異常大的滑價,**When** 準備執行交易,**Then** 系統暫停該交易所的自動交易並發出警告
4. **Given** 系統運行中,**When** 使用者查看風險儀表板,**Then** 系統顯示當前總保證金使用率、未實現盈虧和風險評級

---

### Edge Cases

- 當兩個交易所的資金費率同時發生劇烈變化時,系統如何確保數據一致性?
- 如何處理交易所 API 限流導致的請求失敗?
- 當網路延遲過高時,如何避免套利機會已經消失仍執行交易?
- 如果兩個交易所的系統時間不同步,如何確保資金費率結算時間的準確性?
- 當某個幣別在其中一個交易所暫停交易時,系統如何處理?
- 極端市場波動導致強制平倉時,如何處理另一邊的對沖部位?
- 交易所維護或升級期間,系統如何處理已存在的部位?

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須能夠同時連線至幣安和 OKX 兩個交易所的 API
- **FR-002**: 系統必須能夠即時獲取 BTC、ETH、SOL 三種幣別的永續合約資金費率
- **FR-003**: 系統必須每 5 秒或更短時間內更新一次資金費率數據
- **FR-004**: 系統必須計算並顯示兩個交易所之間的資金費率差異百分比
- **FR-005**: 系統必須允許使用者設定套利觸發的資金費率差異閾值
- **FR-006**: 系統必須在資金費率差異達到閾值時自動標記為套利機會
- **FR-007**: 系統必須能夠在兩個交易所同時執行相反方向的永續合約市價單
- **FR-008**: 系統必須在執行交易前驗證兩個交易所的帳戶餘額是否充足
- **FR-009**: 系統必須在任一交易所訂單失敗時,自動取消或平倉另一個交易所的對應訂單
- **FR-010**: 系統必須記錄所有套利交易的完整生命週期,包括開倉、持倉和平倉
- **FR-011**: 系統必須支援自動平倉功能,可根據資金費率結算時間或使用者設定的條件觸發
- **FR-012**: 系統必須計算每筆套利交易的實際收益,包括手續費、資金費率收入和滑價成本
- **FR-013**: 系統必須允許使用者設定單次交易的最大金額限制
- **FR-014**: 系統必須允許使用者設定總倉位的上限
- **FR-015**: 系統必須在交易所 API 連線失敗時自動重試,並記錄失敗事件
- **FR-016**: 系統必須在偵測到異常情況時暫停自動交易並通知使用者
- **FR-017**: 系統必須提供使用者手動啟動和停止監控功能
- **FR-018**: 系統必須提供使用者手動執行或取消套利交易的功能
- **FR-019**: 系統必須在執行雙邊交易時確保訂單金額和方向正確(一個做多、一個做空)
- **FR-020**: 系統必須持續監控已建立的對沖部位,包括保證金使用率和未實現盈虧
- **FR-021**: 系統必須使用環境變數儲存 API 金鑰,並支援作業系統金鑰鏈 (macOS Keychain / Linux Secret Service) 作為額外的加密保護層

### Non-Functional Requirements

#### Security & Privacy
- **NFR-SEC-001**: API 金鑰必須透過環境變數配置,不可硬編碼於程式碼或配置檔中
- **NFR-SEC-002**: 系統應支援整合作業系統金鑰鏈服務 (macOS Keychain, Linux Secret Service) 以提供額外的憑證加密保護
- **NFR-SEC-003**: 所有與交易所的 API 通訊必須使用 HTTPS/WSS 加密連線
- **NFR-SEC-004**: 系統日誌不可記錄完整的 API 金鑰,僅允許記錄前 4 碼或後 4 碼作為識別

### Key Entities

- **資金費率記錄 (Funding Rate Record)**: 代表某個交易所、某個幣別在特定時間點的資金費率,包含交易所名稱、幣別代碼、資金費率百分比、下次結算時間和記錄時間戳
- **套利機會 (Arbitrage Opportunity)**: 代表一個潛在的套利機會,包含幣別、兩個交易所的資金費率、費率差異、預期收益率、機會發現時間和狀態(待執行/已執行/已過期)
- **對沖部位 (Hedge Position)**: 代表一對在兩個交易所建立的相反方向永續合約部位,包含幣別、兩個交易所的訂單資訊、開倉金額、開倉時間、當前保證金使用率、未實現盈虧和狀態(持倉中/已平倉)
- **交易記錄 (Trade Record)**: 代表單一交易所的單筆訂單記錄,包含交易所名稱、幣別、方向(做多/做空)、訂單類型、數量、成交價格、手續費和執行時間
- **套利週期 (Arbitrage Cycle)**: 代表一個完整的套利操作,從機會偵測到開倉、持倉和平倉的完整記錄,包含關聯的對沖部位、所有相關交易記錄、總收益、總成本和淨利潤
- **風險參數 (Risk Parameters)**: 代表使用者設定的風險控制參數,包含套利閾值、單次交易最大金額、總倉位上限、止損閾值和自動交易開關

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 系統能夠在 5 秒內完成從兩個交易所獲取資金費率數據並計算差異
- **SC-002**: 系統能夠在偵測到套利機會後的 10 秒內完成雙邊開倉操作
- **SC-003**: 雙邊開倉的成功率達到 95% 以上(排除餘額不足和市場極端情況)
- **SC-004**: 當任一交易所訂單失敗時,系統能在 3 秒內取消或平倉另一邊訂單,避免單邊風險
- **SC-005**: 系統能夠同時監控 3 個幣別(BTC、ETH、SOL)而不發生數據延遲或遺漏
- **SC-006**: 系統在連續運行 24 小時的情況下,API 連線穩定性達到 99% 以上
- **SC-007**: 每筆套利交易的完整記錄包含至少 10 個關鍵數據點(開倉時間、價格、手續費、收益等)
- **SC-008**: 使用者能夠在 3 次點擊內啟動或停止套利監控功能
- **SC-009**: 風險管理功能能夠 100% 阻止超過使用者設定限額的交易
- **SC-010**: 系統能夠在資金費率結算時間前後 1 分鐘內完成自動平倉操作

### Assumptions

- 假設使用者已在幣安和 OKX 兩個交易所開設帳戶並完成 API 金鑰設定
- 假設使用者帳戶中有足夠的 USDT 或其他穩定幣作為保證金
- 假設兩個交易所的永續合約使用相同的保證金模式(如 USDT 本位)
- 假設使用者具備基本的加密貨幣交易和永續合約知識
- 假設資金費率結算週期為標準的 8 小時(可能因交易所而異,系統需適應)
- 假設使用者的網路環境穩定,能夠支援即時數據傳輸
- 假設交易所 API 具備足夠的請求限額以支援即時監控需求
- 假設市場正常運作,不考慮交易所被駭客攻擊或長時間維護的極端情況
- 假設使用者的作業系統支援金鑰鏈服務 (macOS Keychain / Linux Secret Service),或願意僅使用環境變數作為憑證管理方式
