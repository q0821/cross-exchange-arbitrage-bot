# Feature Specification: 開倉停損停利設定

**Feature Branch**: `038-specify-scripts-bash`
**Created**: 2025-12-20
**Status**: Draft
**Input**: User description: "目前開倉沒有設定停損停利，有可能會爆艙，需要設定一下開倉的時候能同步設定停利停損，以免爆倉"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 開倉時設定停損 (Priority: P1) 🎯 MVP

用戶在開倉時，系統自動為雙邊倉位設定停損單，當市場價格不利於套利策略時自動平倉，避免因單邊爆倉造成巨額虧損。

**Why this priority**: 防止爆倉是最核心的風險控制需求。在套利交易中，如果價格大幅波動導致單邊爆倉，另一邊倉位將暴露在巨大的單向風險中。停損是必要的風險控制機制。

**Independent Test**: 開倉後在交易所確認停損單已正確設定，並驗證當價格觸及停損價位時倉位自動平倉。

**Acceptance Scenarios**:

1. **Given** 用戶在開倉對話框選擇開啟停損, **When** 用戶完成開倉, **Then** 系統在兩個交易所同時設定停損單
2. **Given** 用戶設定停損百分比為 5%, **When** Long 倉位價格下跌 5%, **Then** Long 倉位停損單觸發並自動平倉
3. **Given** 用戶設定停損百分比為 5%, **When** Short 倉位價格上漲 5%, **Then** Short 倉位停損單觸發並自動平倉
4. **Given** 開倉成功, **When** 停損單設定失敗, **Then** 系統顯示警告並建議用戶手動設定停損

---

### User Story 2 - 開倉時設定停利 (Priority: P2)

用戶在開倉時，系統可選擇性地為雙邊倉位設定停利單，當套利價差達到預期目標時自動平倉鎖定利潤。

**Why this priority**: 停利可以自動鎖定利潤，但相比防止爆倉的停損，優先級稍低。用戶也可以手動監控並平倉。

**Independent Test**: 開倉後在交易所確認停利單已正確設定，並驗證當價格觸及停利價位時倉位自動平倉。

**Acceptance Scenarios**:

1. **Given** 用戶在開倉對話框選擇開啟停利, **When** 用戶完成開倉, **Then** 系統在兩個交易所同時設定停利單
2. **Given** 用戶設定停利百分比為 3%, **When** Long 倉位價格上漲 3%, **Then** Long 倉位停利單觸發並自動平倉
3. **Given** 用戶設定停利百分比為 3%, **When** Short 倉位價格下跌 3%, **Then** Short 倉位停利單觸發並自動平倉

---

### User Story 3 - 停損停利預設值管理 (Priority: P3)

用戶可以在設定頁面配置停損停利的預設值，避免每次開倉都需要手動輸入。

**Why this priority**: 便利性功能，提升使用者體驗，但非核心風險控制功能。

**Independent Test**: 在設定頁面設定預設值後，開倉對話框自動帶入預設值。

**Acceptance Scenarios**:

1. **Given** 用戶在設定頁面設定預設停損 5%, **When** 用戶開啟開倉對話框, **Then** 停損輸入框預設顯示 5%
2. **Given** 用戶在設定頁面設定預設停利 3%, **When** 用戶開啟開倉對話框, **Then** 停利輸入框預設顯示 3%
3. **Given** 用戶在開倉對話框修改停損值, **When** 用戶完成開倉, **Then** 使用修改後的值而非預設值

---

### Edge Cases

- 當交易所不支援條件單時，系統應顯示適當的錯誤訊息
- 當停損單設定成功但停利單設定失敗時，系統應記錄並提醒用戶
- 當價格在開倉完成前就已經觸及停損價位時，系統應如何處理
- 當停損百分比設定過小（如 0.1%）可能導致立即觸發的情況
- 當網路延遲導致開倉和設定停損之間有時間差時的處理

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須在開倉對話框中提供停損設定選項（開關 + 百分比輸入）
- **FR-002**: 系統必須在開倉對話框中提供停利設定選項（開關 + 百分比輸入）
- **FR-003**: 系統必須在開倉成功後，自動在對應交易所設定停損條件單
- **FR-004**: 系統必須在開倉成功後，自動在對應交易所設定停利條件單（如啟用）
- **FR-005**: 系統必須支援以百分比方式設定停損停利價位（基於開倉均價計算）
- **FR-006**: 系統必須在持倉記錄中顯示已設定的停損停利價位
- **FR-007**: 系統必須在設定頁面提供停損停利預設值配置
- **FR-008**: 系統必須在停損單或停利單設定失敗時顯示警告訊息
- **FR-009**: 系統必須支援停損百分比範圍為 0.5% 至 50%
- **FR-010**: 系統必須支援停利百分比範圍為 0.5% 至 100%

### Key Entities

- **StopLossOrder**: 停損單，包含觸發價格、關聯倉位、交易所訂單 ID、狀態
- **TakeProfitOrder**: 停利單，包含觸發價格、關聯倉位、交易所訂單 ID、狀態
- **TradingSettings**: 交易設定，包含預設停損百分比、預設停利百分比、是否預設啟用停損、是否預設啟用停利

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 開倉後停損單在 5 秒內成功設定到交易所
- **SC-002**: 停損單設定成功率達到 95% 以上
- **SC-003**: 用戶能在開倉對話框中在 10 秒內完成停損停利設定
- **SC-004**: 當價格觸及停損價位時，倉位在 10 秒內自動平倉
- **SC-005**: 停損停利功能減少因單邊爆倉造成的虧損事件

## Assumptions

1. 各交易所（Binance、OKX、Gate.io、MEXC）都支援條件單/止損單功能
2. 停損停利使用市價單執行，以確保能夠成交
3. 停損停利計算基於開倉均價，而非即時價格
4. 系統不監控已設定的停損停利單狀態，由交易所負責執行
5. 雙邊倉位使用相同的停損停利百分比設定
6. 停損停利單設定失敗不會影響開倉的成功狀態

## Out of Scope

- 追蹤止損（Trailing Stop）功能
- 移動停利功能
- 基於絕對價格設定停損停利（本版本僅支援百分比）
- 停損停利單的修改和取消功能（本版本僅支援開倉時設定）
- 監控停損停利單的執行狀態並同步更新持倉狀態
