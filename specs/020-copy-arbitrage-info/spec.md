# Feature Specification: 一鍵複製套利機會資訊

**Feature Branch**: `020-copy-arbitrage-info`
**Created**: 2025-11-21
**Status**: Draft
**Input**: User description: "新增一鍵複製套利機會功能，在市場監控頁面每一行交易對右側新增複製按鈕，點擊後將套利資訊（包含交易對、做多/做空交易所、價差、資費差、下單提醒、風險提醒）按指定格式複製到剪貼板"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 快速複製套利機會資訊 (Priority: P1)

交易者在市場監控頁面發現有吸引力的套利機會時，需要快速複製完整的套利資訊以便：
- 分享給團隊成員討論
- 貼到交易筆記或試算表中記錄
- 發送到通訊軟體群組中通知其他交易者

**Why this priority**: 這是核心功能，提供最直接的價值。沒有這個功能，用戶需要手動複製多個欄位並重新格式化，耗時且容易出錯。

**Independent Test**: 可以透過在市場監控頁面點擊任意交易對行的「複製」按鈕，並檢查剪貼板內容是否包含正確格式的套利資訊來獨立測試。

**Acceptance Scenarios**:

1. **Given** 用戶正在查看市場監控頁面且有套利機會存在，**When** 用戶點擊某個交易對行的「複製」按鈕，**Then** 該交易對的套利資訊按指定格式被複製到剪貼板
2. **Given** 用戶已複製一個交易對的套利資訊，**When** 用戶點擊另一個交易對的「複製」按鈕，**Then** 剪貼板內容被更新為新的交易對資訊
3. **Given** 用戶點擊複製按鈕後，**When** 用戶在任何支援貼上的應用程式中執行貼上操作，**Then** 完整的格式化套利資訊被正確貼上

---

### User Story 2 - 即時視覺反饋 (Priority: P2)

用戶點擊複製按鈕後需要清楚的視覺確認來知道操作是否成功，避免重複點擊或不確定是否已複製。

**Why this priority**: 良好的用戶體驗需要即時反饋，但這不影響核心功能的運作。即使沒有視覺反饋，複製功能本身仍然可用。

**Independent Test**: 可以透過點擊複製按鈕並觀察按鈕圖標或文字是否變化（如顯示✓符號）持續 2 秒來獨立測試。

**Acceptance Scenarios**:

1. **Given** 用戶點擊複製按鈕且複製成功，**When** 操作完成後，**Then** 按鈕圖標從「複製」圖標變為「✓」圖標持續 2 秒
2. **Given** 複製成功反饋正在顯示（✓圖標），**When** 2 秒經過後，**Then** 按鈕圖標恢復為原始的「複製」圖標
3. **Given** 用戶在視覺反饋期間（顯示✓圖標時）再次點擊按鈕，**When** 按鈕被點擊，**Then** 複製操作再次執行並重新開始 2 秒倒數

---

### User Story 3 - 錯誤處理與用戶提示 (Priority: P3)

當複製操作因瀏覽器權限、技術問題或其他原因失敗時，用戶需要明確的錯誤訊息和可能的解決方案。

**Why this priority**: 雖然重要，但複製失敗的情況較少見（現代瀏覽器廣泛支援 Clipboard API）。核心功能和視覺反饋的優先級更高。

**Independent Test**: 可以透過在不支援 Clipboard API 的環境中測試，或模擬權限被拒絕的情況，檢查是否顯示適當的錯誤訊息。

**Acceptance Scenarios**:

1. **Given** 瀏覽器不支援 Clipboard API 或權限被拒絕，**When** 用戶點擊複製按鈕，**Then** 系統顯示錯誤訊息「無法複製到剪貼板，請檢查瀏覽器權限」
2. **Given** 複製操作失敗，**When** 錯誤發生後，**Then** 按鈕保持可點擊狀態讓用戶可以重試
3. **Given** 用戶看到錯誤訊息，**When** 用戶修正問題（如授予權限）後再次點擊，**Then** 複製操作成功執行

---

### Edge Cases

- 當交易對沒有最佳套利配對資訊（bestPair 為 null）時會發生什麼？
  - 系統應該禁用複製按鈕或顯示提示訊息
- 當交易對的價差或資費差數值為負數或異常值時如何處理？
  - 系統應該將異常值格式化為「N/A」或顯示警告標記
- 當用戶快速連續點擊多個不同交易對的複製按鈕時如何處理？
  - 每次點擊應該獨立處理，最後一次點擊的內容覆蓋剪貼板
- 當瀏覽器處於不安全上下文（非 HTTPS）時 Clipboard API 可能不可用如何處理？
  - 顯示錯誤訊息並提供 fallback 方案（如顯示可手動複製的文字框）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須在市場監控頁面的每一行交易對右側顯示「複製」按鈕
- **FR-002**: 系統必須在用戶點擊「複製」按鈕時，將該交易對的套利資訊按指定格式寫入系統剪貼板
- **FR-003**: 複製的套利資訊必須包含以下內容：
  - 交易對名稱（格式化為 SYMBOL/USDT，如 BTC/USDT）
  - 做多交易所名稱（大寫，如 BINANCE、GATE、MEXC、OKX）
  - 做空交易所名稱（大寫，如 BINANCE、GATE、MEXC、OKX）
  - 價差百分比（以範圍顯示，如「約 5-7%」）
  - 資費差百分比（以範圍顯示，如「約 3%」）
  - 固定的下單小提醒文字
  - 固定的風險提醒文字
- **FR-004**: 系統必須在複製成功後提供視覺反饋（按鈕圖標變為✓持續 2 秒）
- **FR-005**: 系統必須在複製失敗時顯示錯誤訊息給用戶
- **FR-006**: 複製按鈕必須僅對有最佳套利配對資訊（bestPair 存在）的交易對啟用
- **FR-007**: 價差和資費差的範圍估值必須基於當前值計算（±20% 波動範圍，四捨五入到整數百分比）
- **FR-008**: 複製的文字格式必須包含適當的分隔線、emoji 圖標和縮排，以確保可讀性

### 複製格式範例

```
=======
【套套摳訊】

📌
BTC/USDT
做多：BINANCE（交易所）
做空：OKX（交易所）

📈 目前利潤預估：
 • 目前價差：約 5-7%
 • 目前資費差：約 3%

🧾 下單小提醒：
 • 請使用全倉 + 低倍槓桿（最多 2～3 倍）
 • 兩邊市價一起敲，兩邊顆數要一樣

🚨 風險提醒：
 • 資費有時會亂跳，要再注意觀察
=======
```

### Key Entities *(include if feature involves data)*

- **MarketRate**: 代表單一交易對的完整市場資料，包含：
  - symbol: 交易對符號
  - exchanges: 各交易所的費率和價格資料
  - bestPair: 最佳套利配對資訊
  - status: 機會狀態（opportunity/approaching/normal）
  - timestamp: 資料時間戳

- **BestArbitragePair**: 代表最佳套利配對，包含：
  - longExchange: 做多的交易所
  - shortExchange: 做空的交易所
  - spreadPercent: 費率差百分比
  - annualizedReturn: 年化收益
  - priceDiffPercent: 價差百分比

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用戶可以在 1 秒內完成複製套利資訊的操作（從點擊按鈕到剪貼板更新）
- **SC-002**: 複製的文字格式在各種常見應用程式（記事本、Excel、通訊軟體）中貼上時保持正確的格式和可讀性
- **SC-003**: 95% 的複製操作在現代瀏覽器（Chrome 90+、Firefox 88+、Safari 14+、Edge 90+）中成功執行
- **SC-004**: 用戶在點擊複製按鈕後 500 毫秒內看到視覺反饋（✓圖標）
- **SC-005**: 當複製失敗時，100% 的情況下用戶會看到明確的錯誤訊息

## Assumptions

1. **瀏覽器支援**: 假設用戶使用支援 Clipboard API 的現代瀏覽器（Chrome 63+、Firefox 53+、Safari 13.1+、Edge 79+）
2. **HTTPS 環境**: 假設應用程式在 HTTPS 環境中運行，因為 Clipboard API 在不安全上下文中受限
3. **固定文字內容**: 下單小提醒和風險提醒的文字內容在所有交易對中保持一致，不根據交易所或交易對動態變化
4. **範圍估值演算法**: 價差的範圍估值採用當前值 ±20% 的波動範圍，並四捨五入到整數百分比
5. **按鈕位置**: 複製按鈕將放置在「快速開倉」按鈕旁邊，不會影響現有的表格佈局
6. **不包含限倉資訊**: 第一版本不包含交易所限倉限制資訊，該功能可在後續版本中添加

## Out of Scope

以下功能明確不在本次實施範圍內：

1. **交易所限倉限制顯示**: 不顯示具體的限倉數量或金額
2. **自訂格式範本**: 用戶無法自訂複製的文字格式或內容
3. **歷史複製記錄**: 不保存用戶的複製歷史記錄
4. **批量複製**: 不支援一次複製多個交易對的套利資訊
5. **自動分享功能**: 不包含直接分享到特定平台（如 Telegram、Discord）的功能
6. **動態下單建議**: 下單小提醒不會根據交易所特性動態調整
