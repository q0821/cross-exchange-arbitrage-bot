# Feature Specification: 停損停利觸發偵測與自動平倉

**Feature Branch**: `050-sl-tp-trigger-monitor`
**Created**: 2025-12-29
**Status**: Draft
**Input**: 停損停利觸發偵測與自動平倉功能。當交易所的停損或停利單被觸發時：(1) 偵測觸發事件 (2) 自動平倉另一邊 (3) 發送通知 (4) 更新持倉狀態

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 條件單觸發自動偵測 (Priority: P1)

用戶開倉後設定了停損停利單，當市場價格觸及停損或停利價格時，交易所會自動執行條件單。系統需要能夠偵測到這個觸發事件，避免用戶的持倉狀態與實際交易所狀態不同步。

**Why this priority**: 這是整個功能的基礎。如果無法偵測觸發事件，後續的自動平倉和通知都無法進行。目前系統缺少此功能，導致觸發後用戶仍看到「進行中」的持倉。

**Independent Test**: 可以透過手動在交易所觸發一個條件單，然後觀察系統是否能在 30 秒內偵測到該觸發事件。

**Acceptance Scenarios**:

1. **Given** 用戶有一個 ACTIVE 狀態的持倉，且已設定停損停利單，**When** 交易所的停損單被觸發執行，**Then** 系統在 30 秒內偵測到觸發事件
2. **Given** 用戶有一個 ACTIVE 狀態的持倉，且已設定停損停利單，**When** 交易所的停利單被觸發執行，**Then** 系統在 30 秒內偵測到觸發事件
3. **Given** 系統正在監控多個用戶的持倉，**When** 其中一個用戶的條件單被觸發，**Then** 只有該用戶的持倉被標記為觸發，其他用戶不受影響

---

### User Story 2 - 觸發後自動平倉對沖倉位 (Priority: P1)

當一邊的停損或停利被觸發後，另一邊的倉位仍然開著，形成單邊暴露風險。系統需要自動平倉另一邊，以保護用戶免受額外損失。

**Why this priority**: 與 P1 同等重要。單邊暴露可能導致用戶遭受比預期更大的損失，必須盡快處理。

**Independent Test**: 可以透過觸發一邊的條件單，觀察系統是否自動平倉另一邊，並驗證兩邊都已關閉。

**Acceptance Scenarios**:

1. **Given** 多方停損被觸發（Binance），**When** 系統偵測到觸發事件，**Then** 系統自動平倉空方（OKX）並取消空方的剩餘條件單
2. **Given** 空方停利被觸發（Gate.io），**When** 系統偵測到觸發事件，**Then** 系統自動平倉多方（BingX）並取消多方的剩餘條件單
3. **Given** 系統嘗試自動平倉但失敗，**When** 平倉操作返回錯誤，**Then** 系統記錄錯誤並通知用戶手動處理

---

### User Story 3 - 觸發通知 (Priority: P2)

當停損或停利被觸發時，用戶需要收到即時通知，了解發生了什麼事以及系統如何處理。

**Why this priority**: 通知是用戶體驗的重要部分，但不影響核心的風險控制功能。即使沒有通知，自動平倉仍會執行。

**Independent Test**: 可以透過觸發條件單，觀察用戶是否在設定的通知頻道收到訊息。

**Acceptance Scenarios**:

1. **Given** 用戶已設定 Discord 通知，**When** 停損被觸發且自動平倉成功，**Then** 用戶收到包含交易對、觸發類型、損益資訊的通知
2. **Given** 用戶已設定 Slack 通知，**When** 停利被觸發且自動平倉成功，**Then** 用戶收到包含交易對、觸發類型、損益資訊的通知
3. **Given** 用戶未設定任何通知頻道，**When** 條件單被觸發，**Then** 系統仍正常執行自動平倉，只是不發送通知

---

### User Story 4 - 持倉狀態更新與歷史記錄 (Priority: P2)

觸發事件發生後，系統需要更新持倉狀態為 CLOSED，並記錄平倉原因（停損觸發或停利觸發），以便用戶查看歷史記錄。

**Why this priority**: 記錄對於用戶分析交易績效很重要，但不影響即時風險控制。

**Independent Test**: 可以透過觸發條件單後，檢查持倉狀態和交易記錄是否正確更新。

**Acceptance Scenarios**:

1. **Given** 多方停損被觸發，**When** 自動平倉完成，**Then** 持倉狀態更新為 CLOSED，平倉原因記錄為「多方停損觸發」
2. **Given** 空方停利被觸發，**When** 自動平倉完成，**Then** 持倉狀態更新為 CLOSED，平倉原因記錄為「空方停利觸發」
3. **Given** 持倉已因觸發而關閉，**When** 用戶查看交易歷史，**Then** 可以看到該筆交易的平倉原因和損益

---

### Edge Cases

- **雙邊同時觸發**: 當市場劇烈波動時，多方和空方的條件單可能在同一輪詢週期內都被觸發。系統偵測邏輯：
  1. 發現條件單不存在時，查詢該交易所的訂單歷史
  2. 確認條件單是「已成交/觸發」還是「已取消」
  3. 如果雙邊都是觸發，記錄為「雙邊觸發」，不需要自動平倉（已被交易所平倉）
  4. 正確計算雙邊的損益並記錄
- **條件單消失但非觸發**: 條件單可能因為以下原因消失：
  1. **觸發成交**: 價格觸及條件價，訂單執行 → 查詢訂單歷史確認
  2. **用戶手動取消**: 用戶在交易所 App 取消 → 查詢訂單歷史，狀態為「已取消」
  3. **系統自動取消**: 我們平倉時取消了 → 由系統記錄，不需要查詢
  4. **訂單過期**: 部分交易所條件單有有效期 → 查詢訂單歷史確認
- **網路異常**: 如果系統與交易所連線中斷，無法查詢條件單狀態，系統記錄錯誤並在下次檢查時重試
- **部分平倉**: 如果自動平倉只成功關閉部分數量，系統記錄部分平倉狀態並通知用戶手動處理剩餘
- **監控服務重啟**: 如果監控服務在觸發和平倉之間重啟，系統在重啟後繼續檢查並處理未完成的觸發事件

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須每 30 秒檢查一次所有 ACTIVE 狀態持倉的條件單狀態
- **FR-002**: 系統必須支援 Binance、OKX、Gate.io、BingX 四個交易所的條件單狀態查詢
- **FR-003**: 系統必須能夠偵測停損單和停利單的觸發事件
- **FR-004**: 當條件單不存在於待執行列表時，系統必須查詢訂單歷史以確認是「觸發成交」還是「取消」
- **FR-005**: 系統必須在偵測到單邊觸發後自動平倉另一邊的對沖倉位
- **FR-006**: 系統必須在自動平倉後取消另一邊剩餘的條件單
- **FR-007**: 當雙邊條件單同時觸發時，系統必須正確識別並記錄為「雙邊觸發」
- **FR-008**: 系統必須在觸發事件發生後發送通知給用戶（如用戶已設定通知頻道）
- **FR-009**: 系統必須更新持倉狀態為 CLOSED 並記錄平倉原因
- **FR-010**: 系統必須記錄觸發事件的損益計算結果（包含雙邊觸發的情況）
- **FR-011**: 系統必須能夠處理自動平倉失敗的情況，並通知用戶手動處理
- **FR-012**: 系統必須在應用程式啟動時自動開始監控，並在關閉時優雅停止

### Key Entities

- **Position（持倉）**: 新增 closeReason 欄位，記錄平倉原因：
  - 手動平倉 (MANUAL)
  - 多方停損觸發 (LONG_SL_TRIGGERED)
  - 多方停利觸發 (LONG_TP_TRIGGERED)
  - 空方停損觸發 (SHORT_SL_TRIGGERED)
  - 空方停利觸發 (SHORT_TP_TRIGGERED)
  - 雙邊同時觸發 (BOTH_TRIGGERED)
- **TriggerEvent（觸發事件）**: 觸發類型、觸發時間、觸發交易所、處理狀態、訂單歷史確認結果
- **Trade（交易績效）**: 現有實體，記錄因觸發而關閉的交易損益

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 系統在條件單觸發後 30 秒內偵測到觸發事件（最大延遲 = 輪詢間隔）
- **SC-002**: 觸發偵測後，另一邊倉位在 10 秒內完成自動平倉
- **SC-003**: 99% 的觸發事件能夠被正確偵測和處理（排除網路異常等不可抗力）
- **SC-004**: 用戶在觸發後 1 分鐘內收到通知（如已設定通知頻道）
- **SC-005**: 所有觸發事件都有完整的歷史記錄，包含觸發類型和損益

## Assumptions

- 系統已有現成的條件單查詢功能（ExchangeQueryService），可以重用
- 系統已有現成的平倉功能（PositionCloser），可以擴展支援單邊平倉
- 系統已有現成的通知服務（NotificationService），可以重用
- 用戶的 API Key 有足夠的權限查詢條件單狀態和執行平倉
- 輪詢間隔 30 秒是可接受的延遲，未來 Phase 2 可升級為 WebSocket 即時監聽

## Out of Scope

- WebSocket 即時監聽（Phase 2 規劃）
- 在 Web 界面顯示觸發歷史的專用頁面（可作為後續功能）
- 支援其他交易所（目前僅支援 Binance、OKX、Gate.io、BingX）
- 自訂輪詢間隔（固定 30 秒）
