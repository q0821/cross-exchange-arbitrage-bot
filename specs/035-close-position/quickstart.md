# Quickstart: 一鍵平倉功能

**Date**: 2025-12-17
**Feature**: 035-close-position

## 概述

本指南說明如何使用一鍵平倉功能關閉兩個交易所的對沖倉位。

## 前置條件

1. **已開立持倉**：至少有一個 OPEN 狀態的對沖倉位
2. **API Key 有效**：兩個交易所的 API Key 仍有效且具有交易權限
3. **網路連接**：穩定的網路連接以確保雙邊操作完成

## 使用流程

### 1. 查看持倉列表

1. 進入「持倉」頁面 (`/positions`)
2. 查看「持倉中」分類下的倉位
3. 確認要平倉的倉位狀態為「OPEN」

### 2. 點擊平倉按鈕

在持倉卡片右側點擊「平倉」按鈕，開啟平倉確認對話框。

### 3. 平倉確認對話框

```
┌─────────────────────────────────────────┐
│            平倉確認                      │
├─────────────────────────────────────────┤
│  交易對: BTCUSDT                        │
│                                         │
│  多頭 (Binance):                        │
│    開倉價: $42,000.00                   │
│    現價:   $42,150.50                   │
│    未實現損益: +$3.56                   │
│                                         │
│  空頭 (OKX):                            │
│    開倉價: $42,010.00                   │
│    現價:   $42,148.30                   │
│    未實現損益: -$3.28                   │
│                                         │
│  持倉數量: 0.0237 BTC                   │
│  持倉時間: 1 天 2 小時                   │
├─────────────────────────────────────────┤
│  預估損益:                              │
│    價差損益: +$0.28                     │
│    預估手續費: -$1.00                   │
│    淨損益: -$0.72                       │
├─────────────────────────────────────────┤
│  [ 取消 ]              [ 確認平倉 ]     │
└─────────────────────────────────────────┘
```

### 4. 平倉進度顯示

點擊「確認平倉」後，系統顯示執行進度：

```
┌─────────────────────────────────────────┐
│            平倉進行中                    │
├─────────────────────────────────────────┤
│  [████████████░░░░░░░░] 60%             │
│                                         │
│  ✓ 驗證持倉狀態完成                     │
│  ✓ 在 Binance 平倉多頭完成              │
│  → 正在 OKX 平倉空頭...                 │
│  ○ 計算損益                             │
│  ○ 完成平倉                             │
├─────────────────────────────────────────┤
│  請勿關閉此視窗                          │
└─────────────────────────────────────────┘
```

### 5. 平倉成功

```
┌─────────────────────────────────────────┐
│            ✅ 平倉成功                   │
├─────────────────────────────────────────┤
│  多頭平倉 (Binance):                    │
│    訂單號: 123456789                    │
│    成交價: $42,150.50                   │
│    手續費: $0.50                        │
│                                         │
│  空頭平倉 (OKX):                        │
│    訂單號: 987654321                    │
│    成交價: $42,148.30                   │
│    手續費: $0.49                        │
├─────────────────────────────────────────┤
│  績效摘要:                              │
│    價差損益: +$0.28                     │
│    資金費率損益: $0.00                  │
│    總損益: -$0.71                       │
│    ROI: -0.14%                          │
│    持倉時間: 26 小時 15 分              │
├─────────────────────────────────────────┤
│  [ 查看交易歷史 ]      [ 返回持倉 ]     │
└─────────────────────────────────────────┘
```

## 錯誤處理

### 持倉狀態不正確

如果倉位不是 OPEN 狀態，平倉按鈕將被禁用：

```
⚠️ 此倉位無法平倉
狀態: CLOSING（正在平倉中）
```

### 操作衝突

如果同一倉位正在執行其他操作：

```
⚠️ 操作衝突
此倉位正在執行其他操作，請稍後再試。
```

### 部分平倉（需手動處理）

如果一邊成功但另一邊失敗：

```
┌─────────────────────────────────────────┐
│      ⚠️ 需要手動處理                    │
├─────────────────────────────────────────┤
│  Binance 多頭已平倉，但 OKX 空頭失敗    │
│                                         │
│  已平倉:                                │
│    交易所: Binance                      │
│    方向: 多頭                           │
│    訂單號: 123456789                    │
│    成交價: $42,150.50                   │
│                                         │
│  失敗原因:                              │
│    OKX API 返回錯誤：Network timeout    │
│                                         │
│  請前往 OKX 手動平倉空頭倉位。          │
├─────────────────────────────────────────┤
│  [ 我知道了 ]                           │
└─────────────────────────────────────────┘
```

## API 使用示例

### 平倉 API

```bash
POST /api/positions/{id}/close
Cookie: session=xxx
```

**成功響應**:

```json
{
  "success": true,
  "position": {
    "id": "clxxx123",
    "symbol": "BTCUSDT",
    "longExchange": "binance",
    "shortExchange": "okx",
    "status": "CLOSED",
    "closedAt": "2025-12-17T10:30:00.000Z"
  },
  "trade": {
    "id": "clyyy456",
    "positionId": "clxxx123",
    "priceDiffPnL": "0.28",
    "fundingRatePnL": "0.00",
    "totalPnL": "-0.71",
    "roi": "-0.14",
    "holdingDuration": 94500
  },
  "message": "平倉成功"
}
```

### 查詢交易歷史 API

```bash
GET /api/trades?limit=10&offset=0
Cookie: session=xxx
```

**響應**:

```json
{
  "success": true,
  "data": {
    "trades": [
      {
        "id": "clyyy456",
        "positionId": "clxxx123",
        "symbol": "BTCUSDT",
        "longExchange": "binance",
        "shortExchange": "okx",
        "longEntryPrice": "42000.00",
        "longExitPrice": "42150.50",
        "shortEntryPrice": "42010.00",
        "shortExitPrice": "42148.30",
        "openedAt": "2025-12-16T08:15:00.000Z",
        "closedAt": "2025-12-17T10:30:00.000Z",
        "holdingDuration": 94500,
        "priceDiffPnL": "0.28",
        "fundingRatePnL": "0.00",
        "totalPnL": "-0.71",
        "roi": "-0.14",
        "status": "SUCCESS"
      }
    ],
    "total": 1
  }
}
```

## 常見問題

### Q: 平倉使用市價單還是限價單？

A: 使用**市價單**確保成交。市價單可能有滑點，但保證倉位能夠關閉。

### Q: 平倉過程中可以取消嗎？

A: 一旦點擊「確認平倉」，操作無法取消。請在確認前仔細檢查。

### Q: 資金費率損益為什麼是 0？

A: 當前版本簡化資金費率損益計算為 0。未來版本將從費率結算記錄中累計實際收益。

### Q: 部分平倉後如何處理？

A: 系統會標記倉位為 PARTIAL 狀態，並顯示需要手動處理的交易所和倉位資訊。請登入該交易所手動平倉。

### Q: 平倉後的績效記錄在哪裡查看？

A: 進入「交易歷史」頁面 (`/trades`)，可以查看所有已平倉交易的績效記錄，包括損益、ROI、持倉時間等。

### Q: 為什麼平倉按鈕是禁用的？

A: 可能的原因：
- 倉位狀態不是 OPEN（可能是 OPENING、CLOSING 或 PARTIAL）
- 正在執行其他操作（分散式鎖衝突）
- 載入餘額或市場數據中

### Q: 損益計算公式是什麼？

A:
```
價差損益 = (多頭平倉價 - 多頭開倉價) × 數量 + (空頭開倉價 - 空頭平倉價) × 數量
總損益 = 價差損益 + 資金費率損益 - 手續費
ROI = 總損益 / 開倉保證金 × 100%
```
