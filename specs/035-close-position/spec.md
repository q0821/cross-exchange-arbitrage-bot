# Feature Specification: 一鍵平倉功能

**Feature Branch**: `035-close-position`
**Created**: 2025-12-17
**Status**: Draft
**Input**: User description: "一鍵平倉功能：用戶可以從持倉頁面同時關閉兩個交易所的對沖倉位，並記錄歷史績效"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 一鍵平倉 (Priority: P1)

用戶在持倉頁面查看當前持有的對沖倉位，點擊「平倉」按鈕後，系統同時在兩個交易所執行平倉操作（賣出多頭、買入空頭），完成後顯示平倉結果和損益。

**Why this priority**: 這是平倉功能的核心，沒有這個功能用戶無法退出已開立的倉位，資金會被鎖定。

**Independent Test**: 用戶選擇一個 OPEN 狀態的持倉 → 點擊平倉按鈕 → 確認平倉 → 驗證兩個交易所的倉位都已關閉 → 查看損益結果

**Acceptance Scenarios**:

1. **Given** 用戶有一個 OPEN 狀態的對沖倉位, **When** 用戶點擊「平倉」按鈕並確認, **Then** 系統同時在兩個交易所執行平倉，倉位狀態變為 CLOSED，顯示平倉成功訊息和損益
2. **Given** 用戶點擊平倉按鈕, **When** 系統正在執行平倉操作, **Then** 顯示進度指示器，用戶無法重複點擊

---

### User Story 2 - 平倉失敗處理 (Priority: P1)

當一邊交易所平倉成功但另一邊失敗時，系統應標記倉位為部分平倉狀態，並提示用戶需要手動處理。

**Why this priority**: 這是保護用戶資金安全的關鍵功能，避免用戶不知道有倉位未關閉。

**Independent Test**: 模擬一個交易所 API 失敗 → 驗證系統正確標記狀態並顯示警告訊息

**Acceptance Scenarios**:

1. **Given** 用戶執行平倉操作, **When** 一邊交易所成功但另一邊失敗, **Then** 系統標記倉位為 PARTIAL 狀態，顯示明確的警告訊息，包含需要手動處理的交易所和訂單資訊
2. **Given** 倉位處於 PARTIAL 狀態, **When** 用戶查看持倉列表, **Then** 該倉位以醒目方式顯示，提示需要手動處理

---

### User Story 3 - 績效記錄與查看 (Priority: P2)

平倉完成後，系統自動計算並記錄交易績效（價差損益、資金費率收益、總損益、投資報酬率、持倉時間），用戶可以查看歷史交易績效。

**Why this priority**: 績效記錄對於用戶評估策略效果至關重要，但相較於平倉操作本身屬於次要功能。

**Independent Test**: 完成一筆平倉 → 查看該筆交易的績效記錄 → 驗證損益計算正確

**Acceptance Scenarios**:

1. **Given** 用戶成功平倉一個持倉, **When** 平倉完成, **Then** 系統自動創建 Trade 績效記錄，包含：價差損益、資金費率損益、總損益、ROI、持倉時間
2. **Given** 用戶有多筆已平倉的交易, **When** 用戶查看交易歷史頁面, **Then** 顯示所有歷史交易的績效摘要和詳情

---

### User Story 4 - 平倉確認對話框 (Priority: P2)

用戶點擊平倉按鈕後，顯示確認對話框，展示當前市場價格、預估損益，讓用戶確認後再執行平倉。

**Why this priority**: 防止用戶誤操作，提供決策所需的資訊，但屬於 UX 增強功能。

**Independent Test**: 點擊平倉按鈕 → 驗證對話框顯示正確的市場價格和預估損益 → 取消或確認

**Acceptance Scenarios**:

1. **Given** 用戶點擊持倉的「平倉」按鈕, **When** 對話框開啟, **Then** 顯示當前兩個交易所的市價、預估價差損益、預估手續費
2. **Given** 用戶查看平倉確認對話框, **When** 用戶點擊「取消」, **Then** 關閉對話框，不執行任何操作

---

### User Story 5 - 平倉進度即時更新 (Priority: P3)

平倉過程中透過 WebSocket 即時推送進度更新，讓用戶了解當前執行狀態。

**Why this priority**: 提升用戶體驗，但平倉操作通常很快完成，屬於錦上添花功能。

**Independent Test**: 執行平倉操作 → 觀察進度更新是否即時顯示

**Acceptance Scenarios**:

1. **Given** 用戶確認平倉操作, **When** 系統正在執行, **Then** 即時顯示各階段進度：驗證中 → 平倉多頭 → 平倉空頭 → 完成

---

### Edge Cases

- 當用戶網路中斷時，平倉操作如何處理？系統應使用分散式鎖確保操作不會重複執行
- 當兩個交易所價格劇烈波動時，如何處理？使用市價單確保成交，滑點由用戶承擔
- 當倉位狀態不是 OPEN（如 OPENING、PARTIAL）時，平倉按鈕應禁用並顯示原因
- 當同一用戶同時在多個裝置嘗試平倉時，分散式鎖應阻止並發操作

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統 MUST 提供一鍵平倉功能，同時在兩個交易所執行平倉操作
- **FR-002**: 系統 MUST 使用分散式鎖防止同一倉位的並發平倉操作
- **FR-003**: 系統 MUST 在平倉前驗證倉位狀態為 OPEN
- **FR-004**: 系統 MUST 在平倉過程中將倉位狀態更新為 CLOSING
- **FR-005**: 系統 MUST 在雙邊都平倉成功後將狀態更新為 CLOSED
- **FR-006**: 系統 MUST 在一邊成功另一邊失敗時將狀態更新為 PARTIAL
- **FR-007**: 系統 MUST 記錄所有平倉操作的審計日誌
- **FR-008**: 系統 MUST 在平倉完成後創建 Trade 績效記錄
- **FR-009**: 系統 MUST 計算並記錄：價差損益、資金費率損益、總損益、ROI、持倉時間
- **FR-010**: 用戶 MUST 能夠查看歷史交易績效列表
- **FR-011**: 系統 MUST 在平倉確認對話框中顯示當前市場價格
- **FR-012**: 系統 MUST 在對話框中顯示預估損益和預估手續費
- **FR-013**: 系統 MUST 透過 WebSocket 推送平倉進度更新
- **FR-014**: 系統 MUST 在 PARTIAL 狀態時顯示需要手動處理的詳細資訊

### Key Entities

- **Position**: 對沖倉位記錄，包含雙邊交易所資訊、狀態、開倉價格和時間
- **Trade**: 績效記錄，包含開/平倉價格、損益計算、持倉時間、ROI
- **AuditLog**: 審計日誌，記錄所有平倉相關操作

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用戶可以在 10 秒內完成從點擊平倉按鈕到看到結果的整個流程
- **SC-002**: 雙邊平倉操作並行執行，總耗時不超過單邊操作的 1.5 倍
- **SC-003**: 平倉失敗時 100% 正確識別並標記為 PARTIAL 狀態
- **SC-004**: 所有平倉操作 100% 記錄審計日誌
- **SC-005**: 績效計算準確度達到 99.9%（與手動計算結果一致）
- **SC-006**: 用戶首次使用平倉功能的成功率達到 95%（無需查看說明文件）

## Assumptions

- 用戶已有 OPEN 狀態的持倉（通過開倉功能創建）
- 用戶的交易所 API Key 仍有效且具有交易權限
- 交易所 API 可用且響應時間在合理範圍內
- 使用市價單進行平倉，確保成交但可能有滑點
- 績效計算使用實際成交價格，而非即時市場價格
- Trade 模型已存在於資料庫 schema 中（從探索結果確認）
- Position 模型已有 PARTIAL 狀態（已確認存在於 PositionWebStatus enum）
