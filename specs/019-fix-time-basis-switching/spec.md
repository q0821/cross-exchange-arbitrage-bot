# Feature Specification: 修復時間基準切換功能

**Feature Branch**: `019-fix-time-basis-switching`
**Created**: 2025-01-19
**Status**: Draft
**Input**: User description: "修復 Web 應用中時間基準切換功能的三個關鍵問題：1) WebSocket handler 不支援 4 小時時間基準（前端已支援但後端只接受 1h/8h/24h）2) REST API 缺少標準化費率資料（normalized 和 originalInterval 欄位）3) 費率差計算錯誤：目前直接使用原始費率比較，應該根據用戶選擇的時間基準使用對應的標準化費率來計算費率差。預期行為：切換時間基準時，前端應正確顯示各交易所的標準化費率、基於標準化費率計算的費率差和年化收益。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 選擇 4 小時時間基準 (Priority: P1)

交易者需要能夠選擇 4 小時作為費率標準化的時間基準，以便與某些交易所的原生資金費率週期一致，從而更直觀地比較不同交易所的費率。

**Why this priority**: 這是最關鍵的錯誤修復，因為前端已經提供了 4 小時選項，但後端不支援，導致功能完全失效。這會造成用戶困惑和不良體驗。

**Independent Test**: 可以透過在前端選擇 4 小時時間基準，驗證 WebSocket 連線不會拒絕請求，且能正確接收資料來獨立測試。

**Acceptance Scenarios**:

1. **Given** 用戶已登入市場監控頁面，**When** 用戶點擊時間基準選擇器並選擇「4 小時」，**Then** WebSocket 不會返回錯誤訊息，時間基準選擇器顯示「4 小時」為選中狀態
2. **Given** 用戶已選擇 4 小時時間基準，**When** WebSocket 推送費率更新，**Then** 前端正確接收並顯示基於 4 小時標準化的費率資料

---

### User Story 2 - 查看完整的標準化費率資訊 (Priority: P2)

交易者需要在頁面重新載入後，仍能看到完整的標準化費率資訊（包含原始費率、標準化費率和原始結算週期），以便理解費率的轉換過程和來源。

**Why this priority**: REST API 是頁面初始載入的資料來源，缺少標準化費率資料會導致頁面重新載入後無法正確顯示，影響用戶體驗的連續性。

**Independent Test**: 可以透過刷新頁面，檢查是否能看到各交易所的標準化費率和原始週期資訊來獨立測試。

**Acceptance Scenarios**:

1. **Given** 用戶已選擇特定時間基準（如 8 小時），**When** 用戶刷新頁面，**Then** 頁面重新載入後顯示的費率資料包含標準化費率和原始週期資訊
2. **Given** 某交易所的原始費率週期與選擇的時間基準不同，**When** 頁面載入完成，**Then** 該交易所的費率顯示為標準化後的值，並有視覺指示（如底線或 tooltip）說明已標準化

---

### User Story 3 - 查看基於時間基準的正確費率差 (Priority: P1)

交易者需要看到基於所選時間基準計算的費率差和年化收益，以便準確評估套利機會的實際價值。不同時間基準下的費率差應該反映標準化後的真實差異。

**Why this priority**: 這是核心業務邏輯錯誤，直接影響交易決策的準確性。使用原始費率比較會導致錯誤的套利機會判斷，可能造成財務損失。

**Independent Test**: 可以透過選擇不同時間基準，驗證費率差和年化收益是否相應變化來獨立測試。例如，當兩個交易所的原始週期不同時，切換時間基準應該會改變費率差的數值。

**Acceptance Scenarios**:

1. **Given** Binance 資金費率為 0.01%（8 小時週期）且 OKX 為 0.005%（4 小時週期），**When** 用戶選擇 8 小時時間基準，**Then** 系統顯示的費率差應基於 Binance 的 0.01% 和 OKX 標準化為 8 小時的費率（0.01%）進行計算，費率差接近 0%
2. **Given** Binance 資金費率為 0.01%（8 小時週期）且 OKX 為 0.005%（4 小時週期），**When** 用戶選擇 4 小時時間基準，**Then** 系統顯示的費率差應基於 Binance 標準化為 4 小時的費率（0.005%）和 OKX 的 0.005% 進行計算，費率差接近 0%
3. **Given** 用戶正在查看某交易對的費率差，**When** 用戶切換時間基準從 8 小時到 1 小時，**Then** 費率差和年化收益的數值會相應更新以反映新的時間基準

---

### Edge Cases

- 當某交易所的原始費率週期資訊缺失時，系統如何處理標準化？（假設預設週期為 8 小時）
- 當用戶快速切換時間基準時，如何避免資料競態條件（race condition）導致顯示不一致？
- 當 WebSocket 斷線重連後，如何確保時間基準偏好被正確恢復？
- 當標準化計算失敗時，系統應如何降級處理（顯示原始費率並標註警告）？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: WebSocket handler 必須接受 1h, 4h, 8h, 24h 四種時間基準值
- **FR-002**: WebSocket 必須在客戶端連線時記住並應用客戶端設定的時間基準偏好
- **FR-003**: REST API 必須在回傳的費率資料中包含 normalized 欄位（包含 1h, 4h, 8h, 24h 四個版本的標準化費率）
- **FR-004**: REST API 必須在回傳的費率資料中包含 originalInterval 欄位（表示該交易所的原始資金費率結算週期）
- **FR-005**: 系統必須根據用戶選擇的時間基準，使用對應版本的標準化費率來計算費率差
- **FR-006**: 費率差計算函數必須接收時間基準參數，並從 ExchangeRateData 中提取對應的標準化費率進行比較
- **FR-007**: 年化收益計算必須基於標準化後的費率差，而非原始費率差
- **FR-008**: 當原始費率週期與選擇的時間基準相同時，系統可以直接使用原始費率而無需標準化計算
- **FR-009**: 前端必須在切換時間基準時，觸發 WebSocket 事件通知後端更新偏好
- **FR-010**: 前端必須在接收到新的費率資料時，根據當前時間基準選擇對應的標準化費率進行顯示

### Key Entities

- **標準化費率 (Normalized Rate)**: 將不同交易所的原始資金費率轉換為統一時間基準後的費率值，包含 1h, 4h, 8h, 24h 四個版本
- **時間基準 (Time Basis)**: 用戶選擇的費率標準化參考週期，可選值為 1, 4, 8, 24（小時）
- **原始週期 (Original Interval)**: 交易所原生的資金費率結算週期（例如 Binance 為 8 小時，OKX 某些合約為 4 小時）
- **費率差 (Rate Spread)**: 兩個交易所之間標準化費率的差異，用於評估套利機會

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用戶可以成功選擇任何時間基準（1h, 4h, 8h, 24h）而不會收到系統錯誤訊息
- **SC-002**: 當用戶切換時間基準時，頁面上顯示的費率差在 500 毫秒內更新以反映新的時間基準
- **SC-003**: 頁面刷新後，用戶仍能看到完整的標準化費率資訊（包含 normalized 和 originalInterval 欄位），資料完整性達 100%
- **SC-004**: 對於原始週期不同的交易所（例如 Binance 8h vs OKX 4h），切換時間基準時費率差會正確變化，與手動計算的誤差在 0.0001% 以內
- **SC-005**: 系統能夠正確處理至少 100 個交易對在不同時間基準下的費率差計算，無計算錯誤或性能降級

## Assumptions

- 後端已經實作了 FundingRateNormalizer 服務，能夠計算所有四種時間基準的標準化費率
- 前端 TimeBasisSelector 元件已經正確實作並顯示所有四個選項
- ExchangeRateData 型別已經定義了 normalized 和 originalInterval 欄位結構
- 資金費率標準化的數學公式已經驗證為正確（rate × originalInterval / targetInterval）
- 預設時間基準為 8 小時（與大多數交易所的原生週期一致）
