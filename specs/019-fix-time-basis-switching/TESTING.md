# Feature 019: 時間基準切換測試清單

## 功能描述
前端動態計算費率差異,根據使用者選擇的時間基準 (1h/4h/8h/24h) 即時重新計算最佳套利對。

## 單元測試狀態
✅ **已完成** - 所有 8 個測試通過
- ✓ 8 小時基準的利差計算
- ✓ 1 小時基準的利差計算
- ✓ 24 小時基準的利差計算
- ✓ 無標準化費率時使用原始費率
- ✓ 單一交易所時返回 null
- ✓ 4 個交易所中找出最佳套利對
- ✓ 利差 >= 0.5% 時狀態為 'opportunity'
- ✓ 利差 >= 0.4% 且 < 0.5% 時狀態為 'approaching'

執行指令:
```bash
pnpm test tests/unit/frontend/rateCalculations.test.ts --run
```

## 手動測試清單

### 前置條件
- [ ] 確認開發伺服器正在運行 (`pnpm dev`)
- [ ] 開啟瀏覽器前往 http://localhost:3000/market-monitor
- [ ] 開啟瀏覽器開發者工具 (F12) 查看 Console

### 測試步驟

#### 1. 初始載入測試
- [ ] 頁面正常載入,無任何錯誤
- [ ] 顯示時間基準選擇器 (預設應為 8 小時)
- [ ] 費率表格顯示正常
- [ ] Console 顯示 `[useMarketRates] Rates updated` 訊息

#### 2. 時間基準切換測試 (8h → 1h)
- [ ] 點擊 "1 小時" 按鈕
- [ ] Console 顯示 `[useMarketRates] Recalculating all rates for timeBasis: 1`
- [ ] 表格中的「利差 %」欄位數值變小 (因為 1h 基準的費率較小)
- [ ] 表格中的「年化收益 %」欄位數值保持相對穩定 (年化收益應該相似)
- [ ] 部分交易對的「套利方向」可能改變 (如果不同時間基準下最佳對不同)
- [ ] 無任何錯誤訊息

#### 3. 時間基準切換測試 (1h → 4h)
- [ ] 點擊 "4 小時" 按鈕
- [ ] Console 顯示 `[useMarketRates] Recalculating all rates for timeBasis: 4`
- [ ] 「利差 %」欄位數值增加 (4h > 1h)
- [ ] 「年化收益 %」欄位數值保持相對穩定
- [ ] 無任何錯誤訊息

#### 4. 時間基準切換測試 (4h → 8h)
- [ ] 點擊 "8 小時" 按鈕
- [ ] Console 顯示 `[useMarketRates] Recalculating all rates for timeBasis: 8`
- [ ] 「利差 %」欄位數值增加 (8h > 4h)
- [ ] 「年化收益 %」欄位數值保持相對穩定
- [ ] 無任何錯誤訊息

#### 5. 時間基準切換測試 (8h → 24h)
- [ ] 點擊 "24 小時" 按鈕
- [ ] Console 顯示 `[useMarketRates] Recalculating all rates for timeBasis: 24`
- [ ] 「利差 %」欄位數值顯著增加 (24h 基準最大)
- [ ] 「年化收益 %」欄位數值保持相對穩定
- [ ] 無任何錯誤訊息

#### 6. WebSocket 即時更新測試
- [ ] 保持在 24h 基準
- [ ] 等待 WebSocket 推送新數據 (約每 5 秒)
- [ ] Console 顯示 `[useMarketRates] Rates updated`
- [ ] 表格數據更新,但仍然使用 24h 基準計算
- [ ] 切換回 1h 基準
- [ ] 等待下一次 WebSocket 更新
- [ ] 確認數據更新後仍使用 1h 基準顯示

#### 7. localStorage 持久化測試
- [ ] 選擇 "4 小時" 基準
- [ ] 重新整理頁面 (F5)
- [ ] 頁面載入後,時間基準選擇器仍顯示 "4 小時"
- [ ] 表格數據使用 4h 基準計算

#### 8. 邊界情況測試
- [ ] 選擇不同的交易對群組 (如果有多個)
- [ ] 切換時間基準,確認過濾後的數據也正確重新計算
- [ ] 使用表格排序功能,切換時間基準後排序仍正確

#### 9. 效能測試
- [ ] 在有大量交易對的情況下 (100+ 個)
- [ ] 快速連續切換時間基準 (1h → 4h → 8h → 24h)
- [ ] 確認 UI 不會卡頓
- [ ] Console 無錯誤訊息
- [ ] 計算完成時間 < 100ms (根據 Console 時間戳)

## 預期行為

### 年化收益計算公式
```
年化收益 = 利差 × 365 × (24 / 時間基準) × 100
```

例如,利差為 0.0004 時:
- **1h 基準**: 0.00005 × 365 × 24 × 100 = 43.8%
- **4h 基準**: 0.0002 × 365 × 6 × 100 = 43.8%
- **8h 基準**: 0.0004 × 365 × 3 × 100 = 43.8%
- **24h 基準**: 0.0012 × 365 × 1 × 100 = 43.8%

**重要**: 對於同一交易對,無論選擇哪個時間基準,年化收益應該接近 (可能因為標準化計算有微小誤差)。

### 利差計算規則
1. 如果交易所的原始週期與選擇的時間基準相同,使用原始費率
2. 如果不同,使用標準化費率 (normalized.Xh)
3. 如果沒有標準化費率,回退使用原始費率

### 套利方向
- **做多交易所**: 費率較低的交易所 (收取資金費率)
- **做空交易所**: 費率較高的交易所 (支付資金費率)

## 已知問題
- 無

## 修改的檔案
- `app/(dashboard)/market-monitor/utils/rateCalculations.ts` (NEW)
- `app/(dashboard)/market-monitor/hooks/useMarketRates.ts` (MODIFIED)
- `tests/unit/frontend/rateCalculations.test.ts` (NEW)

## 實作日期
2025-11-20

## 測試者
- [ ] 姓名: __________________
- [ ] 日期: __________________
- [ ] 結果: ☐ 通過 ☐ 失敗 (備註: __________________)
