# Feature Specification: 交易所資產追蹤和歷史曲線

**Feature Branch**: `031-asset-tracking-history`
**Created**: 2025-12-11
**Status**: Draft
**Input**: User description: "交易所資產追蹤和歷史曲線功能：讓用戶查看各交易所資產餘額、持倉，並透過歷史曲線觀察套利結果趨勢"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看即時資產總覽 (Priority: P1)

作為套利交易者，我希望能在一個頁面上看到我在各個交易所的總資產（以 USD 計），這樣我可以快速了解我目前的資金分佈狀況。

**Why this priority**: 這是最核心的功能，用戶需要先能看到當前資產，才能進一步觀察歷史趨勢。沒有即時資產查詢，其他功能都沒有意義。

**Independent Test**: 可以透過登入後訪問資產頁面，確認各交易所餘額正確顯示來獨立測試。交付價值：用戶立即知道自己在各交易所有多少資金。

**Acceptance Scenarios**:

1. **Given** 用戶已綁定至少一個交易所的 API Key，**When** 用戶進入資產總覽頁面，**Then** 系統顯示該交易所的總資產（USD）和連線狀態
2. **Given** 用戶綁定了多個交易所的 API Key，**When** 用戶進入資產總覽頁面，**Then** 系統顯示所有已綁定交易所的資產和總計金額
3. **Given** 用戶未綁定任何 API Key，**When** 用戶進入資產總覽頁面，**Then** 系統顯示提示訊息引導用戶前往設定 API Key

---

### User Story 2 - 查看資產歷史曲線 (Priority: P1)

作為套利交易者，我希望能看到過去 30 天的資產變化曲線圖，包括各別交易所和總資產的趨勢，這樣我可以評估我的套利策略是否有效地讓資產增長。

**Why this priority**: 這是用戶的核心需求，能夠視覺化呈現套利結果的趨勢，是判斷策略成效的關鍵。

**Independent Test**: 可以透過查看歷史曲線圖，確認資料正確呈現、時間範圍可選擇、各交易所曲線可辨識來獨立測試。

**Acceptance Scenarios**:

1. **Given** 系統已有用戶的歷史資產快照，**When** 用戶查看歷史曲線，**Then** 系統顯示總資產的趨勢曲線
2. **Given** 用戶有多個交易所的資產快照，**When** 用戶查看歷史曲線，**Then** 系統可同時顯示各交易所個別的曲線和總合曲線
3. **Given** 用戶想查看不同時間範圍，**When** 用戶選擇 7 天 / 14 天 / 30 天，**Then** 曲線圖相應更新顯示所選範圍的資料

---

### User Story 3 - 自動記錄資產快照 (Priority: P1)

作為系統，需要每小時自動記錄所有用戶的資產快照，這樣用戶才有歷史資料可以查看曲線。

**Why this priority**: 沒有自動記錄機制，就不會有歷史資料，曲線功能無法運作。這是基礎設施層的必要功能。

**Independent Test**: 可以透過等待一小時後確認資料庫有新增快照記錄，或手動觸發快照任務來測試。

**Acceptance Scenarios**:

1. **Given** 用戶有綁定至少一個有效的 API Key，**When** 系統執行每小時的排程任務，**Then** 系統為該用戶建立一筆資產快照記錄
2. **Given** 某交易所 API 暫時無法連線，**When** 系統執行快照任務，**Then** 該交易所的餘額記錄為空，狀態標記為錯誤，但不影響其他交易所的記錄
3. **Given** 資產快照資料超過 30 天，**When** 系統執行清理任務，**Then** 過期的快照記錄被自動刪除

---

### User Story 4 - 查看當前持倉 (Priority: P2)

作為套利交易者，我希望能看到我在各交易所的當前持倉（期貨倉位），包括幣種、方向、數量和未實現損益，這樣我可以掌握目前的倉位狀況。

**Why this priority**: 持倉資訊是重要的補充功能，但不是觀察套利趨勢的核心。用戶可以先透過資產總覽了解整體狀況，持倉細節是進階需求。

**Independent Test**: 可以透過在交易所開倉後，確認系統顯示正確的持倉資訊來獨立測試。

**Acceptance Scenarios**:

1. **Given** 用戶在某交易所有開啟的期貨倉位，**When** 用戶查看持倉列表，**Then** 系統顯示該倉位的幣種、方向、數量、開倉價、當前價、未實現損益
2. **Given** 用戶沒有任何開啟的倉位，**When** 用戶查看持倉列表，**Then** 系統顯示「目前無持倉」的提示
3. **Given** 用戶在多個交易所都有倉位，**When** 用戶查看持倉列表，**Then** 系統顯示所有交易所的倉位，並標示所屬交易所

---

### User Story 5 - 手動刷新資產 (Priority: P2)

作為用戶，我希望能手動刷新資產資料，這樣我可以在需要時獲取最新的餘額資訊，而不用等待下一次自動快照。

**Why this priority**: 自動快照每小時一次，用戶可能想立即查看最新資料。這是提升使用體驗的功能。

**Independent Test**: 可以透過點擊刷新按鈕，確認資料更新來獨立測試。

**Acceptance Scenarios**:

1. **Given** 用戶在資產總覽頁面，**When** 用戶點擊刷新按鈕，**Then** 系統重新查詢各交易所餘額並更新顯示
2. **Given** 用戶短時間內多次點擊刷新，**When** 點擊頻率過高，**Then** 系統顯示提示訊息要求稍後再試（避免超出交易所 API 限制）

---

### Edge Cases

- 當用戶的 API Key 已失效或被撤銷時，系統應顯示明確的錯誤訊息並建議重新設定
- 當交易所 API 回應緩慢或超時時，系統應在合理時間內顯示部分結果，並標示哪些交易所尚未回應
- 當用戶在系統運作中途新增 API Key 時，下一次排程任務應包含新交易所的資產快照
- 當用戶刪除 API Key 時，歷史快照資料應保留（但該交易所不再有新的快照）
- 當所有交易所都無法連線時，應顯示友善的錯誤頁面而非空白或崩潰

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統 MUST 支援查詢 Binance、OKX、MEXC、Gate.io 四個交易所的帳戶資產
- **FR-002**: 系統 MUST 將各幣種餘額換算為 USD 等值顯示
- **FR-003**: 系統 MUST 每小時自動為所有有效用戶建立資產快照
- **FR-004**: 系統 MUST 保留最近 30 天的資產快照記錄，並自動清理過期資料
- **FR-005**: 系統 MUST 提供歷史資產曲線圖，支援 7 天、14 天、30 天的時間範圍選擇
- **FR-006**: 系統 MUST 在曲線圖中同時顯示各交易所個別曲線和總資產曲線
- **FR-007**: 系統 MUST 查詢並顯示用戶在各交易所的期貨持倉資訊
- **FR-008**: 系統 MUST 記錄每次快照時各交易所的連線狀態（成功/失敗/無 API Key）
- **FR-009**: 用戶 MUST 能夠手動觸發資產刷新
- **FR-010**: 系統 MUST 對手動刷新進行頻率限制，避免超出交易所 API 限制

### Key Entities

- **AssetSnapshot（資產快照）**: 記錄某一時間點用戶在各交易所的總資產（USD），包含各交易所個別餘額、總計餘額、各交易所連線狀態、記錄時間
- **Position（持倉）**: 即時查詢的持倉資訊，包含交易所、幣種、方向（多/空）、數量、開倉價、當前價、未實現損益、槓桿倍數

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用戶能在 5 秒內看到所有已綁定交易所的當前資產總覽
- **SC-002**: 系統每小時產生的資產快照成功率達 95% 以上（以成功記錄至少一個交易所餘額為準）
- **SC-003**: 歷史曲線圖能在 3 秒內載入並顯示 30 天的資料
- **SC-004**: 用戶能清楚識別資產是增長還是減少的趨勢（曲線圖使用顏色區分漲跌）
- **SC-005**: 當交易所 API 發生錯誤時，用戶能在頁面上看到明確的錯誤說明和建議操作
- **SC-006**: 系統支援同時處理 100 個用戶的每小時快照任務，不發生超時或遺漏

## Assumptions

- 用戶已經在系統中設定了交易所的 API Key（透過現有的 API Key 管理功能）
- 交易所 API 的呼叫配額足夠支援每小時查詢所有用戶的餘額
- 用戶主要關注 USD 等值的總資產，不需要各幣種的詳細明細
- 歷史資料保留 30 天足夠用戶觀察套利趨勢
- 每小時記錄一次快照的頻率足夠精確地呈現資產變化趨勢
