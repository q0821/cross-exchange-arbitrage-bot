# Feature Specification: 分單持倉合併顯示與批量平倉

**Feature Branch**: `069-position-group-close`
**Created**: 2026-01-25
**Status**: Draft
**Input**: 分單開倉持倉合併顯示與批量平倉功能：目前分單開倉會創建多個獨立的 Position 記錄，平倉時需要一個一個操作很麻煩。希望改成：1) 分單開倉後在前端 UI 合併顯示成一個「組合持倉」2) 顯示合併後的平均開倉價格、總數量、資金費率等 3) 能一鍵平倉所有相關持倉並關閉對應的條件單。需要考慮向後相容性，現有的單一持倉也要能正常顯示和操作。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 組合持倉合併顯示 (Priority: P1)

用戶使用分單開倉功能開了 5 組持倉後，進入持倉列表頁面，看到的是一個「組合持倉」卡片，而不是 5 個獨立的持倉卡片。卡片上顯示合併後的總數量、平均開倉價格、以及組內持倉數量（如「5 組」）。用戶可以展開查看各組的詳細資訊。

**Why this priority**: 這是核心用戶體驗改進，解決持倉列表過於冗長的問題，是後續批量平倉功能的基礎。

**Independent Test**: 可以透過分單開倉後查看持倉列表來驗證，確認多個持倉合併顯示為一個組合卡片。

**Acceptance Scenarios**:

1. **Given** 用戶已使用分單開倉功能開了 3 組 BTCUSDT 持倉（Binance 做多、OKX 做空），**When** 用戶進入持倉列表頁面，**Then** 看到一個組合持倉卡片，顯示「3 組」、總數量為三組數量之和、平均開倉價格
2. **Given** 用戶有一個組合持倉（3 組），**When** 用戶點擊展開按鈕，**Then** 顯示各組的獨立資訊（數量、開倉價格、停損停利設定）
3. **Given** 用戶有多個不同交易對的組合持倉，**When** 用戶查看持倉列表，**Then** 每個交易對的組合獨立顯示，不會混合

---

### User Story 2 - 批量一鍵平倉 (Priority: P1)

用戶想要平倉一個組合持倉（包含 5 組獨立持倉），點擊「全部平倉」按鈕，系統一次性平倉所有組內的持倉，並自動取消所有相關的停損停利條件單。用戶只需確認一次，不需要對每組單獨操作。

**Why this priority**: 這是用戶最迫切需要的功能，大幅減少操作次數，提升交易效率。

**Independent Test**: 可以透過對組合持倉執行「全部平倉」操作來驗證，確認所有組內持倉都被平倉且條件單都被取消。

**Acceptance Scenarios**:

1. **Given** 用戶有一個組合持倉（3 組），每組都設有停損停利，**When** 用戶點擊「全部平倉」並確認，**Then** 系統依序平倉所有 3 組持倉，並取消所有 6 個條件單（每組 2 個）
2. **Given** 用戶正在執行批量平倉，**When** 平倉過程中，**Then** 顯示進度指示（如「正在平倉 2/3...」）
3. **Given** 批量平倉過程中第 2 組失敗，**When** 系統處理失敗情況，**Then** 繼續平倉剩餘組別，最終顯示部分成功結果（如「成功 2/3，失敗 1/3」）

---

### User Story 3 - 單一持倉向後相容 (Priority: P2)

用戶有些持倉是單獨開的（未使用分單功能），這些持倉應該維持原本的顯示方式和操作方式，不受組合持倉功能影響。

**Why this priority**: 確保現有功能不受影響，維護系統穩定性。

**Independent Test**: 可以透過查看非分單開倉的持倉來驗證，確認顯示和操作與之前相同。

**Acceptance Scenarios**:

1. **Given** 用戶有一個單獨開的持倉（非分單），**When** 用戶查看持倉列表，**Then** 該持倉顯示為獨立卡片，不顯示「組合」相關資訊
2. **Given** 用戶有一個單獨開的持倉，**When** 用戶平倉該持倉，**Then** 操作流程與之前完全相同

---

### User Story 4 - 組合持倉統計資訊 (Priority: P2)

用戶查看組合持倉時，能夠看到整體的資金費率收益、未實現損益等統計資訊，這些數據是基於組內所有持倉的合併計算。

**Why this priority**: 提升用戶對整體持倉狀況的掌握度，輔助投資決策。

**Independent Test**: 可以透過查看組合持倉的詳細資訊來驗證統計數據的正確性。

**Acceptance Scenarios**:

1. **Given** 用戶有一個組合持倉（3 組），各組有不同的資金費率收益，**When** 用戶查看組合持倉資訊，**Then** 顯示總資金費率收益（三組加總）
2. **Given** 用戶有一個組合持倉，**When** 用戶查看組合持倉資訊，**Then** 顯示平均開倉價格（加權平均，依數量加權）

---

### Edge Cases

- 批量平倉過程中用戶關閉頁面或斷線，系統如何處理？（假設：已發送的平倉請求繼續執行，用戶重新連線後看到最新狀態）
- 組合中部分持倉已被觸發停損/停利自動平倉，剩餘持倉如何顯示？（假設：組合持倉數量減少，顯示剩餘組數）
- 現有未使用分單功能開的多個相同交易對持倉，是否合併顯示？（假設：不合併，僅分單開倉時產生的持倉才會合併）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統 MUST 在分單開倉時為同批次的持倉分配相同的組別識別碼（groupId）
- **FR-002**: 系統 MUST 在持倉列表頁面將相同 groupId 的持倉合併顯示為一個「組合持倉」卡片
- **FR-003**: 組合持倉卡片 MUST 顯示：總數量、平均開倉價格（加權平均）、組內持倉數量
- **FR-004**: 用戶 MUST 能夠展開組合持倉查看各組的獨立資訊
- **FR-005**: 系統 MUST 提供「全部平倉」功能，一次性平倉組合內所有持倉
- **FR-006**: 批量平倉 MUST 自動取消所有相關的停損停利條件單
- **FR-007**: 批量平倉 MUST 顯示即時進度（當前組/總組數）
- **FR-008**: 批量平倉過程中若部分失敗，系統 MUST 繼續處理剩餘持倉，並在完成後顯示詳細結果
- **FR-009**: 沒有 groupId 的持倉（單獨開倉）MUST 維持原有的獨立顯示和操作方式
- **FR-010**: 組合持倉 MUST 顯示合併後的統計資訊（總資金費率收益、總未實現損益）

### Key Entities

- **Position（擴展）**: 新增 groupId 欄位，用於關聯同批次分單開倉的持倉。groupId 為可選欄位，null 表示單獨開倉的持倉。
- **PositionGroup（虛擬概念）**: 前端用於顯示的組合持倉資料結構，包含 groupId、組內持倉列表、合併統計資訊。非資料庫實體，由 API 或前端計算產生。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 分單開倉 5 組後，持倉列表從顯示 5 個卡片減少為 1 個組合卡片
- **SC-002**: 批量平倉 5 組持倉的操作步驟從 5 次減少為 1 次（一鍵操作）
- **SC-003**: 批量平倉 5 組持倉的總時間不超過 30 秒（含所有條件單取消）
- **SC-004**: 現有單獨開倉的持倉顯示和操作方式保持不變（100% 向後相容）
- **SC-005**: 組合持倉的平均開倉價格計算誤差小於 0.01%

## Assumptions

- 分單開倉時的多個持倉具有相同的 symbol、longExchange、shortExchange，這是自然成立的前提
- groupId 使用 UUID 或類似的唯一識別碼生成
- 批量平倉採用串行執行（逐一平倉），避免併發問題，但會顯示進度讓用戶知道處理狀態
- 平均開倉價格計算方式：加權平均 = Σ(各組價格 × 各組數量) / Σ(各組數量)
