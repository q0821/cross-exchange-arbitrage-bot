# Feature Specification: 年化收益門檻套利機會偵測

**Feature Branch**: `022-annualized-return-threshold`
**Created**: 2025-11-22
**Status**: Draft
**Input**: 修改套利機會偵測為年化收益門檻。將現有的固定利差門檻 (≥0.5%) 改為基於年化收益的門檻 (預設 ≥800%)，確保跨時間基準判定結果一致。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 跨時間基準一致的套利機會偵測 (Priority: P1)

作為一名套利交易者，當我在市場監控頁面切換不同的時間基準（1h/4h/8h/24h）時，我希望套利機會的偵測結果保持一致，這樣我就不會因為切換時間基準而遺漏或誤判套利機會。

**Why this priority**: 這是核心功能修正，直接影響套利機會的準確性和用戶信任度。當前固定利差門檻在不同時間基準下會產生不一致的判定結果，導致用戶困惑。

**Independent Test**: 可以透過切換時間基準並觀察同一交易對的套利機會狀態是否保持一致來獨立測試。

**Acceptance Scenarios**:

1. **Given** 一個交易對的年化收益為 850%，**When** 用戶選擇 1 小時時間基準查看，**Then** 該交易對應被標記為套利機會（狀態為 'opportunity'）
2. **Given** 同一個交易對的年化收益為 850%，**When** 用戶切換到 8 小時時間基準查看，**Then** 該交易對仍然被標記為套利機會（狀態不變）
3. **Given** 一個交易對的年化收益為 700%，**When** 用戶在任何時間基準下查看，**Then** 該交易對都不會被標記為套利機會（因為低於 800% 門檻）

---

### User Story 2 - 可配置的年化收益門檻 (Priority: P2)

作為一名系統管理員，我希望能夠透過環境變數配置套利機會的年化收益門檻，這樣我可以根據市場狀況和風險偏好調整偵測的敏感度。

**Why this priority**: 不同用戶可能有不同的風險偏好，可配置的門檻讓系統更具彈性。

**Independent Test**: 可以透過修改環境變數並重啟服務，觀察套利機會偵測門檻是否相應改變來獨立測試。

**Acceptance Scenarios**:

1. **Given** 環境變數 `OPPORTUNITY_THRESHOLD_ANNUALIZED` 設為 500，**When** 系統啟動，**Then** 年化收益 ≥500% 的交易對被標記為套利機會
2. **Given** 環境變數未設定，**When** 系統啟動，**Then** 系統使用預設值 800% 作為門檻
3. **Given** 環境變數設為無效值（如負數或非數字），**When** 系統啟動，**Then** 系統使用預設值 800% 並記錄警告日誌

---

### User Story 3 - 正確的統計數據顯示 (Priority: P2)

作為一名套利交易者，我希望市場監控頁面上的「套利機會數量」和「接近機會數量」統計能夠基於年化收益計算，這樣統計數據與實際顯示的機會狀態一致。

**Why this priority**: 統計數據應與列表顯示一致，避免用戶困惑。

**Independent Test**: 可以透過計算頁面上標記為 'opportunity' 的交易對數量，與統計卡片顯示的數字進行比對來獨立測試。

**Acceptance Scenarios**:

1. **Given** 市場上有 10 個交易對年化收益 ≥800%，**When** 用戶查看統計卡片，**Then** 「套利機會」顯示為 10
2. **Given** 市場上有 5 個交易對年化收益在 600%-799% 之間，**When** 用戶查看統計卡片，**Then** 「接近機會」顯示為 5
3. **Given** 用戶切換時間基準，**When** 統計數據重新計算，**Then** 統計數字與列表中的實際狀態一致

---

### Edge Cases

- 當年化收益剛好等於門檻值（如 800%）時，應判定為套利機會（使用 ≥ 而非 >）
- 當交易對缺少標準化費率數據時，系統應使用即時計算的標準化值進行判定
- 當環境變數門檻設為 0 時，所有有利差的交易對都應被標記為機會
- 當環境變數門檻設為極高值（如 10000%）時，幾乎不會有交易對被標記為機會

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須使用年化收益（而非固定利差）作為套利機會的判定標準
- **FR-002**: 系統必須在所有時間基準（1h/4h/8h/24h）下對同一交易對產生一致的套利機會判定結果
- **FR-003**: 系統必須支援透過環境變數 `OPPORTUNITY_THRESHOLD_ANNUALIZED` 配置年化收益門檻
- **FR-004**: 系統必須在環境變數未設定時使用預設值 800% 作為門檻
- **FR-005**: 系統必須正確處理無效的環境變數值（非數字、負數等），並回退使用預設值
- **FR-006**: 前端市場監控頁面必須使用相同的年化收益門檻邏輯進行狀態判定
- **FR-007**: 統計數據（套利機會數、接近機會數）必須與列表中的實際狀態一致
- **FR-008**: 系統必須為「接近機會」定義合理的年化收益範圍（預設為門檻的 75%-100%，即 600%-799%）

### Key Entities

- **套利機會狀態 (Opportunity Status)**: 交易對的套利狀態，可為 'opportunity'（機會）、'approaching'（接近）、'normal'（正常）
- **年化收益 (Annualized Return)**: 基於標準化利差計算的年化報酬率，公式為 `spread × 365 × (24 / timeBasis) × 100`
- **年化收益門檻 (Threshold)**: 判定套利機會的最低年化收益百分比，預設為 800%

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 同一交易對在切換時間基準（1h→4h→8h→24h）時，套利機會狀態判定結果保持 100% 一致
- **SC-002**: 統計卡片顯示的「套利機會數量」與列表中實際標記為 'opportunity' 的交易對數量完全一致
- **SC-003**: 環境變數配置的門檻值能夠在服務重啟後立即生效
- **SC-004**: 所有相關單元測試通過，覆蓋率達到 90% 以上
- **SC-005**: 前端頁面在時間基準切換時，重新計算完成時間小於 100 毫秒（對於 200 個交易對）

## Assumptions

- 年化收益計算公式已在系統中正確實作（`spread × 365 × (24 / timeBasis) × 100`）
- 標準化費率數據（normalized rates）在大多數情況下可用，缺失時系統會即時計算
- 「接近機會」的門檻範圍設為主門檻的 75%-100%（若主門檻為 800%，則接近機會範圍為 600%-799%）
