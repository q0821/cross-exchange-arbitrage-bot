# Feature Specification: ArbitrageOpportunity 即時追蹤記錄

**Feature Branch**: `065-arbitrage-opportunity-tracking`
**Created**: 2026-01-18
**Status**: Draft
**Input**: User description: "建立一個全新的 Data Model ArbitrageOpportunity 來記錄(不改變任何現有架構), 當監測到機會發生時就馬上紀錄, 首頁的套利機會歷史資料改由此紀錄提供"

## Background

目前系統的套利機會歷史記錄（`OpportunityEndHistory`）依賴於用戶設定 Webhook 通知，只有在通知成功發送後才會儲存歷史記錄。這導致：

1. 如果沒有用戶設定 Webhook，系統不會記錄任何歷史
2. 公開首頁無法顯示套利機會資料（因為資料依賴用戶）
3. 歷史資料綁定在特定用戶下，無法作為系統級公開資料

本功能將建立一個獨立的 `ArbitrageOpportunity` 資料模型，在機會發生時立即記錄，不依賴任何用戶或通知機制。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 訪客查看歷史套利機會 (Priority: P1)

作為一個未登入的訪客，我希望能在首頁看到過去發生的套利機會記錄，以了解系統監測的能力和歷史表現。

**Why this priority**: 這是公開首頁的核心功能，是吸引新用戶的關鍵，必須優先實作。

**Independent Test**: 可以透過訪問首頁並確認是否顯示歷史套利機會列表來獨立測試。即使沒有登入用戶，首頁也應該顯示資料。

**Acceptance Scenarios**:

1. **Given** 系統已偵測到並記錄了套利機會，**When** 訪客訪問首頁，**Then** 應顯示歷史套利機會列表（包含交易對、交易所、費差、持續時間等資訊）
2. **Given** 系統尚未偵測到任何套利機會，**When** 訪客訪問首頁，**Then** 應顯示「目前暫無套利機會記錄」的空狀態訊息
3. **Given** 系統有多筆歷史記錄，**When** 訪客訪問首頁，**Then** 記錄應按結束時間降序排列（最新的在最上面）

---

### User Story 2 - 即時記錄新發現的套利機會 (Priority: P1)

作為系統，當監測服務偵測到新的套利機會時，應立即將其記錄到資料庫，不需等待機會結束或用戶操作。

**Why this priority**: 這是資料來源的基礎功能，沒有即時記錄就沒有歷史資料可顯示。

**Independent Test**: 可以透過啟動監測服務、等待偵測到機會、然後查詢資料庫來驗證記錄是否已建立。

**Acceptance Scenarios**:

1. **Given** 監測服務正在運行，**When** 偵測到新的套利機會（費差 ≥ 0.5%），**Then** 系統應立即在資料庫建立一筆 `ArbitrageOpportunity` 記錄，狀態為「進行中」
2. **Given** 已記錄一個進行中的機會，**When** 該機會的費差或價格發生變化，**Then** 系統應更新該記錄的當前費差、最大費差等統計欄位
3. **Given** 相同交易對和交易所組合已有進行中的機會，**When** 再次偵測到相同機會，**Then** 系統不應建立重複記錄，而是更新現有記錄

---

### User Story 3 - 記錄套利機會結束 (Priority: P2)

作為系統，當套利機會不再符合條件時，應將該記錄標記為已結束，並計算最終統計數據。

**Why this priority**: 結束記錄對於完整的歷史追蹤很重要，但即使沒有這個功能，進行中的機會仍然可以顯示。

**Independent Test**: 可以透過製造一個機會消失的情況（費差低於閾值）來驗證記錄是否被正確標記為結束。

**Acceptance Scenarios**:

1. **Given** 有一筆進行中的套利機會記錄，**When** 該機會的費差降到閾值以下，**Then** 系統應將記錄狀態更新為「已結束」，並記錄結束時間和持續時間
2. **Given** 有一筆進行中的套利機會記錄，**When** 該機會結束，**Then** 系統應保留最終費差作為歷史參考

---

### User Story 4 - 時間範圍篩選 (Priority: P3)

作為訪客，我希望能按時間範圍篩選歷史記錄（7天、30天、90天），以查看不同時期的套利表現。

**Why this priority**: 這是增強使用體驗的功能，基本的列表顯示已能滿足需求。

**Independent Test**: 可以透過選擇不同的時間篩選選項並驗證顯示的記錄是否在指定範圍內來測試。

**Acceptance Scenarios**:

1. **Given** 系統有跨越多個時間範圍的歷史記錄，**When** 訪客選擇「7天」篩選，**Then** 只顯示過去 7 天內結束（或開始）的記錄
2. **Given** 系統有歷史記錄，**When** 訪客切換時間篩選選項，**Then** 列表應即時更新顯示對應範圍的記錄

---

### Edge Cases

- 機會在極短時間內出現又消失（< 1 分鐘）：仍應記錄，但可在顯示時標注為「閃現」
- 同時出現多個不同交易對的機會：每個交易對應獨立記錄
- 同一交易對在不同交易所組合有機會：每個交易所組合應獨立記錄
- 監測服務重啟時有進行中的機會：重啟後應能繼續追蹤或正確處理孤立記錄
- 資料庫連線暫時失敗：應有重試機制或錯誤日誌，不應影響監測服務主流程

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須建立新的 `ArbitrageOpportunity` 資料模型，獨立於現有的 `OpportunityEndHistory`
- **FR-002**: 系統必須在偵測到套利機會時立即建立記錄，不需等待用戶操作或通知
- **FR-003**: 系統必須追蹤每個機會的狀態（進行中/已結束）
- **FR-004**: 系統必須記錄機會的關鍵統計數據：初始費差、最大費差、當前/最終費差、年化報酬率
- **FR-005**: 系統必須記錄機會的時間資訊：發現時間、結束時間、持續時間
- **FR-006**: 系統必須防止相同機會（相同交易對+交易所組合）產生重複的進行中記錄
- **FR-007**: 系統必須在機會消失時將記錄狀態更新為已結束
- **FR-008**: 公開 API 必須改為從 `ArbitrageOpportunity` 獲取歷史資料，而非 `OpportunityEndHistory`
- **FR-009**: 公開首頁必須能顯示歷史套利機會，無需用戶登入或任何用戶存在
- **FR-010**: 現有的 `OpportunityEndHistory` 和相關功能必須保持不變，確保向後相容

### Key Entities

- **ArbitrageOpportunity**: 代表一次套利機會的完整生命週期記錄
  - 識別資訊：交易對符號、做多交易所、做空交易所
  - 狀態：進行中（ACTIVE）或已結束（ENDED）
  - 時間資訊：發現時間、結束時間、持續時間
  - 費差統計：初始費差、最大費差、最大費差時間、當前/最終費差
  - 報酬資訊：年化報酬率
  - 費率週期：做多/做空交易所的費率結算週期（小時）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 未登入訪客訪問首頁時，應能在 3 秒內看到歷史套利機會列表（或空狀態訊息）
- **SC-002**: 新偵測到的套利機會應在 5 秒內被記錄到資料庫
- **SC-003**: 即使系統沒有任何註冊用戶，首頁仍能正確顯示歷史套利機會資料
- **SC-004**: 機會結束後，其最終狀態應在 10 秒內被更新到資料庫
- **SC-005**: 100% 的套利機會都應被記錄，不應因缺少用戶或 Webhook 設定而遺漏

## Assumptions

1. 套利機會的判斷標準沿用現有邏輯（費差 ≥ 0.5%，價差在可接受範圍內）
2. 費率結算週期預設為 8 小時，除非交易所另有設定
3. 記錄失敗不應中斷監測服務的主流程
4. 公開 API 的速率限制和分頁邏輯維持不變
5. 此功能不影響現有用戶的 Webhook 通知和 `OpportunityEndHistory` 功能
