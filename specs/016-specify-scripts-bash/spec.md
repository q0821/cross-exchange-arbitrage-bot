# Feature Specification: 擴大交易對監控規模

**Feature Branch**: `016-specify-scripts-bash`
**Created**: 2025-11-18
**Status**: Draft
**Input**: User description: "擴大交易對監控至 100 個"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 執行腳本擴大監控清單 (Priority: P1) 🎯 MVP

作為套利交易者，我希望系統能監控更多交易對，以便發現更多套利機會。目前系統僅監控 30 個交易對，每日發現的套利機會約 5-10 個，不足以支撐有效的交易策略。

**Why this priority**: 這是核心價值所在。擴大監控範圍直接增加套利機會數量，是唯一必須完成的功能。沒有更多交易對，其他優化都沒有意義。

**Independent Test**: 執行 OI 更新腳本後，檢查 `config/symbols.json` 檔案中的 `top100_oi` 群組是否包含 100 個交易對，並且系統能成功啟動並獲取這些交易對的資金費率數據。

**Acceptance Scenarios**:

1. **Given** 系統目前監控 30 個交易對，**When** 管理員執行 `OI_TOP_N=100 pnpm update-oi-symbols` 腳本，**Then** `config/symbols.json` 中的 `top100_oi` 群組更新為包含 100 個交易對
2. **Given** 更新後的配置檔案，**When** 系統啟動資金費率監控服務，**Then** 系統成功獲取所有 100 個交易對的資金費率數據，無錯誤訊息
3. **Given** 系統正在監控 100 個交易對，**When** 用戶訪問前端市場監控頁面，**Then** 頁面顯示所有 100 個交易對的即時資金費率數據

---

### User Story 2 - 驗證交易對跨交易所可用性 (Priority: P2)

作為系統管理員，我希望確保新增的交易對在所有支援的交易所（Binance、OKX、MEXC、Gate.io）都有支援，以便系統能正確進行跨交易所套利分析。

**Why this priority**: 確保數據品質和系統穩定性。如果交易對在某些交易所不存在，會導致錯誤和無效的套利機會。這是 P1 的必要驗證步驟。

**Independent Test**: 系統啟動時自動驗證每個交易對在所有 4 個交易所的可用性，並在日誌中報告驗證結果。對於不可用的交易對，系統自動跳過或發出警告。

**Acceptance Scenarios**:

1. **Given** 配置檔案中有 100 個交易對，**When** 系統啟動時，**Then** 系統檢查每個交易對在 Binance、OKX、MEXC、Gate.io 的可用性，並在日誌中記錄結果
2. **Given** 某個交易對在某個交易所不可用，**When** 系統嘗試獲取該交易對的資金費率，**Then** 系統優雅地處理錯誤，不影響其他交易對的數據獲取
3. **Given** 所有交易對都已驗證，**When** 用戶查看系統狀態，**Then** 用戶可以看到每個交易對在各交易所的可用狀態

---

### User Story 3 - 監控系統效能和 API 使用率 (Priority: P3)

作為系統管理員，我希望能監控系統的 API 使用率和效能指標，以確保擴大監控規模後系統仍在可接受的負載範圍內運作。

**Why this priority**: 預防性監控，確保長期穩定性。雖然研究顯示 100 個交易對在技術限制內，但實際觀察可以提供信心並及早發現問題。

**Independent Test**: 系統運作 24 小時後，檢查日誌中的 API 呼叫統計和效能指標，確認沒有超過速率限制，且響應時間在可接受範圍內。

**Acceptance Scenarios**:

1. **Given** 系統正在監控 100 個交易對，**When** 系統運作一個完整的資金費率檢查週期（5 分鐘），**Then** 系統日誌顯示 API 呼叫次數和響應時間，且未觸發速率限制錯誤
2. **Given** 系統持續運作 24 小時，**When** 管理員查看效能報告，**Then** 報告顯示記憶體使用量、API 成功率、平均響應時間等指標均在正常範圍內
3. **Given** 發生 API 速率限制或效能問題，**When** 系統偵測到異常，**Then** 系統在日誌中記錄詳細錯誤資訊，並考慮降級策略（如暫時減少檢查頻率）

---

### Edge Cases

- **腳本執行失敗**：如果 OI 更新腳本因網路問題或 API 錯誤而失敗，系統應保留原有配置，不損壞現有的 30 個交易對監控
- **交易對數量不足**：如果 Binance 上符合 OI 門檻的交易對少於 100 個，腳本應回傳實際可用數量，並在日誌中說明
- **配置檔案損壞**：如果 `config/symbols.json` 在更新過程中損壞，系統應有備份機制或驗證機制，確保能回復到先前狀態
- **API 速率限制**：即使理論上在限制內，實際運作時可能因併發請求或其他服務共用 API 配額而觸發限制，系統應有重試和回退機制
- **交易對下架**：某些交易對可能在交易所下架或暫停交易，系統應能偵測並優雅處理，不影響其他交易對

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須提供腳本或命令，允許管理員更新監控的交易對清單至指定數量（100 個）
- **FR-002**: 更新過程必須基於交易對的 Open Interest (OI) 排名，選擇流動性最高的交易對
- **FR-003**: 更新後的交易對清單必須儲存在 `config/symbols.json` 檔案中，格式與現有結構一致
- **FR-004**: 系統必須驗證每個選定的交易對在 Binance、OKX、MEXC、Gate.io 四個交易所都有支援
- **FR-005**: 系統啟動時必須能讀取更新後的交易對清單，並開始監控所有列出的交易對
- **FR-006**: 資金費率監控服務必須能處理 100 個交易對的數據獲取，維持現有的 5 分鐘更新週期
- **FR-007**: 前端市場監控頁面必須能顯示所有 100 個交易對的即時資金費率數據
- **FR-008**: 系統必須記錄 API 呼叫統計（成功/失敗次數、響應時間），以便監控 API 使用率
- **FR-009**: 當某個交易對在特定交易所不可用時，系統必須跳過該交易所的數據獲取，但不影響其他交易所
- **FR-010**: 系統必須在日誌中清楚記錄更新過程的成功或失敗狀態，包括最終選定的交易對數量

### Key Entities

- **交易對 (Trading Pair)**: 表示一個可交易的永續合約，例如 BTCUSDT、ETHUSDT。關鍵屬性包括：符號名稱（symbol）、Open Interest 排名、在各交易所的可用性狀態

- **交易對清單群組 (Symbol Group)**: 表示一組預定義的交易對集合，例如 `top100_oi`（前 100 名高 OI）、`default`（預設 3 個）。關鍵屬性包括：群組名稱、包含的交易對列表、最後更新時間

- **交易所 (Exchange)**: 表示支援永續合約交易的平台，包括 Binance、OKX、MEXC、Gate.io。關鍵屬性包括：交易所名稱、API 速率限制、支援的交易對列表

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 系統成功監控 100 個交易對，從原本的 30 個增加至 100 個（333% 增長）
- **SC-002**: 每日發現的套利機會從 5-10 個增加至 15-30 個（3 倍提升）
- **SC-003**: 系統在 100 個交易對的負載下，資金費率數據獲取成功率達到 95% 以上
- **SC-004**: API 呼叫速率保持在各交易所限制的 50% 以內（例如 Binance 1200 req/min 限制，實際使用不超過 600 req/min）
- **SC-005**: 系統記憶體使用量增加不超過 1MB（相較於監控 30 個交易對時）
- **SC-006**: 前端市場監控頁面能在 3 秒內載入並顯示所有 100 個交易對的數據
- **SC-007**: 系統連續運作 24 小時無崩潰或重大錯誤（允許個別 API 呼叫失敗但系統整體穩定）

## Assumptions *(optional)*

- 假設 Binance 上有至少 100 個 USDT 永續合約交易對符合 OI 門檻
- 假設這 100 個交易對中至少有 80 個在所有 4 個交易所都有支援
- 假設現有的並發控制機制（p-limit）能有效管理 API 速率限制
- 假設資料庫（PostgreSQL + TimescaleDB）能輕鬆處理 100 個交易對的歷史數據儲存
- 假設現有的 WebSocket 推送機制能處理更大的數據量而不影響前端效能
- 假設不改變現有的資金費率檢查頻率（5 分鐘），未來可根據需要調整

## Out of Scope *(optional)*

- **自動 OI 刷新**: 不實作自動定期更新交易對清單的功能（維持手動執行腳本）
- **調整檢查頻率**: 不修改資金費率的檢查頻率（維持 5 分鐘）
- **新增交易所**: 不新增 Binance、OKX、MEXC、Gate.io 以外的交易所
- **分層監控策略**: 不實作不同 OI 等級使用不同更新頻率的策略
- **動態交易對選擇**: 不實作基於波動性或其他指標的動態交易對選擇
- **效能優化**: 不進行額外的效能優化（如快取策略調整、資料庫查詢優化），除非在測試中發現明顯瓶頸
