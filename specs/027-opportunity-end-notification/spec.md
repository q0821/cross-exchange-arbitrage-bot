# Feature Specification: 套利機會結束監測和通知

**Feature Branch**: `027-opportunity-end-notification`
**Created**: 2025-12-01
**Status**: Draft
**Input**: User description: "當用戶之前收到的套利機會費差降低到閾值以下時，發送通知告知機會已結束，並提供統計資訊（持續時間、費差統計、實際收益計算）。同時將機會歷史記錄到資料庫供未來分析。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 接收套利機會結束通知 (Priority: P1)

作為一個已設定 Webhook 通知的套利交易用戶，當我之前收到通知的套利機會費差降低到我設定的閾值以下時，我希望收到一則「機會結束」通知，讓我知道這個套利機會已不再符合我的標準。

**Why this priority**: 這是核心功能，讓用戶即時知道套利機會何時結束，以便做出平倉決策。

**Independent Test**: 可透過設定低閾值觸發通知後，等待費差下降來驗證結束通知是否正確發送。

**Acceptance Scenarios**:

1. **Given** 用戶已收到 BTCUSDT 的套利機會通知（費差 1.2%，閾值 0.8%），**When** 費差降至 0.75%，**Then** 用戶收到機會結束通知，包含交易對名稱和基本統計資訊。
2. **Given** 用戶在 Webhook 設定中關閉了「接收結束通知」，**When** 費差降至閾值以下，**Then** 用戶不會收到結束通知。
3. **Given** 用戶設定了多個不同閾值的 Webhook，**When** 費差降至 0.5%，**Then** 只有閾值高於 0.5% 的 Webhook 會收到結束通知。

---

### User Story 2 - 查看機會持續時間和費差統計 (Priority: P1)

作為一個套利交易用戶，當我收到機會結束通知時，我希望看到該機會的持續時間、初始費差、最高費差、結束費差等統計資訊，以便評估這個機會的品質。

**Why this priority**: 統計資訊是評估套利機會價值的關鍵數據，與結束通知同等重要。

**Independent Test**: 驗證結束通知中包含所有必要的統計欄位，且數值計算正確。

**Acceptance Scenarios**:

1. **Given** 套利機會於 08:30 開始、15:45 結束，**When** 用戶收到結束通知，**Then** 通知顯示持續時間為「7 小時 15 分鐘」。
2. **Given** 套利機會期間費差從 0.9% 上升到 1.5% 再降到 0.6%，**When** 用戶收到結束通知，**Then** 通知顯示初始 0.9%、最高 1.5%、結束 0.6%。
3. **Given** 最高費差發生在 12:30，**When** 用戶收到結束通知，**Then** 通知顯示最高費差發生時間。

---

### User Story 3 - 查看模擬收益計算 (Priority: P2)

作為一個套利交易用戶，當我收到機會結束通知時，我希望看到假設我在機會開始時建倉、結束時平倉的模擬收益（包含實際收取的費率、開平倉成本、淨收益、年化收益率），以便評估這個機會的實際價值。

**Why this priority**: 模擬收益幫助用戶量化套利機會的實際價值，但需要基於 P1 的統計數據才能計算。

**Independent Test**: 驗證模擬收益計算邏輯正確，特別是只計算費率結算時間點的收益。

**Acceptance Scenarios**:

1. **Given** 機會持續 18 小時且經過多次費率結算（依各交易所結算週期：1h/4h/8h），**When** 用戶收到結束通知，**Then** 模擬收益僅計算實際發生的結算時間點的費差總和。
2. **Given** 做多方（4h 結算）收了 4 次、做空方（1h 結算）收了 18 次，**When** 計算模擬收益，**Then** 分別計算多空雙方的費率收益後加總。
3. **Given** 總費率收益為 3.2%，**When** 計算模擬收益，**Then** 扣除開平倉成本 0.2%（多空雙方各 0.1%）後淨收益為 3.0%。
4. **Given** 淨收益為 3.0%、持續時間 18 小時，**When** 計算年化收益率，**Then** 顯示 APY = 3.0% × (8760 / 18) = 1460%。

---

### User Story 4 - 控制結束通知開關 (Priority: P2)

作為一個套利交易用戶，我希望能在 Webhook 設定中獨立控制是否接收結束通知，以便根據我的偏好客製化通知行為。

**Why this priority**: 提供用戶控制權，避免不需要的通知干擾，但不是核心功能。

**Independent Test**: 驗證 Webhook 設定頁面有開關選項，且開關狀態正確影響通知行為。

**Acceptance Scenarios**:

1. **Given** 用戶在設定頁面，**When** 查看 Webhook 設定，**Then** 看到「接收結束通知」開關選項，預設為開啟。
2. **Given** 用戶關閉「接收結束通知」，**When** 套利機會結束，**Then** 該 Webhook 不會收到結束通知。
3. **Given** 用戶有多個 Webhook，**When** 只關閉其中一個的結束通知，**Then** 其他 Webhook 仍正常收到結束通知。

---

### User Story 5 - 查看歷史機會記錄 (Priority: P3)

作為一個套利交易用戶，我希望系統將每個套利機會的完整歷史記錄到資料庫，以便未來查詢和分析。

**Why this priority**: 歷史記錄是進階功能，主要用於未來分析，不影響即時通知的核心價值。

**Independent Test**: 驗證機會結束時正確寫入資料庫記錄，且包含所有必要欄位。

**Acceptance Scenarios**:

1. **Given** 套利機會結束，**When** 發送結束通知後，**Then** 系統將該機會的完整資訊（交易對、持續時間、費差統計、費率結算記錄、模擬收益）存入資料庫。
2. **Given** 資料庫中有歷史記錄，**When** 查詢特定用戶的機會歷史，**Then** 能按時間排序取得所有記錄。
3. **Given** 資料庫中有歷史記錄，**When** 查詢特定交易對的機會歷史，**Then** 能取得該交易對的所有歷史機會。

---

### Edge Cases

- 機會開始後尚未經過任何費率結算時間就結束：模擬收益顯示「無費率結算」，淨收益為 -0.2%（僅成本）
- 監控服務重啟導致追蹤資料遺失：該機會視為新機會，不會發送結束通知
- 用戶在機會進行中刪除 Webhook：該 Webhook 不再追蹤此機會，不會發送結束通知
- 費差在閾值附近頻繁波動：使用防抖動機制，費差需持續低於閾值一定時間才觸發結束
- 同一交易對在不同交易所組合有多個機會：每個交易所組合獨立追蹤和通知
- 多空雙方結算週期不同（如做多 4h、做空 1h）：分別追蹤各方結算時間，獨立計算收益後加總

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須追蹤每個已發送通知的套利機會，記錄開始時間、初始費差、交易所組合
- **FR-002**: 系統必須在每次費率更新時檢查已追蹤機會的當前費差是否低於用戶閾值
- **FR-003**: 系統必須在機會費差低於閾值時，向啟用結束通知的 Webhook 發送結束通知
- **FR-004**: 系統必須在結束通知中包含：交易對、交易所組合、持續時間、費差統計（初始/最高/結束）
- **FR-005**: 系統必須根據各交易所的費率結算週期（1h/4h/8h）追蹤結算時間點的費差，用於計算模擬收益
- **FR-006**: 系統必須計算模擬收益，包含：結算次數、總費率收益、開平倉成本（0.2%）、淨收益、年化收益率
- **FR-007**: 系統必須在 Webhook 設定中提供「接收結束通知」開關，預設為開啟
- **FR-008**: 系統必須將機會歷史記錄到資料庫，包含所有統計資訊和費率結算記錄
- **FR-009**: 系統必須支援 Discord 和 Slack 兩種通知格式的結束通知訊息
- **FR-010**: 系統必須使用防抖動機制，避免費差在閾值附近波動時重複發送通知
- **FR-011**: 系統必須支援多空雙方不同的費率結算週期（如做多方 4h、做空方 1h），分別追蹤各方的結算時間並獨立計算收益後加總

### Key Entities

- **TrackedOpportunity**: 追蹤中的套利機會，包含交易對、交易所組合、開始時間、費差統計、費率結算記錄、已通知的 Webhook 列表
- **OpportunityHistory**: 已結束機會的歷史記錄，包含完整統計資訊和模擬收益計算結果
- **FundingSettlement**: 費率結算記錄，包含結算時間、結算方（做多/做空）、該方的費率收益

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用戶在機會結束後 1 分鐘內收到結束通知
- **SC-002**: 結束通知中的統計數據 100% 準確（與實際數據一致）
- **SC-003**: 模擬收益計算僅基於實際費率結算時間點，計算結果可驗證
- **SC-004**: 100% 的結束機會被記錄到資料庫供未來分析
- **SC-005**: 用戶可透過開關自由控制是否接收結束通知

## Assumptions

- 費率結算週期因交易所和幣種而異，常見為 1 小時、4 小時或 8 小時
- 系統需從交易所 API 或現有費率資料中取得各幣種的結算週期資訊
- 開平倉成本固定為 0.2%（多空雙方各需開倉 0.05% + 平倉 0.05%）
- 系統使用記憶體追蹤機會狀態，服務重啟會遺失追蹤資料
- 防抖動時間設定為 1 分鐘（費差需持續低於閾值 1 分鐘才觸發結束）
