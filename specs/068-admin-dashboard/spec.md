# Feature Specification: 平台管理後臺

**Feature Branch**: `068-admin-dashboard`
**Created**: 2026-01-23
**Status**: Draft
**Input**: User description: "我想要建立一個平台的管理後臺界面，能夠做使用者的管理，可以新增、編輯、停用、刪除使用者，以及查看整個平台的績效，查看使用者何時開單、何時關單、收益狀況，可以的話最好是能知道開關單的時候的資金費率等資訊"

## Clarifications

### Session 2026-01-23

- Q: 管理員帳戶與一般使用者帳戶的關係？ → A: 使用現有 User 模型，新增 `role` 欄位（user/admin）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看平台整體績效總覽 (Priority: P1)

管理員登入後臺後，能在首頁儀表板看到平台整體的關鍵績效指標，包括總使用者數、活躍持倉數、已平倉交易數、平台總收益等統計資訊，讓管理員快速掌握平台營運狀況。

**Why this priority**: 這是管理後臺最核心的價值 - 讓管理員能快速了解平台整體狀況，是所有管理決策的基礎。

**Independent Test**: 管理員登入後即可在儀表板看到完整的平台統計數據，無需其他功能也能獨立運作。

**Acceptance Scenarios**:

1. **Given** 管理員已登入後臺, **When** 進入儀表板頁面, **Then** 顯示總使用者數、今日/本週/本月活躍使用者數
2. **Given** 管理員已登入後臺, **When** 查看持倉統計, **Then** 顯示目前活躍持倉總數、各交易所持倉分佈
3. **Given** 管理員已登入後臺, **When** 查看收益統計, **Then** 顯示平台總收益（所有已平倉交易的 totalPnL 加總）、平均 ROI
4. **Given** 平台有交易記錄, **When** 查看今日數據, **Then** 顯示今日新開倉數、今日已平倉數、今日收益

---

### User Story 2 - 使用者列表與搜尋 (Priority: P1)

管理員能查看所有使用者的列表，支援搜尋和篩選功能，能快速找到特定使用者並查看其基本資訊。

**Why this priority**: 使用者管理是後臺的核心功能，必須能有效瀏覽和找到特定使用者。

**Independent Test**: 管理員可以瀏覽使用者列表、使用搜尋功能找到特定使用者，無需依賴其他功能。

**Acceptance Scenarios**:

1. **Given** 管理員在使用者管理頁面, **When** 載入頁面, **Then** 顯示所有使用者的分頁列表（每頁 20 筆）
2. **Given** 使用者列表已載入, **When** 輸入 email 進行搜尋, **Then** 即時篩選出符合的使用者
3. **Given** 使用者列表已載入, **When** 點擊某使用者, **Then** 顯示該使用者的詳細資訊（註冊時間、最後登入、持倉數、交易數）
4. **Given** 使用者列表已載入, **When** 選擇「只顯示停用帳戶」篩選, **Then** 僅顯示已停用的使用者

---

### User Story 3 - 新增使用者 (Priority: P2)

管理員能手動建立新的使用者帳戶，輸入必要資訊後系統建立帳戶並產生初始密碼。

**Why this priority**: 雖然一般使用者可自行註冊，但管理員有時需要手動建立特定帳戶，是基本管理功能。

**Independent Test**: 管理員可以獨立完成新使用者的建立，不需要其他功能配合。

**Acceptance Scenarios**:

1. **Given** 管理員在使用者管理頁面, **When** 點擊「新增使用者」按鈕, **Then** 顯示新增使用者表單
2. **Given** 新增表單已開啟, **When** 輸入有效的 email 並送出, **Then** 建立新使用者並顯示自動產生的初始密碼
3. **Given** 新增表單已開啟, **When** 輸入已存在的 email 並送出, **Then** 顯示「此 email 已被使用」錯誤訊息
4. **Given** 新增表單已開啟, **When** 輸入無效的 email 格式, **Then** 顯示格式驗證錯誤

---

### User Story 4 - 編輯使用者資訊 (Priority: P2)

管理員能編輯使用者的基本資訊，包括 email 和密碼重設。

**Why this priority**: 使用者可能需要變更 email 或忘記密碼，管理員需要能協助處理。

**Independent Test**: 管理員可以獨立編輯任一使用者的資訊。

**Acceptance Scenarios**:

1. **Given** 管理員在使用者詳情頁, **When** 點擊「編輯」按鈕, **Then** 顯示可編輯的使用者資訊表單
2. **Given** 編輯表單已開啟, **When** 修改 email 為新的有效 email 並儲存, **Then** 更新使用者 email
3. **Given** 編輯表單已開啟, **When** 點擊「重設密碼」, **Then** 產生新密碼並顯示給管理員
4. **Given** 編輯表單已開啟, **When** 修改 email 為已存在的 email, **Then** 顯示「此 email 已被使用」錯誤

---

### User Story 5 - 停用與啟用使用者 (Priority: P2)

管理員能停用或重新啟用使用者帳戶，停用後使用者無法登入系統。

**Why this priority**: 必要的帳戶管理功能，用於處理違規或暫停使用者。

**Independent Test**: 管理員可以獨立執行停用/啟用操作。

**Acceptance Scenarios**:

1. **Given** 使用者狀態為「啟用」, **When** 管理員點擊「停用帳戶」並確認, **Then** 使用者狀態變更為「停用」
2. **Given** 使用者已被停用, **When** 該使用者嘗試登入, **Then** 顯示「帳戶已被停用」訊息並拒絕登入
3. **Given** 使用者狀態為「停用」, **When** 管理員點擊「啟用帳戶」, **Then** 使用者狀態恢復為「啟用」
4. **Given** 使用者有活躍持倉, **When** 管理員嘗試停用該帳戶, **Then** 顯示警告「此使用者有活躍持倉，確定要停用嗎？」

---

### User Story 6 - 刪除使用者 (Priority: P3)

管理員能永久刪除使用者帳戶，包含所有相關資料。此為不可逆操作。

**Why this priority**: 較少使用的功能，通常停用即可，刪除為最後手段。

**Independent Test**: 管理員可以獨立執行刪除操作。

**Acceptance Scenarios**:

1. **Given** 使用者無活躍持倉, **When** 管理員點擊「刪除使用者」並二次確認, **Then** 永久刪除該使用者及所有關聯資料
2. **Given** 使用者有活躍持倉, **When** 管理員嘗試刪除, **Then** 顯示「無法刪除有活躍持倉的使用者，請先平倉」錯誤
3. **Given** 刪除確認對話框已開啟, **When** 管理員輸入錯誤的確認文字, **Then** 刪除按鈕保持停用狀態
4. **Given** 刪除成功, **When** 返回使用者列表, **Then** 該使用者不再出現在列表中

---

### User Story 7 - 查看使用者交易明細 (Priority: P1)

管理員能查看特定使用者的所有持倉和已平倉交易記錄，包含開倉時間、平倉時間、收益、開倉時的資金費率等詳細資訊。

**Why this priority**: 這是需求中明確提到的核心功能 - 查看使用者何時開單、何時關單、收益狀況、資金費率資訊。

**Independent Test**: 管理員可以獨立查看任一使用者的完整交易歷史。

**Acceptance Scenarios**:

1. **Given** 管理員在使用者詳情頁, **When** 點擊「持倉記錄」標籤, **Then** 顯示該使用者所有持倉（含活躍與已關閉）
2. **Given** 持倉記錄已載入, **When** 點擊某筆持倉, **Then** 顯示完整資訊：symbol、做多/做空交易所、開倉價格、開倉時間、開倉時的資金費率（openFundingRateLong/Short）
3. **Given** 查看已平倉交易, **When** 展開交易詳情, **Then** 顯示：平倉價格、平倉時間、持倉時長、幣價損益、資金費率損益、總損益、ROI
4. **Given** 使用者有多筆交易, **When** 使用日期篩選器, **Then** 僅顯示指定日期範圍內的交易
5. **Given** 交易列表已載入, **When** 點擊匯出按鈕, **Then** 下載該使用者的交易記錄 CSV 檔案

---

### User Story 8 - 平台交易列表 (Priority: P2)

管理員能查看平台所有交易的彙總列表，支援依使用者、交易對、日期等條件篩選。

**Why this priority**: 補充 P1 的使用者交易明細，提供跨使用者的全域視角。

**Independent Test**: 管理員可以獨立瀏覽和篩選平台所有交易。

**Acceptance Scenarios**:

1. **Given** 管理員在交易列表頁面, **When** 載入頁面, **Then** 顯示所有交易的分頁列表（最新在前）
2. **Given** 交易列表已載入, **When** 選擇特定 symbol 篩選, **Then** 僅顯示該交易對的交易
3. **Given** 交易列表已載入, **When** 選擇特定使用者篩選, **Then** 僅顯示該使用者的交易
4. **Given** 交易列表已載入, **When** 設定日期範圍, **Then** 僅顯示該時段內的交易

---

### Edge Cases

- 當平台無任何使用者時，儀表板顯示「尚無使用者」提示而非空白或錯誤
- 當使用者無任何交易記錄時，交易列表顯示「尚無交易記錄」提示
- 當搜尋結果為空時，顯示「找不到符合條件的結果」提示
- 刪除使用者時若該使用者正在登入中，該使用者的 session 應立即失效
- 停用使用者時若該使用者正在登入中，該使用者的 session 應立即失效
- 大量資料載入時（超過 10000 筆交易）應有適當的分頁和效能處理

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須提供管理員專用的登入入口，與一般使用者登入分開
- **FR-002**: 系統必須在管理員登入後顯示平台績效儀表板，包含使用者統計、持倉統計、收益統計
- **FR-003**: 系統必須提供使用者列表功能，支援分頁（每頁 20 筆）、搜尋（依 email）、篩選（依狀態）
- **FR-004**: 系統必須允許管理員新增使用者，自動產生初始密碼
- **FR-005**: 系統必須允許管理員編輯使用者 email 並重設密碼
- **FR-006**: 系統必須允許管理員停用/啟用使用者帳戶
- **FR-007**: 系統必須允許管理員刪除無活躍持倉的使用者（需二次確認）
- **FR-008**: 系統必須顯示使用者的持倉記錄，包含開倉時的資金費率（openFundingRateLong/openFundingRateShort）
- **FR-009**: 系統必須顯示使用者的已平倉交易記錄，包含完整損益明細
- **FR-010**: 系統必須提供交易記錄匯出功能（CSV 格式）
- **FR-011**: 系統必須在停用或刪除使用者時立即使該使用者的所有 session 失效
- **FR-012**: 系統必須限制管理員無法刪除有活躍持倉的使用者

### Key Entities

- **User（使用者）**: 現有的使用者實體，新增 `role` 欄位（user/admin）區分一般使用者與管理員，新增 `isActive` 狀態欄位用於停用/啟用功能
- **Position（持倉）**: 現有持倉實體，包含開倉時的資金費率欄位（openFundingRateLong/openFundingRateShort）
- **Trade（交易）**: 現有交易實體，包含完整的損益資訊
- **AuditLog（審計日誌）**: 記錄管理員的所有操作（新增/編輯/停用/刪除使用者）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理員能在 3 秒內載入完整的平台儀表板數據
- **SC-002**: 使用者列表搜尋結果在 1 秒內返回
- **SC-003**: 管理員能在 2 分鐘內完成新增使用者的流程
- **SC-004**: 停用使用者後，該使用者在 5 秒內無法再使用系統
- **SC-005**: 交易明細能顯示開倉時的資金費率資訊（openFundingRateLong/openFundingRateShort）
- **SC-006**: 匯出 CSV 檔案能在 10 秒內完成（1000 筆以內的交易）
- **SC-007**: 所有管理操作都被記錄在審計日誌中，便於追蹤

## Assumptions

- 管理員帳戶將透過資料庫直接建立或種子腳本，不提供自助註冊功能
- 管理後臺使用與前台相同的技術架構（Next.js），但路由獨立於 `/admin` 路徑下
- 管理員權限為單一等級，不區分超級管理員和一般管理員
- 現有的 User 模型將擴展 `isActive` 布林欄位，預設為 `true`
- 管理員操作不受前台的風險參數限制
