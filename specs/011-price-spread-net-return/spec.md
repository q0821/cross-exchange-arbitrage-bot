# Feature Specification: Web 市場監控整合價差顯示與淨收益計算

**Feature Branch**: `011-price-spread-net-return`
**Created**: 2025-11-12
**Status**: Draft
**Input**: User description: "Web 市場監控整合價差顯示與淨收益計算。在表格中新增價差和淨收益欄位，透過動態計算（費率差異 - 價差 - 手續費）來判斷套利機會的真實獲利能力，避免賺資金費率但賠價差的情況。支援按價差和淨收益排序，使用顏色指示器標示有利/不利機會。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 顯示交易所間價差 (Priority: P1)

交易員在市場監控頁面查看套利機會時，希望能直接看到做多交易所和做空交易所之間的現貨價格差異百分比，以便快速判斷是否存在不利價差會侵蝕資金費率收益。

**Why this priority**: 這是核心功能，解決了「賺資金費率、賠價差」的關鍵痛點。價差是影響套利實際獲利的重要因素，必須優先顯示。價差資料已在後端計算完成，只需推送到前端顯示。

**Independent Test**: 可以獨立測試 - 開啟市場監控頁面 (http://localhost:3000/market-monitor)，選擇任一交易對，在最佳套利對的資訊中應看到「價差」欄位顯示百分比（例如：「價差 +0.15%」或「價差 -0.05%」）。成功標準：價差數值正確顯示，與後端計算一致。

**Acceptance Scenarios**:

1. **Given** 用戶開啟市場監控頁面並選擇有套利機會的交易對，**When** 頁面載入完成，**Then** 在「最佳套利對」欄位中顯示價差百分比（格式化為 2 位小數，例如 +0.15%）
2. **Given** 套利機會的做空交易所價格高於做多交易所價格，**When** 系統計算價差，**Then** 價差顯示為正值（例如 +0.15%），表示有利於套利
3. **Given** 套利機會的做空交易所價格低於做多交易所價格，**When** 系統計算價差，**Then** 價差顯示為負值（例如 -0.05%），表示不利於套利
4. **Given** WebSocket 推送新的市場資料，**When** 價格更新導致價差變化，**Then** 價差數值即時更新，但列表順序保持穩定（依據 Feature 009 穩定排序機制）
5. **Given** 某個交易對暫時無法取得價格資料，**When** 系統無法計算價差，**Then** 價差欄位顯示 "N/A" 或 "-"，不影響其他欄位顯示

---

### User Story 2 - 顯示淨收益（動態計算） (Priority: P1)

交易員希望看到扣除價差和交易手續費後的**真實淨收益**，而不只是資金費率差異，以便準確評估套利機會是否值得執行。系統應動態計算「淨收益 = 資金費率差異 - |價差| - 交易手續費」，並使用顏色指示器標示有利、持平或不利的機會。

**Why this priority**: 這是用戶最關心的指標，直接回答「這筆套利到底能賺多少」的問題。淨收益整合了資金費率、價差和手續費，是最終決策的依據。缺少淨收益顯示，用戶需要手動計算，容易出錯且效率低落。

**Independent Test**: 可以獨立測試 - 開啟市場監控頁面，檢查「淨收益」欄位顯示的數值是否等於「費率差異 - |價差| - 手續費」，並驗證顏色指示器：淨收益 > 0.1% 顯示綠色，-0.05% 到 0.1% 顯示黃色，< -0.05% 顯示紅色。

**Acceptance Scenarios**:

1. **Given** 用戶開啟市場監控頁面，**When** 頁面載入套利機會資料，**Then** 每個機會都顯示「淨收益」欄位，數值為「費率差異 - |價差| - 交易手續費（約 0.3%）」的計算結果
2. **Given** 某套利機會的淨收益 > 0.1%，**When** 系統計算顏色指示器，**Then** 淨收益欄位背景顯示為綠色或使用綠色文字，表示「優勢機會」
3. **Given** 某套利機會的淨收益在 -0.05% 到 0.1% 之間，**When** 系統計算顏色指示器，**Then** 淨收益欄位背景顯示為黃色或使用黃色文字，表示「持平機會」
4. **Given** 某套利機會的淨收益 < -0.05%，**When** 系統計算顏色指示器，**Then** 淨收益欄位背景顯示為紅色或使用紅色文字，表示「不利機會」
5. **Given** WebSocket 推送新的資料導致費率差異或價差變化，**When** 系統重新計算淨收益，**Then** 淨收益數值和顏色指示器即時更新，列表順序保持穩定
6. **Given** 系統顯示淨收益為負值的套利機會，**When** 用戶查看列表，**Then** 這些機會仍然顯示（不自動過濾），讓用戶自行判斷是否執行

---

### User Story 3 - 按價差和淨收益排序 (Priority: P2)

交易員希望能夠按照價差或淨收益對套利機會列表進行排序，以便快速找到價差最有利或淨收益最高的機會。排序應支援升序和降序，並保持穩定排序特性（相同數值的項目不會跳動）。

**Why this priority**: 這是增強功能，提升用戶體驗。雖然重要但不是最小可行方案的必要組成部分，因為用戶可以手動掃描列表找到最佳機會。在 P1 功能完成後實作排序能讓用戶更高效地篩選機會。

**Independent Test**: 可以獨立測試 - 點擊「價差」或「淨收益」欄位標題，列表應按該欄位數值重新排序（預設降序），再次點擊切換為升序。驗證排序正確性（數值順序正確）和穩定性（相同數值的項目保持相對位置不變）。

**Acceptance Scenarios**:

1. **Given** 用戶開啟市場監控頁面並看到套利機會列表，**When** 用戶點擊「價差」欄位標題，**Then** 列表按價差降序排列（最有利價差在最上方，即正值最大或負值最小）
2. **Given** 列表已按價差降序排列，**When** 用戶再次點擊「價差」欄位標題，**Then** 列表切換為價差升序排列（最不利價差在最上方）
3. **Given** 用戶開啟市場監控頁面，**When** 用戶點擊「淨收益」欄位標題，**Then** 列表按淨收益降序排列（淨收益最高的機會在最上方）
4. **Given** 列表已按淨收益降序排列，**When** 用戶再次點擊「淨收益」欄位標題，**Then** 列表切換為淨收益升序排列
5. **Given** 列表已按價差或淨收益排序，**When** 多個機會具有相同的價差或淨收益數值，**Then** 這些機會按交易對名稱（symbol）字母順序排列，確保穩定排序（不會因 WebSocket 更新而跳動）
6. **Given** 列表已按價差或淨收益排序，**When** WebSocket 推送新資料導致數值變化，**Then** 列表順序保持不變（使用快照排序機制），直到用戶重新排序或刷新頁面

---

### Edge Cases

- **價差計算異常**：當某交易所的價格資料暫時無法取得或異常時，價差如何顯示？系統應顯示 "N/A" 並標記該機會為不可用，不影響其他正常機會的顯示。
- **淨收益為零或接近零**：當淨收益非常接近 0%（例如 ±0.01%）時，如何區分有利和不利？系統應使用明確的閾值（±0.05%）來判斷，避免頻繁切換顏色指示器。
- **手續費常數變更**：當交易所調整手續費率時，淨收益計算是否會更新？系統應使用可配置的手續費常數（在 `cost-constants.ts` 中定義），便於未來調整。
- **多交易所價格不一致**：當三個以上交易所的價格差異很大時，系統如何選擇「最佳」套利對？系統已有 `bestPair` 邏輯，選擇費率差異最大的交易所對，價差計算基於該對的價格。
- **WebSocket 連線中斷**：當 WebSocket 連線中斷時，價差和淨收益資料如何更新？系統應顯示「連線中斷」警告，並保持最後一次有效資料，等待重新連線後更新。
- **負價差但高費率差異**：當價差為負（不利）但資金費率差異極高時，淨收益可能仍為正。系統是否應特別標示這種情況？不需特別處理，淨收益本身已整合了所有因素，用戶看到綠色淨收益即代表整體有利。
- **排序時的性能**：當監控的交易對數量很大（例如 100+ 個）時，按價差或淨收益排序是否會有性能問題？系統已有穩定排序實作（Feature 009），效能經過優化，支援大量資料排序。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須在 Web 市場監控表格中新增「價差」欄位，顯示做空交易所與做多交易所之間的現貨價格差異百分比（精確到 2 位小數）
- **FR-002**: 系統必須在 Web 市場監控表格中新增「淨收益」欄位，動態計算並顯示「費率差異 - |價差| - 交易手續費」的結果（精確到 2 位小數）
- **FR-003**: 系統必須在後端 WebSocket handler 中推送 `priceDiffPercent`（價差）和 `netReturn`（淨收益）資料到前端
- **FR-004**: 系統必須使用顏色指示器標示淨收益：淨收益 > 0.1% 為綠色（優勢），-0.05% 到 0.1% 為黃色（持平），< -0.05% 為紅色（不利）
- **FR-005**: 系統必須支援按價差欄位排序（升序/降序），點擊欄位標題可切換排序方向
- **FR-006**: 系統必須支援按淨收益欄位排序（升序/降序），點擊欄位標題可切換排序方向
- **FR-007**: 系統必須在排序時保持穩定性，相同數值的項目按交易對名稱字母順序排列，不會因 WebSocket 更新而跳動
- **FR-008**: 系統必須顯示所有套利機會（包括淨收益為負的機會），不自動過濾，讓用戶自行判斷
- **FR-009**: 系統必須正確處理價格資料暫時無法取得的情況，在價差和淨收益欄位顯示 "N/A" 或 "-"
- **FR-010**: 系統必須使用統一的交易手續費常數（約 0.3%，包含 Maker/Taker 費用和滑價），該常數應可在配置檔案中調整

### Key Entities

- **MarketRate**（市場費率）：代表單一交易對在多個交易所的資金費率和價格資訊
  - 包含：交易對名稱（symbol）、各交易所的費率和價格、最佳套利對資訊（bestPair）、狀態（status）
  - 關聯：一個 MarketRate 包含一個 BestArbitragePair

- **BestArbitragePair**（最佳套利對）：代表特定交易對的最優套利機會
  - 包含：做多交易所（longExchange）、做空交易所（shortExchange）、費率差異（spreadPercent）、年化收益（annualizedReturn）、**價差（priceDiffPercent，新增）**、**淨收益（netReturn，新增）**
  - 關聯：屬於一個 MarketRate

- **SortField**（排序欄位）：定義表格可排序的欄位
  - 包含：symbol、spread、annualizedReturn、**priceDiff（新增）**、**netReturn（新增）**
  - 關聯：用於 useTableSort hook 和 sortComparator 函數

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用戶開啟市場監控頁面時，能在 3 秒內看到所有套利機會的價差和淨收益資訊（包含顏色指示器）
- **SC-002**: 淨收益計算準確率達 100%，與手動計算「費率差異 - |價差| - 手續費」的結果完全一致
- **SC-003**: 用戶能在 1 秒內完成按價差或淨收益排序操作（點擊欄位標題到列表重新排列完成）
- **SC-004**: 在 WebSocket 推送新資料時，列表不會出現視覺跳動（相同淨收益或價差的項目保持相對位置不變）
- **SC-005**: 90% 的用戶能立即理解顏色指示器的含義（綠色=有利、黃色=持平、紅色=不利），無需查看文件或說明
- **SC-006**: 系統能正確處理 100% 的邊緣情況（價格資料缺失、負價差、淨收益為零等），不會出現錯誤或空白顯示
- **SC-007**: 在監控 100 個交易對時，按淨收益排序的操作仍能在 1 秒內完成，不影響用戶體驗

## Scope *(mandatory)*

### In Scope

- 在 Web 市場監控表格新增「價差」和「淨收益」欄位
- 後端 WebSocket handler 推送價差和淨收益資料
- 前端顯示價差和淨收益，使用格式化數值（百分比，2 位小數）
- 淨收益顏色指示器（綠色/黃色/紅色）
- 按價差和淨收益排序功能（升序/降序）
- 穩定排序機制（基於 Feature 009）
- 邊緣情況處理（價格資料缺失、負價差等）
- 單元測試和 E2E 測試

### Out of Scope

- 修改淨收益計算公式（固定使用「費率差異 - |價差| - 手續費」）
- 新增其他欄位（例如：歷史淨收益趨勢、預測收益等）
- 自動過濾淨收益為負的機會（用戶需求是「只顯示不過濾」）
- 價差和淨收益的歷史圖表或趨勢分析
- 手續費的動態更新（使用固定常數，未來可擴展）
- 移動端優化或響應式設計調整（維持現有佈局）
- CLI 版本的價差和淨收益顯示（僅 Web 介面）

## Assumptions *(mandatory)*

- **A-001**: 後端已正確計算並快取每個交易對的價差（`priceDiffPercent`），該資料存在於 `RatesCache` 中
- **A-002**: 交易手續費固定為約 0.3%（包含 Maker 0.02% + Taker 0.05% × 2 + 滑價 0.15%），該常數定義在 `src/lib/cost-constants.ts` 中
- **A-003**: 用戶已熟悉市場監控介面的基本操作（查看、排序），不需要額外的教學或引導
- **A-004**: WebSocket 連線穩定，能即時推送市場資料更新（平均延遲 < 1 秒）
- **A-005**: 現有的穩定排序機制（Feature 009）已正確實作，可直接擴展支援新欄位
- **A-006**: 用戶熟悉套利交易的基本概念（資金費率、價差、手續費），能理解淨收益的含義
- **A-007**: 顏色指示器的閾值（淨收益 > 0.1% 為綠色、< -0.05% 為紅色）符合大多數用戶的風險偏好，不需個人化設定
- **A-008**: 系統監控的交易對數量在 30-100 個範圍內，排序和渲染效能不會成為瓶頸

## Dependencies *(mandatory)*

- **D-001**: 依賴 Feature 009「市場監控穩定排序機制」，需使用其快照排序邏輯來實作價差和淨收益排序
- **D-002**: 依賴 `src/services/monitor/RateDifferenceCalculator.ts` 中的價差計算邏輯，確保後端正確計算 `priceDiffPercent`
- **D-003**: 依賴 `src/lib/cost-constants.ts` 中的手續費常數定義，用於淨收益計算
- **D-004**: 依賴 `src/websocket/handlers/MarketRatesHandler.ts` 的現有 WebSocket 推送機制，需擴展推送資料格式
- **D-005**: 依賴現有的前端元件（RatesTable.tsx、RateRow.tsx）和 hooks（useMarketRates.ts、useTableSort.ts），需修改或擴展這些元件
- **D-006**: 依賴 TypeScript 類型定義的一致性，前端和後端的 `BestArbitragePair` 介面必須同步更新

## Risks *(optional)*

- **R-001**: **淨收益計算複雜性**：如果手續費常數或計算公式有誤，會導致所有淨收益顯示錯誤，影響用戶決策。緩解措施：在實作前驗證計算公式，撰寫詳細的單元測試。
- **R-002**: **顏色指示器閾值爭議**：不同用戶的風險偏好不同，固定閾值（> 0.1% 為綠色）可能不符合所有用戶需求。緩解措施：在文件中明確說明閾值定義，未來可考慮提供個人化設定。
- **R-003**: **表格寬度問題**：新增兩個欄位可能導致表格過寬，在小螢幕上顯示不佳。緩解措施：調整現有欄位寬度，優先顯示核心資訊（價差和淨收益），考慮隱藏不常用欄位或使用水平滾動。
- **R-004**: **WebSocket 資料推送延遲**：如果後端計算淨收益需要額外時間，可能影響 WebSocket 推送頻率。緩解措施：淨收益計算非常簡單（一個減法），不會顯著影響效能。
- **R-005**: **用戶誤解負淨收益**：部分用戶可能不理解為何顯示負淨收益的機會（預期應被過濾）。緩解措施：在介面上提供說明文字或 tooltip，解釋「顯示所有機會，讓您自行判斷」的設計理念。

## Open Questions *(optional)*

*無未解決問題。所有關鍵決策已在需求收集階段確認：*
- ✅ 顯示方式：新增獨立欄位（方案 B）
- ✅ 判斷邏輯：動態計算淨收益
- ✅ 過濾機制：只顯示不過濾
- ✅ 優先級：P1 核心功能
