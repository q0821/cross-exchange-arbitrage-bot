# Quick Start Guide: Web 市場監控整合價差顯示與淨收益計算

**Feature**: 011-price-spread-net-return
**Created**: 2025-11-12
**Target Audience**: 開發者、測試人員、用戶

---

## Overview

本指南說明如何測試和驗證 Web 市場監控的價差和淨收益顯示功能。包含環境設置、手動測試步驟、自動化測試指令和常見問題排查。

---

## Prerequisites

### 環境需求

- Node.js 20.x LTS
- pnpm 8.x
- Docker（用於 PostgreSQL + TimescaleDB）
- 現代瀏覽器（Chrome、Firefox、Safari）

### 啟動服務

```bash
# 1. 啟動資料庫
pnpm docker:up

# 2. 安裝依賴
pnpm install

# 3. 啟動 Web 服務
pnpm dev

# 服務會在 http://localhost:3000 啟動
```

---

## Manual Testing

### Step 1: 開啟市場監控頁面

1. 打開瀏覽器
2. 前往 `http://localhost:3000/market-monitor`
3. 等待 WebSocket 連線建立（應看到「已連結」狀態）

### Step 2: 驗證價差欄位

**Expected**：
- 表格應包含「價差」欄位
- 每個交易對顯示價差百分比（例如：`+0.15%` 或 `-0.05%`）
- 正值用 `+` 表示，負值用 `-` 表示
- 無資料時顯示 `N/A`

**檢查項目**：
- [ ] 價差欄位存在
- [ ] 數值格式正確（百分比，2 位小數）
- [ ] 正負號正確
- [ ] `N/A` 顯示正確

### Step 3: 驗證淨收益欄位

**Expected**：
- 表格應包含「淨收益」欄位
- 每個交易對顯示淨收益百分比（例如：`+0.25%`）
- 顏色指示器：
  - 綠色背景：淨收益 > 0.1%（優勢機會）
  - 黃色背景：-0.05% ≤ 淨收益 ≤ 0.1%（持平機會）
  - 紅色背景：淨收益 < -0.05%（不利機會）
- 無資料時顯示 `N/A`

**檢查項目**：
- [ ] 淨收益欄位存在
- [ ] 數值格式正確（百分比，2 位小數）
- [ ] 顏色指示器正確
  - [ ] 綠色：淨收益 > 0.1%
  - [ ] 黃色：-0.05% ~ 0.1%
  - [ ] 紅色：< -0.05%
- [ ] `N/A` 顯示正確

### Step 4: 驗證淨收益計算

**手動計算公式**：
```
淨收益 = 費率差異 - |價差| - 0.3%
```

**範例驗證**：

| 費率差異 | 價差 | 預期淨收益 | 計算過程 |
|---------|------|-----------|---------|
| 0.5% | +0.15% | 0.05% | 0.5 - 0.15 - 0.3 = 0.05 |
| 0.5% | -0.15% | 0.05% | 0.5 - 0.15 - 0.3 = 0.05 |
| 0.3% | +0.1% | -0.1% | 0.3 - 0.1 - 0.3 = -0.1 |
| 0.8% | +0.2% | 0.3% | 0.8 - 0.2 - 0.3 = 0.3 |

**檢查項目**：
- [ ] 選擇一個交易對
- [ ] 記錄費率差異和價差
- [ ] 手動計算淨收益
- [ ] 驗證顯示的淨收益與計算結果一致

### Step 5: 驗證排序功能

**價差排序**：
1. 點擊「價差」欄位標題
2. 預期：列表按價差降序排列（最有利價差在最上方）
3. 再次點擊
4. 預期：列表按價差升序排列

**檢查項目**：
- [ ] 降序排列正確（最大值在最上方）
- [ ] 升序排列正確（最小值在最上方）
- [ ] 相同價差的項目按 symbol 字母順序排列
- [ ] WebSocket 更新時列表不會跳動

**淨收益排序**：
1. 點擊「淨收益」欄位標題
2. 預期：列表按淨收益降序排列（最高淨收益在最上方）
3. 再次點擊
4. 預期：列表按淨收益升序排列

**檢查項目**：
- [ ] 降序排列正確（最大值在最上方）
- [ ] 升序排列正確（最小值在最上方）
- [ ] 相同淨收益的項目按 symbol 字母順序排列
- [ ] WebSocket 更新時列表不會跳動

### Step 6: 驗證 WebSocket 即時更新

1. 保持頁面開啟
2. 等待 WebSocket 推送更新（每 5 秒）
3. 觀察價差和淨收益數值是否更新

**檢查項目**：
- [ ] 數值即時更新（每 5 秒）
- [ ] 顏色指示器隨淨收益變化
- [ ] 列表順序保持穩定（不跳動）
- [ ] 無視覺閃爍或抖動

---

## Automated Testing

### Unit Tests

```bash
# 執行所有單元測試
pnpm test

# 執行淨收益計算測試
pnpm test tests/unit/lib/net-return-calculator.test.ts

# 執行排序邏輯測試
pnpm test tests/unit/utils/sortComparator.test.ts
```

**預期結果**：
- 所有測試通過 ✅
- 覆蓋率 > 85%

### E2E Tests

```bash
# 執行所有 E2E 測試
pnpm test:e2e

# 執行價差和淨收益顯示測試
pnpm test:e2e tests/e2e/market-monitor-price-spread.spec.ts

# 以 UI 模式執行（可視化）
pnpm test:e2e:ui
```

**預期結果**：
- 所有測試通過 ✅
- 無 timeout 或斷言錯誤

---

## Validation Checklist

### Functional Requirements

- [ ] **FR-001**: 價差欄位顯示百分比（2 位小數）
- [ ] **FR-002**: 淨收益欄位顯示計算結果（2 位小數）
- [ ] **FR-003**: WebSocket 推送包含 priceDiffPercent 和 netReturn
- [ ] **FR-004**: 顏色指示器正確（綠/黃/紅）
- [ ] **FR-005**: 支援按價差排序（升序/降序）
- [ ] **FR-006**: 支援按淨收益排序（升序/降序）
- [ ] **FR-007**: 排序保持穩定性（相同值不跳動）
- [ ] **FR-008**: 顯示所有機會（不自動過濾）
- [ ] **FR-009**: 正確處理資料缺失（顯示 N/A）
- [ ] **FR-010**: 使用統一手續費常數（0.3%）

### Success Criteria

- [ ] **SC-001**: 頁面載入 < 3 秒顯示價差和淨收益
- [ ] **SC-002**: 淨收益計算 100% 準確
- [ ] **SC-003**: 排序操作 < 1 秒完成
- [ ] **SC-004**: WebSocket 更新不導致列表跳動
- [ ] **SC-005**: 顏色指示器易於理解
- [ ] **SC-006**: 正確處理所有邊緣情況
- [ ] **SC-007**: 100 個交易對排序 < 1 秒

---

## Troubleshooting

### 問題 1：價差或淨收益顯示 N/A

**原因**：
- 價格資料暫時無法取得
- WebSocket 連線中斷
- 後端計算錯誤

**解決方案**：
1. 檢查 WebSocket 連線狀態（應顯示「已連結」）
2. 檢查瀏覽器 console 是否有錯誤訊息
3. 檢查後端日誌：`docker compose logs -f`
4. 重新整理頁面

### 問題 2：淨收益計算不正確

**原因**：
- 手續費常數錯誤
- 計算公式實作錯誤
- 價差符號處理錯誤

**驗證步驟**：
1. 檢查 `src/lib/cost-constants.ts` 中的 `TOTAL_TRADING_COST_RATE`
2. 手動計算預期淨收益
3. 比對顯示的淨收益
4. 檢查後端日誌中的計算過程

### 問題 3：顏色指示器錯誤

**原因**：
- 閾值定義錯誤
- 條件判斷邏輯錯誤
- CSS 類別錯誤

**驗證步驟**：
1. 檢查淨收益數值
2. 驗證閾值：
   - 綠色：> 0.1%
   - 黃色：-0.05% ~ 0.1%
   - 紅色：< -0.05%
3. 檢查瀏覽器開發者工具中的元素 CSS 類別

### 問題 4：排序不穩定（列表跳動）

**原因**：
- WebSocket 更新觸發重新排序
- 快照排序未正確實作
- 次要排序 key 缺失

**解決方案**：
1. 確認使用 Feature 009 的穩定排序機制
2. 檢查次要排序 key（symbol）是否實作
3. 檢查排序時是否使用快照（snapshot）

### 問題 5：WebSocket 連線失敗

**原因**：
- 後端服務未啟動
- Port 衝突
- CORS 設定錯誤

**解決方案**：
1. 確認後端服務正在執行：`lsof -i :3001`
2. 檢查 WebSocket URL：`ws://localhost:3001`
3. 檢查瀏覽器 console 錯誤訊息
4. 重啟服務：`pnpm dev`

---

## Performance Testing

### Load Test

```bash
# 模擬 10 個並發用戶
for i in {1..10}; do
  curl http://localhost:3000/market-monitor &
done
wait

# 檢查 CPU 和記憶體使用率
docker stats
```

**預期結果**：
- CPU < 50%
- 記憶體 < 500MB
- WebSocket 推送延遲 < 100ms

### Sorting Performance

```bash
# 使用 Chrome DevTools Performance 工具
# 1. 開啟 DevTools（F12）
# 2. 切換到 Performance 標籤
# 3. 點擊 Record
# 4. 點擊淨收益欄位標題（觸發排序）
# 5. 停止 Recording
# 6. 檢查排序操作時間

# 預期：排序時間 < 50ms（100 個交易對）
```

---

## Edge Cases Testing

### 測試情境 1：所有交易對淨收益為負

**設定**：
- 調整測試資料，讓所有交易對的淨收益 < -0.05%

**預期**：
- 所有淨收益欄位顯示紅色
- 列表仍正常顯示（不自動隱藏）
- 排序功能正常

### 測試情境 2：價格資料全部缺失

**設定**：
- 模擬所有交易所價格 API 失敗

**預期**：
- 所有價差和淨收益顯示 N/A
- 其他欄位（費率、年化收益）正常顯示
- 無錯誤訊息或崩潰

### 測試情境 3：淨收益接近閾值

**設定**：
- 淨收益 = 0.099%（接近 0.1% 閾值）

**預期**：
- 顯示黃色（持平）
- 不會頻繁切換顏色

---

## Browser Compatibility

**已測試瀏覽器**：
- ✅ Chrome 120+
- ✅ Firefox 120+
- ✅ Safari 17+
- ✅ Edge 120+

**不支援**：
- ❌ IE 11 及更早版本

---

## Summary

- **手動測試**：6 個步驟，約 15 分鐘
- **自動化測試**：單元測試 + E2E 測試，約 5 分鐘
- **驗證清單**：17 項功能需求 + 7 項成功標準
- **常見問題**：5 個疑難排解方案
- **效能測試**：負載測試 + 排序效能測試

**完成此指南後，您應該能夠：**
1. ✅ 驗證價差和淨收益顯示正確
2. ✅ 確認計算公式準確
3. ✅ 測試排序功能穩定
4. ✅ 排查常見問題
5. ✅ 評估系統效能

**下一步**：執行 `/speckit.tasks` 生成詳細任務清單，開始實作！
