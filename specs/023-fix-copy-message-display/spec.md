# Feature Specification: 修正複製套利訊息顯示

**Feature Branch**: `023-fix-copy-message-display`
**Created**: 2025-11-25
**Status**: Draft
**Input**: User description: "修正複製套利訊息的計算錯誤和術語說明"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 正確顯示年化收益率 (Priority: P1)

用戶點擊「複製套利訊息」按鈕時，複製到剪貼簿的訊息應該顯示正確的年化收益率（如 800%），而不是錯誤計算的超大數值（如 40000%+）。

**Why this priority**: 這是核心問題，數值錯誤會誤導用戶做出錯誤的交易決策，可能導致財務損失。修正計算錯誤是最高優先級。

**Independent Test**: 可以通過複製一個套利機會訊息，檢查年化收益數值是否在合理範圍內（如 500-1500%）來獨立測試。

**Acceptance Scenarios**:

1. **Given** 一個資費差為 0.73% 的套利機會（8 小時基準）, **When** 用戶點擊複製按鈕, **Then** 複製的訊息顯示年化收益約 720-880%（而非 5840-8760%）
2. **Given** 一個資費差為 0.5% 的套利機會（8 小時基準）, **When** 用戶點擊複製按鈕, **Then** 複製的訊息顯示年化收益約 450-600%（而非 4000-6000%）

---

### User Story 2 - 顯示單次費率收益和時間基準 (Priority: P2)

用戶需要了解單次結算可以獲得多少收益，以及多久結算一次，以便評估短期和長期收益。

**Why this priority**: 幫助用戶理解收益來源和結算頻率，但不影響核心數值正確性。

**Independent Test**: 檢查複製的訊息是否包含「單次費率收益：約 X%（每 Y 小時結算一次）」的資訊。

**Acceptance Scenarios**:

1. **Given** 8 小時基準的套利機會, **When** 用戶點擊複製按鈕, **Then** 訊息包含「單次費率收益：約 0.73%（每 8 小時結算一次）」
2. **Given** 4 小時基準的套利機會, **When** 用戶點擊複製按鈕, **Then** 訊息包含「每 4 小時結算一次」的說明

---

### User Story 3 - 改善價格偏差說明 (Priority: P2)

用戶需要清楚了解價格偏差的正負值含義，以及這對平倉收益的影響。

**Why this priority**: 幫助用戶評估風險，但不是核心數值修正。

**Independent Test**: 檢查複製的訊息中價格偏差是否包含正負號、百分比數值和有利/不利的說明。

**Acceptance Scenarios**:

1. **Given** 價格偏差為 +0.15% 的套利機會, **When** 用戶點擊複製按鈕, **Then** 訊息顯示「價格偏差：+0.15%（✓ 做空方價格較高，有利平倉）」
2. **Given** 價格偏差為 -0.10% 的套利機會, **When** 用戶點擊複製按鈕, **Then** 訊息顯示「價格偏差：-0.10%（✗ 做多方價格較高，不利平倉）」
3. **Given** 沒有價格數據的套利機會, **When** 用戶點擊複製按鈕, **Then** 訊息顯示「價格偏差：N/A（無價格數據）」

---

### User Story 4 - 使用口語化術語和註解 (Priority: P3)

用戶能夠更容易理解訊息中的專業術語，透過括號註解和更口語化的表達方式。

**Why this priority**: 改善用戶體驗和可讀性，但不影響核心功能。

**Independent Test**: 檢查複製的訊息是否使用「收益評估」而非「利潤預估」，是否包含術語註解如「（資金費率價差）」。

**Acceptance Scenarios**:

1. **Given** 任何套利機會, **When** 用戶點擊複製按鈕, **Then** 訊息標題使用「📈 收益評估：」而非「📈 目前利潤預估：」
2. **Given** 任何套利機會, **When** 用戶點擊複製按鈕, **Then** 年化收益後附註「（資金費率價差）」說明
3. **Given** 任何套利機會, **When** 用戶點擊複製按鈕, **Then** 訊息包含風險提示章節，說明價格偏差和資金費率波動的風險

---

### Edge Cases

- 當價格數據缺失時，價格偏差應顯示「N/A（無價格數據）」
- 當年化收益為 0 或負數時，應如何顯示？（建議顯示實際值並加警告）
- 當資費差非常小（< 0.01%）時，格式化是否正確？
- 不同時間基準（1h, 4h, 8h, 24h）下的說明是否正確對應？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須正確計算並顯示年化收益率，不得將已是百分比的數值再次乘以 100
- **FR-002**: 系統必須顯示單次費率收益的精確百分比（保留兩位小數）
- **FR-003**: 系統必須在單次費率收益後標註時間基準（如「每 8 小時結算一次」）
- **FR-004**: 系統必須為價格偏差加上正負號（+/-）並說明對平倉的影響（有利/不利）
- **FR-005**: 系統必須在年化收益後加上術語註解「（資金費率價差）」
- **FR-006**: 系統必須將訊息標題從「目前利潤預估」改為「收益評估」
- **FR-007**: 系統必須在風險提示中說明價格偏差為負時可能影響平倉收益
- **FR-008**: 系統必須在風險提示中說明資金費率可能波動，需要持續觀察
- **FR-009**: 當價格數據不存在時，系統必須顯示「N/A（無價格數據）」
- **FR-010**: 年化收益的估值範圍應使用 ±10% 波動（而非原先的 ±20%）

### Key Entities

- **MarketRate**: 市場費率數據，包含交易對、交易所數據、最佳套利對、狀態和時間戳
- **BestArbitragePair**: 最佳套利對資訊，包含做多/做空交易所、利差百分比、年化收益、價格偏差百分比
- **TimeBasis**: 時間基準（1h, 4h, 8h, 24h），影響費率計算和結算頻率說明

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 複製的訊息中，年化收益數值必須在合理範圍內（100-2000%），不得出現超過 10000% 的異常值
- **SC-002**: 用戶能夠從複製訊息中清楚識別單次結算收益和結算頻率（每 X 小時）
- **SC-003**: 用戶能夠從價格偏差的正負號和說明文字，立即判斷是否有利於平倉
- **SC-004**: 100% 的複製訊息包含風險提示章節，涵蓋價格偏差和費率波動兩項風險
- **SC-005**: 訊息中所有專業術語（年化收益、資金費率價差）都有括號註解或口語化說明
- **SC-006**: 計算錯誤修正後，用戶不再因為錯誤的高收益數值而產生錯誤預期

## Out of Scope *(optional)*

以下項目不在此功能範圍內：

- 修改後端數據計算邏輯（後端已正確計算，問題僅在前端顯示）
- 修改套利機會判定門檻（Feature 022 已處理）
- 新增其他交易所或交易對
- 修改 WebSocket 推送邏輯
- 修改表格中的顯示格式（僅修正複製訊息）

## Assumptions *(optional)*

- 後端傳送的 `spreadPercent` 和 `priceDiffPercent` 已經是百分比形式（如 0.5 表示 0.5%）
- 後端傳送的 `annualizedReturn` 已經是年化收益百分比（如 800 表示 800%）
- 用戶使用的是支援 `navigator.clipboard` API 的現代瀏覽器
- 訊息模板使用繁體中文和 Emoji 圖示
- 時間基準資訊可以從前端狀態或 rate 物件中獲取

## Dependencies *(optional)*

- 依賴 Feature 022（年化收益門檻套利機會偵測）已完成，確保後端正確計算年化收益
- 依賴現有的 `MarketRate` 和 `BestArbitragePair` 類型定義
- 依賴現有的複製按鈕 UI 組件（RateRow.tsx）
