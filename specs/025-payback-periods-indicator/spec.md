# Feature Specification: 價差回本週期指標

**Feature Branch**: `025-payback-periods-indicator`
**Created**: 2025-01-28
**Status**: Draft
**Input**: User description: "加一個指標，計算價差和資費差，如果價差方向不好的話，需要收幾次資費才能把價差賺回來"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 價差不利時顯示回本次數 (Priority: P1)

當交易者查看市場監控頁面時，如果某個交易對的價差對建倉不利（做多交易所價格高於做空交易所），系統應該清楚告知需要收取多少次資金費率才能抵銷這個價差損失。

**Why this priority**: 這是核心價值所在。交易者最需要知道的是當價差不利時，是否值得開倉，以及需要持倉多久才能回本。這是風險評估的關鍵資訊。

**Independent Test**: 可以透過設定測試資料（價差 -0.15%，費率差 0.05%）來驗證系統正確顯示「需收取 3.0 次資費才能回本」，並且可以獨立於其他功能進行測試和展示。

**Acceptance Scenarios**:

1. **Given** 某交易對的價差為 -0.15%（不利），費率差為 0.05%
   **When** 用戶查看市場監控表格
   **Then** 在價差欄位下方顯示「⚠️ 需 3.0 次資費回本」

2. **Given** 某交易對的價差為 -0.30%（不利），費率差為 0.10%
   **When** 用戶查看該交易對
   **Then** 顯示「⚠️ 需 3.0 次資費回本」

3. **Given** 某交易對的價差為 -0.50%（嚴重不利），費率差為 0.01%（很小）
   **When** 用戶查看該交易對
   **Then** 顯示警告訊息「❌ 回本次數過多 (50+ 次)」

---

### User Story 2 - 價差有利時顯示正面指標 (Priority: P1)

當價差對建倉有利時（做空交易所價格高於做多交易所），系統應該清楚標示這是一個立即有正報酬的機會。

**Why this priority**: 與 P1 同等重要。交易者需要快速識別哪些機會是價差有利的，這些是最佳的套利機會。明確的視覺標示可以幫助快速決策。

**Independent Test**: 可以透過設定價差為正值（+0.15%）來驗證系統顯示「✓ 價差有利」的綠色標記，並可獨立測試。

**Acceptance Scenarios**:

1. **Given** 某交易對的價差為 +0.15%（有利）
   **When** 用戶查看市場監控表格
   **Then** 在價差欄位下方顯示「✓ 價差有利」（綠色文字）

2. **Given** 某交易對的價差為 +0.05%（輕微有利）
   **When** 用戶查看該交易對
   **Then** 顯示「✓ 價差有利」

3. **Given** 某交易對的價差為 0%（中性）
   **When** 用戶查看該交易對
   **Then** 顯示「✓ 價差有利」（因為沒有損失）

---

### User Story 3 - 提供詳細的回本資訊工具提示 (Priority: P2)

當用戶將滑鼠移到回本次數指標上時，應該看到詳細的計算說明，包括當前價差、費率差異、預估回本時間等資訊。

**Why this priority**: 這是輔助性功能，可以幫助用戶理解計算邏輯，但不是必須在 MVP 中實作。可以在核心功能完成後加入。

**Independent Test**: 可以透過 hover 操作來測試 Tooltip 是否正確顯示詳細資訊，不依賴其他功能。

**Acceptance Scenarios**:

1. **Given** 某交易對顯示「需 3.0 次資費回本」
   **When** 用戶將滑鼠移到該指標上
   **Then** 顯示 Tooltip 包含：當前價差 -0.15%、費率差 0.05%、回本次數 3.0、預估時間（基於時間基準）

2. **Given** 某交易對顯示「價差有利」
   **When** 用戶將滑鼠移到該指標上
   **Then** 顯示 Tooltip 說明「價差有利表示建倉即有正報酬」

3. **Given** 時間基準切換為 1 小時
   **When** 用戶查看回本指標的 Tooltip
   **Then** Tooltip 中的預估時間應更新為「約 3.0 小時」（而非 24 小時）

---

### User Story 4 - 在複製訊息中包含回本資訊 (Priority: P2)

當用戶點擊複製按鈕時，複製的訊息應該包含價差回本資訊，方便分享給團隊成員或記錄決策依據。

**Why this priority**: 這是便利性功能。雖然有價值，但用戶可以從畫面上手動記錄這些資訊。在核心顯示功能完成後再加入。

**Independent Test**: 可以點擊複製按鈕並檢查剪貼簿內容，驗證是否包含回本資訊。

**Acceptance Scenarios**:

1. **Given** 某交易對的價差為 -0.15%，需 3.0 次資費回本
   **When** 用戶點擊複製按鈕
   **Then** 複製的訊息包含「⏱️ 價差回本：需收取 3.0 次資費（約 24 小時）」

2. **Given** 某交易對的價差有利
   **When** 用戶點擊複製按鈕
   **Then** 複製的訊息包含「✓ 價差有利：建倉即有正報酬」

3. **Given** 某交易對無法回本（回本次數過多）
   **When** 用戶點擊複製按鈕
   **Then** 複製的訊息包含「❌ 價差回本：回本次數過多，不建議建倉」

---

### User Story 5 - 處理無價格數據的情況 (Priority: P3)

當某些交易對暫時沒有價格數據時，系統應該優雅地處理這種情況，顯示適當的提示訊息。

**Why this priority**: 這是邊界情況處理。雖然重要，但發生頻率較低。可以在其他核心功能穩定後再完善。

**Independent Test**: 可以透過模擬無價格數據的情況來測試是否正確顯示「N/A（無價格數據）」。

**Acceptance Scenarios**:

1. **Given** 某交易對暫時沒有價格數據（price = null）
   **When** 用戶查看該交易對
   **Then** 在價差欄位顯示「N/A」，回本指標顯示「無價格數據」

2. **Given** 某交易對的費率差為 0%
   **When** 用戶查看該交易對
   **Then** 回本指標顯示「無法回本（費率差為零）」

3. **Given** 某交易對從無價格數據恢復為有數據
   **When** 數據更新後
   **Then** 回本指標應該即時更新為正確的計算結果

---

### Edge Cases

- **當費率差為零時**：顯示「無法回本（費率差為零）」，因為沒有資金費率收益
- **當回本次數超過 100 次時**：顯示「回本次數過多 (X+ 次)」並標記為紅色警告
- **當價格數據為 null 或 undefined 時**：顯示「N/A（無價格數據）」
- **當時間基準切換時**：回本時間預估應即時更新（例如從 8h 基準的 24 小時更新為 1h 基準的 3 小時）
- **當價差非常小（接近 0）但為負時**：即使回本次數很少，也應該顯示回本資訊
- **當同時有多個交易對更新時**：所有回本指標應該同步更新，不會出現不一致的狀態

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須計算價差回本次數，公式為：回本次數 = |價差百分比| ÷ 費率差異百分比
- **FR-002**: 當價差百分比大於或等於 0 時，系統必須顯示「價差有利」標記
- **FR-003**: 當價差百分比小於 0 時，系統必須計算並顯示需要的回本次數（精確到小數點後 1 位）
- **FR-004**: 系統必須在市場監控表格的價差欄位中顯示回本指標
- **FR-005**: 當回本次數超過 100 次時，系統必須顯示警告訊息而非具體數字
- **FR-006**: 系統必須提供工具提示（Tooltip）顯示詳細的計算資訊
- **FR-007**: 工具提示必須包含：當前價差、費率差異、回本次數、預估回本時間（基於當前時間基準）
- **FR-008**: 系統必須在複製功能的訊息中包含價差回本資訊
- **FR-009**: 當價格數據為空（null）時，系統必須顯示「N/A（無價格數據）」
- **FR-010**: 當費率差異為零或負數時，系統必須顯示「無法回本（費率差為零）」
- **FR-011**: 回本指標必須使用顏色編碼：綠色（有利）、橙色（需回本）、紅色（無法回本或次數過多）
- **FR-012**: 預估回本時間必須根據當前選擇的時間基準（1h/4h/8h/24h）動態計算
- **FR-013**: 系統必須在時間基準切換時即時更新所有回本時間預估
- **FR-014**: 回本指標的計算必須在前端即時進行，不依賴後端額外計算
- **FR-015**: 系統必須處理極端情況（如價差為零、費率差為零、回本次數極大等）

### Key Entities

- **回本次數 (Payback Periods)**: 需要收取資金費率的次數才能抵銷價差損失
  - 計算來源：價差百分比、費率差異百分比
  - 顯示格式：小數點後 1 位
  - 狀態類型：有利 / 需回本 / 無法回本 / 無數據

- **預估回本時間 (Estimated Payback Time)**: 根據時間基準計算的實際時間
  - 計算公式：回本次數 × 時間基準（小時）
  - 顯示格式：「約 X.X 小時」或「約 X.X 天」
  - 依賴：當前選擇的時間基準

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 交易者可以在 1 秒內從市場監控頁面看到所有交易對的價差回本資訊（包含有利/不利標記）
- **SC-002**: 95% 以上的交易對能正確顯示回本次數或「價差有利」標記（排除無價格數據的情況）
- **SC-003**: 當時間基準切換時，所有回本時間預估在 500 毫秒內完成更新
- **SC-004**: 用戶可以透過滑鼠 hover 在 0.5 秒內看到詳細的計算說明 Tooltip
- **SC-005**: 複製的訊息 100% 包含正確的價差回本資訊
- **SC-006**: 系統能正確處理 100% 的邊界情況（無價格、費率為零、回本次數過多等）且不會崩潰
- **SC-007**: 回本指標的計算誤差在 0.1 次以內（與手動計算對比）
- **SC-008**: 200 個交易對同時更新時，前端計算和渲染時間在 100 毫秒內完成
- **SC-009**: 用戶在使用此功能後，能夠在 30 秒內判斷一個套利機會是否值得建倉（基於價差回本資訊）
- **SC-010**: 減少因價差不利而開倉後虧損的案例至少 50%（透過提供明確的回本資訊）

## Assumptions *(optional)*

- 價差計算已經在現有系統中實作並正確運作（來自 `BestArbitragePair.priceDiffPercent`）
- 費率差異已經在現有系統中計算並可用（來自 `BestArbitragePair.spreadPercent`）
- 時間基準切換功能已經實作並穩定運作
- 使用者理解資金費率的結算週期概念（1h/4h/8h）
- 回本次數的計算不考慮手續費（手續費在其他欄位已經顯示）
- 系統假設費率差異在持倉期間保持相對穩定（實際可能波動）
- 前端計算能力足夠處理 200+ 個交易對的即時計算
- 使用者主要關注的是「是否值得開倉」而非精確的回本時間點

## Out of Scope *(optional)*

- 不包含歷史回本時間的統計或趨勢分析
- 不包含自動開倉/平倉的建議或執行
- 不包含考慮手續費後的淨回本次數（手續費已在其他欄位顯示）
- 不包含預測未來費率變化對回本時間的影響
- 不包含多重時間基準的同時顯示（僅顯示當前選擇的基準）
- 不包含回本次數的圖表或視覺化分析
- 不包含將回本資訊儲存到資料庫或歷史記錄
- 不包含根據回本次數自動篩選或排序交易對的功能
- 不包含移動端（Mobile）優化的特殊顯示方式
- 不包含回本次數的通知或警示功能

## Dependencies *(optional)*

- 依賴現有的 `BestArbitragePair` 資料結構中的 `priceDiffPercent` 欄位
- 依賴現有的 `BestArbitragePair` 資料結構中的 `spreadPercent` 欄位
- 依賴現有的時間基準（`timeBasis`）狀態管理
- 依賴現有的 WebSocket 資料推送機制（每 5 秒更新一次）
- 依賴現有的 `RatesTable` 和 `RateRow` 組件架構
- 依賴現有的 Radix UI Tooltip 組件庫
- 依賴現有的複製功能（`formatArbitrageMessage`）

## Risks *(optional)*

- **效能風險**：如果交易對數量超過 500 個，前端即時計算可能造成 UI 卡頓
  - 緩解措施：使用 React.memo 優化渲染，僅在必要時重新計算

- **使用者誤解風險**：用戶可能誤解「回本次數」為保證獲利的次數
  - 緩解措施：在 Tooltip 中加入免責聲明，說明費率可能波動

- **資料不完整風險**：某些交易所可能暫時沒有價格數據
  - 緩解措施：優雅降級，顯示「N/A」並在數據恢復後自動更新

- **計算精度風險**：JavaScript 浮點數運算可能導致精度問題
  - 緩解措施：使用 `toFixed(1)` 限制小數位數，並在單元測試中驗證精度

- **視覺混亂風險**：表格欄位過多可能影響可讀性
  - 緩解措施：將回本指標放在價差欄位下方，而非新增獨立欄位

