# Feature Specification: 手動開倉功能

**Feature Branch**: `033-manual-open-position`
**Created**: 2025-12-17
**Status**: Draft
**Input**: User description: "手動開倉功能：用戶看到滿意的套利機會後，可以透過一鍵開倉功能，同時在兩個交易所開立相應的多頭和空頭倉位，支援餘額檢查、雙邊開倉協調、防止重複開倉"

## Glossary

| 術語 | 英文 | 定義 |
|------|------|------|
| 開倉 | Open Position | 在兩個交易所同時建立 Long 和 Short 倉位的操作 |
| 持倉 | Position | 用戶在兩個交易所同時開立的一對多空倉位（hedge position） |
| 保證金 | Margin | 開倉所需的初始資金，取決於倉位大小和槓桿倍數 |
| 槓桿 | Leverage | 槓桿倍數，支援 1x 或 2x（用戶可選） |
| 雙邊開倉 | Bilateral Opening | 同時在兩個交易所執行相反方向的開倉操作 |
| 回滾 | Rollback | 當一邊開倉失敗時，自動平倉已成功的另一邊 |

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 從套利機會開倉 (Priority: P1)

用戶在「套利機會」頁面或「市場監控」頁面看到一個滿意的套利機會，點擊「開倉」按鈕後，系統顯示開倉確認對話框，用戶輸入倉位大小並確認後，系統同時在兩個交易所執行開倉操作。

**Why this priority**: 這是手動開倉功能的核心流程，沒有這個功能用戶無法執行任何交易。這是從「監控」到「交易」的關鍵步驟。

**Independent Test**: 可以透過在測試環境（或使用小額資金）中選擇一個套利機會、輸入倉位大小並執行開倉來測試。測試成功標準是系統能夠同時在兩個交易所開倉，並正確記錄倉位資訊。

**Acceptance Scenarios**:

1. **Given** 用戶已登入且已設定兩個交易所的 API Key，**When** 在「套利機會」頁面點擊某個機會的「開倉」按鈕，**Then** 系統顯示開倉確認對話框，包含交易對、交易所、建議方向（Long/Short）、即時價格和費率資訊

2. **Given** 用戶在開倉對話框中，**When** 輸入倉位數量（如 0.1 BTC），**Then** 系統即時計算並顯示：預估倉位價值（USDT）、預估所需保證金（兩個交易所各自需要的金額）、預估手續費、當前餘額是否充足

3. **Given** 用戶輸入了有效的倉位大小且餘額充足，**When** 點擊「確認開倉」按鈕，**Then** 系統同時在兩個交易所執行開倉（一個 Long、一個 Short），並顯示執行進度

4. **Given** 開倉成功完成，**When** 系統完成雙邊開倉，**Then** 顯示成功訊息，包含兩個交易所的成交價格、實際手續費，並自動跳轉到「持倉管理」頁面

5. **Given** 用戶在開倉對話框中，**When** 點擊「取消」按鈕，**Then** 關閉對話框，不執行任何交易

---

### User Story 2 - 餘額不足處理 (Priority: P1)

當用戶嘗試開倉但任一交易所的餘額不足時，系統在執行前即時檢查並拒絕開倉，向用戶顯示明確的錯誤訊息。

**Why this priority**: 餘額檢查是保護用戶資金的關鍵功能，防止因餘額不足導致單邊開倉的風險。與核心開倉流程同等重要。

**Independent Test**: 可以透過設定一個大於帳戶餘額的倉位大小來測試。測試成功標準是系統正確識別餘額不足並拒絕開倉。

**Acceptance Scenarios**:

1. **Given** 用戶在開倉對話框輸入倉位大小，**When** 任一交易所的可用餘額不足以支付所需保證金，**Then** 系統即時顯示警告訊息，標示哪個交易所餘額不足，並禁用「確認開倉」按鈕

2. **Given** 用戶的 Binance 餘額為 1000 USDT，OKX 餘額為 500 USDT，槓桿為 2x，BTC 價格約 40000 USDT，**When** 用戶輸入 0.05 BTC 的倉位數量（價值約 2000 USDT，需要每邊約 1100 USDT 保證金含 10% 緩衝），**Then** 系統顯示「OKX 餘額不足：需要 1100 USDT，可用 500 USDT」

3. **Given** 系統顯示餘額不足警告，**When** 用戶調整倉位大小至餘額可負擔的範圍，**Then** 警告消失，「確認開倉」按鈕恢復可用

---

### User Story 3 - 開倉失敗回滾 (Priority: P2)

當雙邊開倉過程中，其中一個交易所成功而另一個失敗時，系統自動嘗試回滾已成功的開倉，以避免用戶承擔單邊風險。

**Why this priority**: 這是風險控制的重要功能，但發生機率較低。核心開倉流程穩定後再完善此功能。

**Independent Test**: 可以透過模擬一個交易所 API 失敗的情況來測試。測試成功標準是系統能正確回滾已成功的開倉。

**Acceptance Scenarios**:

1. **Given** 系統正在執行雙邊開倉，Binance 開倉成功，**When** OKX 開倉因 API 錯誤失敗，**Then** 系統自動嘗試平倉 Binance 的倉位（最多重試 3 次）

2. **Given** 回滾嘗試成功，**When** Binance 倉位已平倉，**Then** 系統向用戶顯示「開倉失敗：OKX 開倉失敗，已自動回滾 Binance 倉位」的訊息

3. **Given** 回滾嘗試失敗（3 次都失敗），**When** 無法平倉已成功的部分，**Then** 系統將該倉位標記為「異常」狀態，記錄到審計日誌，並向用戶顯示警告訊息，建議手動處理

4. **Given** 雙邊開倉都失敗，**When** 系統偵測到完全失敗，**Then** 向用戶顯示失敗原因（如 API 錯誤、網路超時），無需回滾

---

### User Story 4 - 防止重複開倉 (Priority: P2)

當用戶快速多次點擊「開倉」按鈕，或在多個裝置上同時操作時，系統防止對同一交易對重複開倉。

**Why this priority**: 這是防止用戶誤操作導致損失的重要功能，但可以在核心流程穩定後再完善。

**Independent Test**: 可以透過快速連續點擊「確認開倉」按鈕來測試。測試成功標準是系統只執行一次開倉。

**Acceptance Scenarios**:

1. **Given** 用戶點擊「確認開倉」按鈕，**When** 開倉操作正在進行中，**Then** 按鈕立即禁用並顯示載入狀態，防止重複點擊

2. **Given** 用戶對 BTCUSDT 正在執行開倉操作，**When** 用戶在另一個瀏覽器視窗嘗試對同一 BTCUSDT 開倉，**Then** 系統拒絕第二個請求，顯示「該交易對正在開倉中，請稍後再試」

3. **Given** 用戶對 BTCUSDT 開倉操作完成，**When** 用戶嘗試對 ETHUSDT 開倉，**Then** 系統正常執行（不同交易對可以並行）

---

### User Story 5 - 從市場監控快速開倉 (Priority: P3)

用戶在「市場監控」頁面看到達到套利閾值的交易對，可以直接點擊「快速開倉」按鈕，系統自動填入最佳套利方向（BUY/SELL 交易所），用戶只需輸入倉位大小即可開倉。

**Why this priority**: 這是便利性功能，提升用戶體驗，但核心開倉功能完成後再實作。

**Independent Test**: 可以透過在市場監控頁面對一個達到閾值的交易對點擊「快速開倉」來測試。

**Acceptance Scenarios**:

1. **Given** 用戶在「市場監控」頁面，某交易對顯示為「機會」狀態（費率差 ≥ 0.5%），**When** 點擊該行的「快速開倉」按鈕，**Then** 開倉對話框自動填入：交易對、標記為 BUY 的交易所做 Long、標記為 SELL 的交易所做 Short

2. **Given** 某交易對狀態為「正常」（費率差 < 0.4%），**When** 查看該行，**Then** 不顯示「快速開倉」按鈕（或按鈕禁用）

---

### Edge Cases

- **網路斷線**: 用戶在開倉過程中網路斷線，系統如何確保交易狀態一致性？
- **價格劇變**: 在開倉確認和實際執行之間，如果價格劇烈變動導致滑點過大，系統如何處理？
- **API 限流**: 當交易所 API 達到請求限制時，如何處理開倉請求？
- **餘額變化**: 用戶在開倉對話框輸入倉位大小後、實際執行前，餘額被其他操作使用，系統如何處理？
- **交易所維護**: 某個交易所正在維護或暫停交易時，系統如何提示用戶？
- **最小交易量**: 用戶輸入的倉位大小低於交易所的最小交易量限制時，系統如何處理？

## Requirements *(mandatory)*

### Functional Requirements

#### 開倉對話框
- **FR-001**: 系統必須在用戶點擊「開倉」按鈕後顯示開倉確認對話框
- **FR-002**: 開倉對話框必須顯示：交易對名稱、兩個交易所名稱、建議的倉位方向（Long/Short）、即時價格、即時資金費率、費率差異
- **FR-003**: 系統必須提供倉位數量輸入欄位（幣本位，如 0.1 BTC）
- **FR-003-1**: 系統必須提供槓桿倍數選擇（1x 或 2x），預設為 1x
- **FR-003-2**: 系統必須根據即時價格計算並顯示預估倉位價值（USDT）
- **FR-004**: 系統必須即時計算並顯示預估所需保證金（倉位價值 / 槓桿）
- **FR-005**: 系統必須顯示兩個交易所各自的預估手續費（Taker Fee 0.05% × 倉位價值）
- **FR-005-1**: 系統必須提供「刷新市場數據」按鈕，讓用戶可以手動獲取最新的即時價格和資金費率
- **FR-005-2**: 點擊刷新按鈕後，系統必須顯示最後更新時間（如：最後更新 10:30:45）
- **FR-005-3**: 刷新過程中，按鈕必須顯示載入狀態，防止重複點擊

#### 餘額驗證
- **FR-006**: 系統必須在用戶輸入倉位大小時即時查詢兩個交易所的可用餘額
- **FR-007**: 系統必須驗證每個交易所的可用餘額 ≥ 所需保證金 × 1.1（預留 10% 緩衝）
- **FR-008**: 當餘額不足時，系統必須顯示明確的錯誤訊息，標示哪個交易所、需要多少、可用多少
- **FR-009**: 當餘額不足時，系統必須禁用「確認開倉」按鈕

#### 開倉執行
- **FR-010**: 系統必須同時在兩個交易所執行開倉操作（一個 Long、一個 Short）
- **FR-011**: 系統必須使用市價單（Market Order）來確保開倉成功率
- **FR-012**: 系統必須在開倉過程中顯示執行進度（如：正在 Binance 開倉... 正在 OKX 開倉...）
- **FR-013**: 開倉成功後，系統必須顯示成功訊息，包含兩個交易所的實際成交價格和手續費

#### 開倉記錄
- **FR-014**: 系統必須記錄每次開倉的詳細資訊：交易對、兩個交易所名稱、倉位方向、開倉價格、倉位大小、槓桿倍數、開倉時間、開倉時的資金費率
- **FR-015**: 開倉成功後，系統必須在「持倉管理」頁面顯示新開立的倉位

#### 失敗處理
- **FR-016**: 當雙邊都開倉失敗時，系統必須顯示失敗原因（API 錯誤、網路超時、餘額不足等）
- **FR-017**: 當一邊成功一邊失敗時，系統必須自動嘗試回滾已成功的開倉（最多重試 3 次：立即、1 秒後、2 秒後）
- **FR-018**: 當回滾失敗時，系統必須將倉位標記為「異常」狀態，記錄到審計日誌，並向用戶顯示警告
- **FR-019**: 系統必須記錄所有開倉失敗和回滾操作到審計日誌

#### 並發控制
- **FR-020**: 系統必須在用戶點擊「確認開倉」後立即禁用按鈕，直到操作完成或超時（30 秒）
- **FR-021**: 系統必須防止同一用戶對同一交易對同時執行多個開倉操作
- **FR-022**: 系統必須允許用戶對不同交易對並行開倉

#### 快速開倉
- **FR-023**: 系統必須在「市場監控」頁面的「機會」狀態行顯示「快速開倉」按鈕
- **FR-024**: 點擊「快速開倉」時，系統必須自動填入交易對和最佳套利方向

### Key Entities

- **Position（持倉）**: 代表用戶在兩個交易所同時持有的一對對沖倉位
  - 屬性：交易對、Long 交易所、Short 交易所、開倉價格（兩邊）、倉位大小、槓桿、開倉時間、開倉費率、狀態（ACTIVE/ABNORMAL/CLOSED）
  - 關聯：屬於某個用戶

- **PositionLeg（倉位單邊）**: 代表單一交易所的倉位詳情
  - 屬性：交易所、方向（Long/Short）、開倉價格、倉位大小、手續費、訂單 ID
  - 關聯：屬於某個 Position

- **OpenPositionRequest（開倉請求）**: 代表一次開倉操作的請求記錄
  - 屬性：用戶 ID、交易對、請求時間、狀態（PENDING/EXECUTING/SUCCESS/FAILED/ROLLED_BACK）、失敗原因
  - 關聯：可能產生一個 Position

- **AuditLog（審計日誌）**: 記錄所有開倉相關的操作
  - 屬性：操作類型、操作者、操作時間、操作詳情、IP 位址
  - 關聯：與用戶和 Position 相關

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用戶可以在 30 秒內完成從點擊「開倉」到成功建立倉位的完整流程
- **SC-002**: 雙邊開倉的成功率達到 95% 以上（排除餘額不足和網路極端情況）
- **SC-003**: 當任一交易所開倉失敗時，系統能在 5 秒內完成回滾嘗試
- **SC-004**: 餘額驗證能夠 100% 阻止餘額不足的開倉請求
- **SC-005**: 並發控制能夠 100% 防止同一用戶對同一交易對的重複開倉
- **SC-006**: 所有開倉操作（成功、失敗、回滾）的審計日誌記錄完整性達到 100%
- **SC-007**: 開倉對話框的餘額和保證金計算在用戶輸入後 1 秒內更新顯示

## Assumptions

1. **槓桿倍數**: 支援 1x 或 2x 槓桿，用戶可在開倉對話框中選擇
2. **訂單類型**: 使用市價單（Market Order），不支援限價單
3. **倉位輸入**: 以幣本位數量輸入（如 0.1 BTC），確保兩邊數量完全對沖
4. **支援交易所**: 目前支援 Binance、OKX、MEXC、Gate.io 四個交易所
5. **最小倉位**: 遵循各交易所的最小交易量限制
6. **保證金模式**: 使用 USDT 本位永續合約（Linear Perpetual）
7. **API Key 權限**: 用戶的 API Key 已具備交易權限

## Dependencies

### 內部依賴
- 006-web-trading-platform 的用戶認證系統（JWT Session）
- 006-web-trading-platform 的 API Key 管理和加密解密服務
- 006-web-trading-platform 的套利機會和市場監控頁面
- 006-web-trading-platform 的 WebSocket 基礎設施

### 外部依賴
- Binance Futures API（開倉、查詢餘額、平倉）
- OKX API（開倉、查詢餘額、平倉）
- MEXC API（開倉、查詢餘額、平倉）
- Gate.io API（開倉、查詢餘額、平倉）
- Redis（分散式鎖，防止並發開倉）
