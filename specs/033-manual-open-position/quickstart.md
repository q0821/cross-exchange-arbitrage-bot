# Quickstart: 手動開倉功能

**Date**: 2025-12-17
**Feature**: 033-manual-open-position

## 概述

本指南說明如何使用手動開倉功能在兩個交易所同時建立對沖倉位。

## 前置條件

1. **用戶帳號**：已註冊並登入平台
2. **API Key 設定**：至少設定兩個交易所的 API Key（需要交易權限）
3. **餘額**：兩個交易所都有足夠的 USDT 餘額
4. **Redis**：確保 Redis 服務正在運行（用於分散式鎖）

## 使用流程

### 1. 從市場監控頁面開倉

1. 進入「市場監控」頁面
2. 找到顯示為「🔔 機會」狀態的交易對（費率差 ≥ 0.5%）
3. 點擊該行的「快速開倉」按鈕
4. 系統自動填入：
   - 交易對
   - Long 交易所（費率最低）
   - Short 交易所（費率最高）
5. 輸入倉位大小（USDT）
6. 選擇槓桿（1x 或 2x）
7. 確認預估保證金和手續費
8. 點擊「確認開倉」

### 2. 開倉對話框說明

```
┌─────────────────────────────────────────┐
│            開倉確認                      │
├─────────────────────────────────────────┤
│  交易對: BTCUSDT                        │
│                                         │
│  Long 交易所: Binance                   │
│  即時價格: $42,150.50                   │
│  資金費率: 0.01%                        │
│                                         │
│  Short 交易所: OKX                      │
│  即時價格: $42,148.30                   │
│  資金費率: 0.08%                        │
│                                         │
│  費率差異: 0.07% (預期年化: 306%)       │
├─────────────────────────────────────────┤
│  倉位大小: [      1000      ] USDT      │
│  槓桿倍數: ( ) 1x  (•) 2x               │
├─────────────────────────────────────────┤
│  預估保證金:                            │
│    Binance: 550 USDT (含10%緩衝)        │
│    OKX:     550 USDT (含10%緩衝)        │
│                                         │
│  預估手續費:                            │
│    Binance: 0.50 USDT                   │
│    OKX:     0.50 USDT                   │
│                                         │
│  餘額狀態:                              │
│    Binance: 2,000 USDT ✓ 充足          │
│    OKX:     1,500 USDT ✓ 充足          │
├─────────────────────────────────────────┤
│  [ 取消 ]              [ 確認開倉 ]     │
└─────────────────────────────────────────┘
```

### 3. 開倉進度顯示

點擊「確認開倉」後，系統顯示執行進度：

```
┌─────────────────────────────────────────┐
│            開倉進行中                    │
├─────────────────────────────────────────┤
│  [████████░░░░░░░░░░] 40%               │
│                                         │
│  ✓ 驗證餘額完成                         │
│  ✓ 在 Binance 開多倉完成                │
│  → 正在 OKX 開空倉...                   │
│  ○ 完成開倉                             │
├─────────────────────────────────────────┤
│  請勿關閉此視窗                          │
└─────────────────────────────────────────┘
```

### 4. 開倉成功

```
┌─────────────────────────────────────────┐
│            ✅ 開倉成功                   │
├─────────────────────────────────────────┤
│  Long 倉位 (Binance):                   │
│    訂單號: 123456789                    │
│    成交價: $42,150.50                   │
│    數量: 0.0237 BTC                     │
│    手續費: 0.50 USDT                    │
│                                         │
│  Short 倉位 (OKX):                      │
│    訂單號: 987654321                    │
│    成交價: $42,148.30                   │
│    數量: 0.0237 BTC                     │
│    手續費: 0.49 USDT                    │
├─────────────────────────────────────────┤
│  [ 查看持倉 ]        [ 繼續監控 ]       │
└─────────────────────────────────────────┘
```

## 錯誤處理

### 餘額不足

如果任一交易所餘額不足：
- 「確認開倉」按鈕禁用
- 顯示紅色警告訊息

```
⚠️ OKX 餘額不足：需要 550 USDT，可用 300 USDT
```

### 開倉失敗

如果開倉失敗，系統會：
1. 嘗試回滾已成功的一邊（最多 3 次）
2. 顯示失敗原因

```
❌ 開倉失敗

OKX API 返回錯誤：Insufficient margin
已自動回滾 Binance 倉位

[ 返回市場監控 ]
```

### 回滾失敗（需手動處理）

如果無法自動回滾：

```
⚠️ 需要手動處理

Binance 倉位已開立但 OKX 失敗
系統無法自動回滾，請手動處理：

交易所: Binance
方向: Long
數量: 0.0237 BTC
訂單號: 123456789

請前往 Binance 手動平倉此倉位。

[ 我知道了 ]
```

## API 使用示例

### 開倉 API

```bash
POST /api/positions/open
Content-Type: application/json
Cookie: session=xxx

{
  "symbol": "BTCUSDT",
  "longExchange": "binance",
  "shortExchange": "okx",
  "quantity": 0.0237,
  "leverage": 2
}
```

**注意**: `quantity` 為幣本位數量（如 0.0237 BTC），確保兩邊數量完全對沖。

**成功響應**:

```json
{
  "success": true,
  "position": {
    "id": "clxxx123",
    "symbol": "BTCUSDT",
    "longExchange": "binance",
    "shortExchange": "okx",
    "leverage": 2,
    "status": "OPEN"
  },
  "trades": [
    {
      "exchange": "binance",
      "side": "LONG",
      "orderId": "123456789",
      "price": "42150.50",
      "quantity": "0.0237",
      "fee": "0.50"
    },
    {
      "exchange": "okx",
      "side": "SHORT",
      "orderId": "987654321",
      "price": "42148.30",
      "quantity": "0.0237",
      "fee": "0.49"
    }
  ],
  "message": "Position opened successfully"
}
```

### 查詢餘額 API

```bash
GET /api/balances?exchanges=binance,okx
Cookie: session=xxx
```

**響應**:

```json
{
  "balances": [
    {
      "exchange": "binance",
      "available": 2000.50,
      "total": 2500.00,
      "status": "success"
    },
    {
      "exchange": "okx",
      "available": 1500.00,
      "total": 1800.00,
      "status": "success"
    }
  ]
}
```

## 常見問題

### Q: 為什麼需要 10% 的餘額緩衝？

A: 緩衝用於應對：
- 市價單的滑點
- 手續費扣除
- 保證金計算的微小差異

### Q: 槓桿 1x 和 2x 有什麼區別？

| 項目 | 1x | 2x |
|------|----|----|
| 所需保證金 | 100% | 50% |
| 風險 | 較低 | 較高 |
| 強平風險 | 極低 | 需注意 |
| 適合 | 保守策略 | 追求效率 |

### Q: 開倉過程中可以取消嗎？

A: 一旦點擊「確認開倉」，操作無法取消。請在確認前仔細檢查所有參數。

### Q: 同一交易對可以開多個倉位嗎？

A: 不可以。同一時間只能對同一交易對有一個開倉操作。已開立的倉位需要先平倉才能再次開倉。
