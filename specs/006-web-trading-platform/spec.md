# Feature Specification: Web 多用戶套利交易平台

**Feature Branch**: `006-web-trading-platform`
**Created**: 2025-10-27
**Status**: Draft
**Input**: User description: "將現有的 CLI 套利監控工具重構為一個完整的 Web 多用戶平台，支援用戶註冊登入、API Key 管理、即時套利機會監控（WebSocket 推送）、手動開倉平倉交易執行、歷史收益和開關倉記錄追蹤。技術棧：Next.js 14 全棧 + Socket.io + Email/Password 認證。"

## Glossary *(mandatory)*

為確保規格文件中術語使用的一致性，本節定義核心概念的標準用語：

| 術語 | 英文 | 定義 | 使用範例 |
|------|------|------|----------|
| **套利機會** | Arbitrage Opportunity | 當兩個交易所的資金費率差異超過設定門檻時，系統偵測到的潛在獲利機會 | "用戶在套利機會列表中看到 BTC/USDT 的機會" |
| **持倉** | Position | 用戶在兩個交易所同時開立的一對多空倉位（hedge position） | "用戶查看當前持倉列表" |
| **開倉** | Open Position | 在兩個交易所同時建立 Long 和 Short 倉位的操作 | "用戶點擊開倉按鈕" |
| **平倉** | Close Position | 同時關閉兩個交易所的倉位的操作 | "用戶執行平倉操作" |
| **資金費率** | Funding Rate | 永續合約的資金費率，通常每 8 小時結算一次 | "查詢兩個交易所的即時資金費率" |
| **交易對** | Symbol / Trading Pair | 加密貨幣交易對，如 BTC/USDT | "選擇 BTC/USDT 交易對" |
| **保證金** | Margin | 開倉所需的初始資金，取決於倉位大小和槓桿倍數 | "系統顯示預估所需保證金" |
| **槓桿** | Leverage | 槓桿倍數，MVP 階段固定為 3x | "使用 3x 槓桿開倉" |
| **未實現 PnL** | Unrealized P&L | 持倉當前的浮動盈虧（未平倉） | "顯示持倉的即時未實現 PnL" |
| **實現 PnL** | Realized P&L | 平倉後確定的實際盈虧 | "計算並記錄實現 PnL" |

**術語使用原則**：
- 規格文件中優先使用中文術語，括號內標註英文（首次出現時）
- 程式碼中使用英文命名（如 `class Position`, `openPosition()`）
- UI 界面中使用中文術語

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 用戶註冊和 API Key 設定 (Priority: P1)

新用戶註冊帳號並設定交易所 API Key，完成後即可開始監控套利機會。這是使用平台的第一步，沒有這個功能，用戶無法使用任何其他功能。

**Why this priority**: 這是所有功能的基礎。用戶必須先註冊並設定 API Key 才能使用平台的任何交易功能。這是獨立可交付的 MVP，允許用戶管理自己的帳號和 API Key。

**Independent Test**: 可以透過創建新帳號、登入、新增 API Key 並驗證其是否正確儲存來獨立測試。測試成功標準是用戶能夠完成註冊並看到已儲存的 API Key 列表。

**Acceptance Scenarios**:

1. **Given** 用戶訪問平台首頁, **When** 點擊「註冊」並輸入有效的 Email 和密碼, **Then** 系統建立新帳號並自動登入
2. **Given** 用戶已登入, **When** 前往「API Key 管理」頁面並新增 Binance API Key, **Then** 系統驗證 API Key 有效性並安全儲存
3. **Given** 用戶已登入, **When** 前往「API Key 管理」頁面並新增 OKX API Key, **Then** 系統驗證 API Key 有效性並安全儲存
4. **Given** 用戶新增了無效的 API Key, **When** 系統驗證 API Key, **Then** 顯示錯誤訊息並拒絕儲存
5. **Given** 用戶已有多組 API Key, **When** 查看 API Key 列表, **Then** 看到所有已儲存的 API Key（僅顯示部分字元以保護安全）

---

### User Story 2 - 即時套利機會監控 (Priority: P2)

已登入的用戶可以在 Web 界面上看到即時更新的套利機會列表，包括當前價格、資金費率、預期收益率，以及清楚標示應該在哪個交易所開多、哪個交易所開空。

**Why this priority**: 這是平台的核心價值，讓用戶能夠即時掌握市場套利機會。依賴 P1 的 API Key 設定才能運作，但可以獨立測試和展示。

**Independent Test**: 可以透過登入、設定 API Key 後，查看套利機會列表頁面來測試。測試成功標準是用戶能夠看到即時更新的套利機會，並且數據在 1 秒內自動更新。

**Acceptance Scenarios**:

1. **Given** 用戶已登入且已設定 API Key, **When** 進入「套利機會」頁面, **Then** 看到當前所有套利機會的列表
2. **Given** 用戶在「套利機會」頁面, **When** 市場出現新的套利機會, **Then** 頁面自動更新並顯示新機會（無需手動重新整理）
3. **Given** 用戶查看某個套利機會, **When** 檢視詳細資訊, **Then** 看到以下資訊：
   - 交易對名稱（例如 BTCUSDT）
   - 兩個交易所的即時價格
   - 兩個交易所的即時資金費率
   - 費率差異（百分比）
   - 預期年化收益率
   - 清楚標示：在 [交易所 A] 開多，在 [交易所 B] 開空
4. **Given** 用戶在「套利機會」頁面停留 5 分鐘, **When** 觀察數據變化, **Then** 價格和費率每秒自動更新
5. **Given** 某個套利機會不再存在（費率差異低於門檻）, **When** 用戶查看列表, **Then** 該機會從列表中移除或標示為已過期

---

### User Story 3 - 手動開倉執行 (Priority: P3)

用戶看到滿意的套利機會後，可以透過「一鍵開倉」功能，同時在兩個交易所開立相應的多頭和空頭倉位。

**Why this priority**: 這是從監控到實際交易的關鍵步驟，但需要 P1 的 API Key 管理和 P2 的機會監控作為基礎。這個功能涉及真實資金操作，需要更多的安全驗證和錯誤處理。

**Independent Test**: 可以透過在測試環境（或模擬模式）中選擇一個套利機會、輸入倉位大小並執行開倉來測試。測試成功標準是系統能夠同時在兩個交易所開倉，並正確記錄倉位資訊。

**Acceptance Scenarios**:

1. **Given** 用戶在「套利機會」頁面看到一個機會, **When** 點擊「開倉」按鈕, **Then** 顯示開倉確認對話框，包含：
   - 交易對和交易所資訊
   - 需要輸入的倉位大小（USDT）
   - 預計使用的槓桿倍數
   - 預估所需保證金
2. **Given** 用戶在開倉對話框中輸入倉位大小, **When** 點擊「確認開倉」, **Then** 系統同時在兩個交易所執行開倉，並顯示執行進度
3. **Given** 開倉成功, **When** 查看「持倉管理」頁面, **Then** 看到新開立的倉位，包含：
   - 交易對
   - 兩個交易所的倉位方向（Long/Short）
   - 開倉價格
   - 倉位大小
   - 開倉時間
   - 當前未實現 PnL
4. **Given** 開倉時其中一個交易所失敗, **When** 系統偵測到部分失敗, **Then** 自動嘗試回滾已成功的開倉，並向用戶顯示錯誤訊息和建議處理方式
5. **Given** 用戶帳戶餘額不足, **When** 嘗試開倉, **Then** 系統在執行前檢查餘額並拒絕開倉，顯示餘額不足的警告

---

### User Story 4 - 手動平倉執行 (Priority: P4)

用戶可以查看當前持倉列表，選擇要平倉的倉位，透過「一鍵平倉」功能同時關閉兩個交易所的對應倉位，並自動計算實現 PnL。

**Why this priority**: 這是完整交易週期的最後一步，允許用戶實現收益。需要 P3 的開倉功能作為前置條件，但可以獨立測試平倉流程。

**Independent Test**: 可以透過在測試環境中先開倉，然後執行平倉操作來測試。測試成功標準是系統能夠同時在兩個交易所平倉，正確計算 PnL 並記錄到歷史。

**Acceptance Scenarios**:

1. **Given** 用戶在「持倉管理」頁面, **When** 查看當前持倉, **Then** 看到所有未平倉的倉位列表，包含即時 PnL
2. **Given** 用戶選擇某個持倉, **When** 點擊「平倉」按鈕, **Then** 顯示平倉確認對話框，包含：
   - 當前倉位詳細資訊
   - 預估平倉價格
   - 預估實現 PnL（價差收益 + 資金費率收益）
3. **Given** 用戶確認平倉, **When** 點擊「確認平倉」, **Then** 系統同時在兩個交易所執行平倉，並顯示執行進度
4. **Given** 平倉成功, **When** 查看「交易歷史」頁面, **Then** 看到新增的已平倉記錄，包含：
   - 開倉和平倉時間
   - 開倉和平倉價格
   - 持倉時間
   - 實現 PnL（分項顯示：價差收益、資金費率收益）
5. **Given** 平倉時其中一個交易所失敗, **When** 系統偵測到部分失敗, **Then** 標記該倉位為「部分平倉」狀態，並提供手動處理選項

---

### User Story 5 - 歷史收益和統計 (Priority: P5)

用戶可以查看歷史交易記錄、總收益統計、每日收益趨勢圖，以及按交易對或時間範圍篩選的詳細記錄。

**Why this priority**: 這是重要的分析和追蹤功能，幫助用戶評估策略效果，但不影響核心交易流程。可以在有足夠歷史數據後獨立開發和測試。

**Independent Test**: 可以透過創建一些歷史交易記錄（或使用測試數據），然後查看統計頁面來測試。測試成功標準是用戶能夠看到正確的收益統計和圖表。

**Acceptance Scenarios**:

1. **Given** 用戶已有歷史交易記錄, **When** 進入「收益統計」頁面, **Then** 看到以下統計資訊：
   - 總實現收益（USDT）
   - 總收益率（百分比）
   - 總交易次數
   - 勝率（獲利交易 / 總交易）
2. **Given** 用戶在「收益統計」頁面, **When** 查看收益趨勢圖, **Then** 看到每日收益的折線圖或柱狀圖
3. **Given** 用戶在「交易歷史」頁面, **When** 查看所有已平倉交易, **Then** 看到完整的交易記錄列表，包含開平倉時間、價格、PnL
4. **Given** 用戶想篩選特定交易對的記錄, **When** 選擇交易對篩選條件, **Then** 只顯示該交易對的歷史記錄
5. **Given** 用戶想查看特定時間範圍的收益, **When** 選擇日期範圍, **Then** 統計資料更新為該時間範圍的數據

---

### Edge Cases

- **網路斷線**: 用戶在開倉或平倉過程中網路斷線，系統如何確保交易狀態一致性？
- **部分執行失敗**: 在兩個交易所同時開倉/平倉時，如果其中一個成功、一個失敗，系統如何處理？
- **API Key 過期或被撤銷**: 用戶的 API Key 在使用過程中失效，系統如何通知用戶並防止錯誤操作？
- **同時多人使用同一組 API Key**: 如果用戶在多個裝置上登入，或多個用戶共用 API Key（不建議但可能發生），系統如何處理競爭條件？
- **極端市場波動**: 在開倉確認和實際執行之間，如果價格劇烈變動導致機會消失，系統如何處理？
- **資料不同步**: 兩個交易所的即時數據更新頻率不同，如何確保顯示的套利機會是真實有效的？
- **帳戶餘額變化**: 用戶在開倉對話框中輸入倉位大小後、實際執行前，餘額被其他操作使用，系統如何處理？
- **長時間未平倉**: 用戶開倉後長時間未平倉，如何追蹤累計的資金費率收益？
- **API Rate Limit**: 當多個用戶同時使用平台，觸及交易所 API 的 Rate Limit，系統如何處理和降級？
- **並發開倉**: 用戶快速點擊多次「開倉」按鈕，系統如何防止重複開倉？

## Requirements *(mandatory)*

### Functional Requirements

#### 用戶管理
- **FR-001**: 系統必須允許新用戶透過 Email 和密碼註冊新帳號
- **FR-002**: 系統必須驗證 Email 格式有效性（標準 RFC 5322 格式）
- **FR-003**: 系統必須要求密碼長度至少 8 個字元，且包含至少一個數字和一個字母
- **FR-004**: 系統必須安全儲存密碼（使用單向雜湊演算法，不可逆）
- **FR-005**: 系統必須允許用戶使用 Email 和密碼登入
- **FR-006**: 系統必須在登入成功後建立使用者會話（session），並在 24 小時後自動過期
- **FR-007**: 系統必須允許用戶登出，登出後立即使會話失效

#### API Key 管理
- **FR-008**: 系統必須允許用戶新增 Binance API Key（包含 API Key 和 Secret Key）
- **FR-009**: 系統必須允許用戶新增 OKX API Key（包含 API Key、Secret Key 和 Passphrase）
- **FR-010**: 系統必須在儲存前驗證 API Key 的有效性（透過呼叫交易所 API 測試連線）
- **FR-011**: 系統必須加密儲存所有 API Key 和 Secret（靜態加密，encryption at rest）。加密方式：使用 AES-256-GCM 算法，主密鑰（Master Key）存儲在環境變數中（變數名：`ENCRYPTION_MASTER_KEY`，長度 32 bytes）
- **FR-012**: 系統必須檢查 API Key 是否具有必要的交易權限（讀取帳戶資訊、開倉、平倉）
- **FR-013**: 系統必須允許用戶查看已儲存的 API Key 列表（僅顯示部分字元，如前 8 後 4）
- **FR-014**: 系統必須允許用戶刪除已儲存的 API Key
- **FR-015**: 系統必須允許用戶暫時停用某個 API Key（不刪除，但不使用於交易）
- **FR-016**: 系統必須隔離不同用戶的 API Key，確保用戶 A 無法存取用戶 B 的 API Key

#### 即時套利機會監控
- **FR-017**: 系統必須從 Binance 和 OKX 獲取即時資金費率資料（更新頻率不超過 5 秒）
- **FR-018**: 系統必須從 Binance 和 OKX 獲取即時價格資料（更新頻率不超過 1 秒）
- **FR-019**: 系統必須計算兩個交易所之間的資金費率差異
- **FR-020**: 系統必須識別當費率差異超過設定門檻時的套利機會（預設門檻：0.5%）。

  **成本結構說明**（基於一般用戶等級，以 $100,000 倉位為例）：
  - 手續費：0.2%（開倉 0.1% + 平倉 0.1%，Taker Fee 0.05% × 4 次操作）
  - 滑點：0.1%（市價單保守估計，流動性較差時可能更高）
  - 價差成本：0.15%（兩交易所標記價格差異，保守估計）
  - 安全邊際：0.05%（預留緩衝應對市場波動）
  - **總成本：0.5%**（$500）

  **獲利邏輯**：
  - 資金費率差 = 0.5%，單次結算收益 = $500，扣除成本後**剛好打平**
  - 資金費率差 = 0.6%，單次結算收益 = $600，扣除成本後**淨賺 $100（0.1%）**
  - **策略優勢**：即使只持倉 8 小時（1 次結算）也能確保不虧損，不依賴資金費率持續性

- **FR-020-1**: 系統必須計算並顯示套利機會的預期淨收益。計算邏輯如下：
  - **預期淨收益** = 資金費率差 - 總成本（0.5%）
  - **預期淨收益率（年化）** = (資金費率差 - 0.5%) × (24 / 8) × 365 = (資金費率差 - 0.5%) × 1095
  - **有效機會判定**：僅當預期淨收益 > 0 時，才視為有效套利機會
  - **範例**：
    * 資金費率差 = 0.6%，預期淨收益 = 0.1%，年化淨收益率 = 109.5%
    * 資金費率差 = 0.7%，預期淨收益 = 0.2%，年化淨收益率 = 219.0%

- **FR-020-2**: 系統必須檢查價差方向，確保不會因價差損失而抵消資金費率收益。價差檢查邏輯如下：
  - **套利方向判定**：
    * 如果 Binance 資金費率 > OKX 資金費率，則在 Binance 做空、OKX 做多
    * 如果 OKX 資金費率 > Binance 資金費率，則在 OKX 做空、Binance 做多
  - **價差優勢檢查**：
    * 做空方的價格應該 **≥** 做多方的價格（賣高買低）
    * 或者價差在可接受範圍內（|價差| ≤ 0.05%）
  - **拒絕條件**：如果價差為反方向（做空方價格明顯低於做多方），即使資金費率差 > 0.5%，也不視為有效套利機會
  - **範例**：
    * Binance 資金費率 0.08%，OKX 0.01%（差異 0.07% > 0.5% ✓）
    * Binance 價格 50000 USDT，OKX 價格 49900 USDT
    * 套利方向：Binance 做空、OKX 做多
    * 價差檢查：Binance (50000) > OKX (49900) ✓ 價差有優勢
    * 結論：**有效套利機會**

    反例：
    * Binance 資金費率 0.08%，OKX 0.01%（差異 0.07% > 0.5% ✓）
    * Binance 價格 49900 USDT，OKX 價格 50100 USDT
    * 套利方向：Binance 做空、OKX 做多
    * 價差檢查：Binance (49900) < OKX (50100) ✗ 價差反方向（虧 0.4%）
    * 結論：**非有效機會**（價差虧損會抵消資金費率收益）

- **FR-021**: 系統必須計算每個套利機會的預期年化收益率（考慮資金費率結算頻率）
- **FR-022**: 系統必須透過 WebSocket 即時推送套利機會更新到已登入用戶的瀏覽器。WebSocket 事件格式如下（詳細規格見 `contracts/websocket.md`）：
  - 事件類型：`opportunity:new`（新機會）、`opportunity:update`（機會更新）、`opportunity:expired`（機會過期）
  - 推送頻率：價格和費率變化時立即推送，但同一機會的更新間隔不少於 1 秒（防止過度推送）
  - 事件 payload 包含：機會 ID、交易對、兩個交易所的價格和費率、預期收益率、時間戳
  - 重連策略：連線斷線時自動重連，使用指數退避策略（1s, 2s, 4s, 8s...最多 30s），無限次重連直到用戶關閉頁面
- **FR-023**: 系統必須清楚標示每個套利機會應該在哪個交易所開多、哪個交易所開空
- **FR-024**: 系統必須顯示每個套利機會的以下資訊：
  - 交易對名稱
  - 兩個交易所的即時價格
  - 兩個交易所的即時資金費率
  - 費率差異（絕對值和百分比）
  - **成本明細**：
    * 總成本：0.5%（手續費 0.2% + 滑點 0.1% + 價差 0.15% + 安全邊際 0.05%）
  - **預期淨收益**：資金費率差 - 總成本（例如：0.6% - 0.5% = 0.1%）
  - **預期淨年化收益率**：基於淨收益計算的年化報酬（例如：0.1% × 1095 = 109.5%）
  - 機會發現時間
- **FR-025**: 系統必須在機會不再有效時（費率差異低於門檻）移除或標示該機會

#### 手動開倉執行
- **FR-026**: 系統必須允許用戶選擇任一套利機會進行開倉
- **FR-027**: 系統必須要求用戶輸入倉位大小（以 USDT 計價）
- **FR-028**: 系統必須顯示預估所需保證金（基於設定的槓桿倍數）
- **FR-029**: 系統必須在執行開倉前驗證用戶在兩個交易所的可用餘額是否足夠。驗證邏輯如下：
  - 計算所需保證金 = 倉位大小 / 槓桿倍數（MVP 階段槓桿固定為 3x）
  - 查詢兩個交易所的可用 USDT 餘額
  - 驗證每個交易所的可用餘額 >= 所需保證金 × 1.1（預留 10% 緩衝以應對滑點和手續費）
  - 如果任一交易所餘額不足，拒絕開倉並顯示明確的錯誤訊息
- **FR-030**: 系統必須同時在兩個交易所執行開倉操作（一個 Long，一個 Short）
- **FR-031**: 系統必須使用市價單（Market Order）來確保開倉和平倉的執行成功率（MVP 階段不支援限價單，未來版本可擴展）
- **FR-032**: 系統必須記錄每次開倉的詳細資訊：
  - 交易對
  - 兩個交易所的名稱
  - 倉位方向（Long/Short）
  - 開倉價格
  - 倉位大小
  - 槓桿倍數
  - 開倉時間
  - 開倉時的資金費率
- **FR-033**: 系統必須處理開倉失敗的所有情況並向用戶顯示明確的錯誤訊息：
  - **完全失敗**（兩個交易所都失敗）：顯示失敗原因（如餘額不足、API 錯誤、網路超時），無需回滾
  - **部分失敗**（一個交易所成功，一個失敗）：
    - 自動嘗試平倉已成功的部分（最佳努力，best effort，最多重試 3 次：立即重試、1 秒後重試、2 秒後重試，總耗時約 3-4 秒）
    - 如果回滾失敗，將倉位標記為「異常」狀態並記錄到 AuditLog
    - 通知用戶手動處理（顯示受影響的交易所和倉位詳情）
- **FR-034**: 系統必須防止並發開倉（用戶快速多次點擊開倉按鈕），實作方式包括：
  - 前端：點擊「開倉」後立即禁用按鈕，直到操作完成或超時（5 秒）
  - 後端：使用分散式鎖（如 Redis）確保同一用戶同一時間只能執行一次開倉操作

#### 手動平倉執行
- **FR-036**: 系統必須允許用戶查看所有當前持倉列表
- **FR-037**: 系統必須顯示每個持倉的即時未實現 PnL（包含價差變化和累計資金費率）
- **FR-038**: 系統必須允許用戶選擇任一持倉進行平倉
- **FR-039**: 系統必須在平倉前顯示預估的實現 PnL
- **FR-040**: 系統必須同時在兩個交易所執行平倉操作
- **FR-041**: 系統必須記錄每次平倉的詳細資訊：
  - 平倉價格
  - 平倉時間
  - 實現 PnL（分項：價差收益、資金費率收益）
- **FR-042**: 系統必須在平倉成功後將該倉位移至「交易歷史」
- **FR-043**: 系統必須處理部分平倉失敗的情況，標記為「部分平倉」狀態並提供手動處理選項
- **FR-044**: 系統必須追蹤持倉期間的累計資金費率收支。實作方式：當用戶查看持倉的未實現 PnL 或執行平倉時，系統向交易所 API 查詢該倉位的累積資金費率收支並計算到 PnL 中（回溯計算，不需要即時監控每 8 小時結算）

#### 歷史記錄和收益統計
- **FR-045**: 系統必須儲存所有已平倉交易的完整記錄
- **FR-046**: 系統必須計算並顯示用戶的總實現收益（所有已平倉交易的 PnL 總和）
- **FR-047**: 系統必須計算並顯示用戶的總收益率（總收益 / 總投入本金）
- **FR-048**: 系統必須統計用戶的總交易次數和勝率（獲利交易 / 總交易）
- **FR-049**: 系統必須提供按日期範圍篩選交易記錄的功能
- **FR-050**: 系統必須提供按交易對篩選交易記錄的功能
- **FR-051**: 系統必須顯示每日收益趨勢圖（折線圖或柱狀圖）
- **FR-052**: 系統必須允許用戶匯出交易記錄（CSV 或 Excel 格式）

#### 系統安全和穩定性
- **FR-053**: 系統必須記錄所有關鍵操作的審計日誌（登入、API Key 變更、開倉、平倉）
- **FR-054**: 系統必須在偵測到可疑活動時（如異常大量 API 呼叫）暫時凍結用戶帳號並通知管理員
- **FR-055**: 系統必須實作 API Rate Limiting，防止單一用戶過度使用系統資源
- **FR-056**: 系統必須在交易所 API 回應錯誤時進行自動重試（最多 3 次，使用指數退避策略）
- **FR-057**: 系統必須提供健康檢查端點（health check），監控系統和資料庫狀態
- **FR-058**: 系統必須在關鍵錯誤發生時通知管理員（如資料庫連線失敗、交易所 API 持續失敗）

### Key Entities

- **User（用戶）**: 代表使用平台的個人
  - 基本資訊：Email、加密後的密碼、註冊時間
  - 關聯：擁有多組 API Key、多個持倉、多筆交易歷史

- **API Key（API 金鑰）**: 用戶在交易所的 API 認證資訊
  - 基本資訊：交易所名稱（Binance/OKX）、加密後的 Key 和 Secret、啟用狀態、最後驗證時間
  - 關聯：屬於某個用戶

- **ArbitrageOpportunity（套利機會）**: 偵測到的資金費率套利機會
  - 基本資訊：交易對、兩個交易所名稱、即時價格、即時資金費率、費率差異、預期年化收益率、開多交易所、開空交易所、發現時間、狀態（ACTIVE/EXPIRED）
  - 關聯：可被用戶選擇進行開倉

- **Position（持倉）**: 用戶當前持有的未平倉套利倉位
  - 基本資訊：
    - 交易對
    - 兩個交易所的倉位詳細（交易所名稱、方向 Long/Short、開倉價格、倉位大小、槓桿）
    - 開倉時間
    - 開倉時的資金費率
    - 當前未實現 PnL
  - 關聯：屬於某個用戶，基於某個套利機會開立

- **Trade（交易記錄）**: 已平倉的交易完整記錄
  - 基本資訊：
    - 交易對
    - 兩個交易所的倉位詳細
    - 開倉和平倉時間、價格
    - 持倉時間
    - 實現 PnL（分項：價差收益、資金費率收益）
    - 交易狀態（SUCCESS/PARTIAL/FAILED）
  - 關聯：屬於某個用戶

- **NotificationLog（通知日誌）**: 系統發送的通知記錄（用於審計和防抖動）
  - 基本資訊：通知類型、通知內容、接收者、發送時間、發送狀態
  - 關聯：與用戶或系統事件相關

- **AuditLog（審計日誌）**: 關鍵操作的審計記錄
  - 基本資訊：操作類型、操作者、操作時間、操作詳情、IP 位址
  - 關聯：與用戶操作相關

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用戶可以在 5 分鐘內完成註冊、登入和 API Key 設定的完整流程
- **SC-002**: 套利機會資料的即時更新延遲不超過 1 秒（從交易所獲取資料到推送至用戶瀏覽器）
- **SC-003**: 開倉和平倉操作的成功率達到 95% 以上（排除用戶餘額不足和網路問題）
- **SC-004**: 開倉操作的總執行時間（從用戶確認到完成雙邊開倉）不超過 5 秒
- **SC-005**: 平倉操作的總執行時間不超過 5 秒
- **SC-006**: 系統可同時支援至少 10 個用戶透過 WebSocket 接收即時套利機會更新，數據推送延遲不超過 1 秒，不出現效能降級。測試方法：使用負載測試工具（如 Artillery、k6）模擬 10 個並發 WebSocket 連線，持續接收數據至少 5 分鐘
- **SC-007**: 歷史收益和交易記錄的計算準確率達到 100%（與交易所實際記錄一致）
- **SC-008**: 用戶在首次使用時，能夠在 10 分鐘內理解如何監控機會並執行第一次開倉（無需外部文件或支援）
- **SC-009**: 系統在處理部分開倉/平倉失敗時，能夠在 5 秒內自動嘗試回滾（3 次重試約 3-4 秒）或通知用戶手動處理
- **SC-010**: API Key 的加密儲存和解密過程不會增加超過 100ms 的延遲
- **SC-011**: 用戶可以在不重新整理頁面的情況下，持續監控套利機會至少 1 小時（WebSocket 連線穩定）
- **SC-012**: 系統在單一交易所 API 暫時故障時，能夠降級服務（例如暫停該交易所的機會偵測）而不影響其他功能

## Assumptions *(optional)*

1. **用戶數量**: 假設初期用戶數量不超過 10 人，因此不需要實作複雜的負載平衡或快取策略
2. **交易對**: 假設初期只支援 USDT 永續合約交易對，不支援幣本位合約
3. **槓桿倍數**: 假設使用固定槓桿倍數（例如 3x），不允許用戶自訂
4. **資金費率結算頻率**: 假設 Binance 和 OKX 的資金費率結算頻率為每 8 小時一次（實際可能因交易所而異）
5. **訂單類型**: 假設使用市價單來確保開倉和平倉的成功率，雖然可能有少許滑點
6. **網路環境**: 假設用戶在正常網路環境下使用平台，系統不保證在極端網路條件下的可用性
7. **交易所 API 穩定性**: 假設交易所 API 在 99% 的時間內可用，系統會實作重試機制來應對暫時性故障
8. **法規遵從**: 假設用戶負責確保其所在地區允許使用此類套利交易平台，系統不實作 KYC 或地區限制
9. **密碼重設**: 假設初期版本不包含密碼重設功能，用戶需聯繫管理員重設密碼
10. **多幣種支援**: 假設初期只支援 USDT 計價，不支援其他穩定幣或法幣

## Out of Scope *(optional)*

以下功能明確不在本次規格範圍內，可能在未來版本考慮：

1. **自動交易**: 系統不會自動執行開倉或平倉，所有交易必須由用戶手動確認
2. **移動應用**: 初期只提供 Web 界面，不開發 iOS 或 Android 應用
3. **多語言支援**: 初期只支援繁體中文界面
4. **進階風險管理**: 不包含止損、止盈、追蹤止損等進階風險管理功能
5. **社交功能**: 不包含用戶間的訊息交流、策略分享等社交功能
6. **回測功能**: 不提供歷史數據回測或策略模擬功能
7. **第三方交易所**: 初期只支援 Binance 和 OKX，不支援其他交易所（如 Bybit、FTX 等）
8. **即時通知（Email/Telegram）**: 初期只在 Web 界面內顯示通知，不發送 Email 或 Telegram 訊息
9. **團隊功能**: 不支援團隊帳號、角色權限管理等多層級用戶系統
10. **API 介面**: 不提供給第三方開發者使用的 REST API 或 WebSocket API
11. **白標方案**: 不提供白標（White-label）或可客製化的版本給其他團隊使用

## Dependencies *(optional)*

### 內部依賴（專案內既有程式碼）

1. **套利機會偵測邏輯**: 需要重用 `src/services/monitor/OpportunityDetector.ts` 的核心偵測算法
2. **資料庫 Schema**: 需要擴展現有的 Prisma Schema，新增 User、API Key 管理相關的表
3. **交易所 API 整合**: 需要改造 `src/connectors/` 下的交易所 API 封裝，支援多用戶的 API Key 管理
4. **Repository 層**: 需要擴展 `src/repositories/` 下的 Repository，新增用戶和 API Key 管理的資料存取層

### 外部依賴（第三方服務或 API）

1. **Binance Futures API**: 獲取資金費率、價格、執行開倉平倉操作
2. **OKX API**: 獲取資金費率、價格、執行開倉平倉操作
3. **PostgreSQL + TimescaleDB**: 資料庫，已存在於專案中
4. **WebSocket 服務**: 需要實作 Socket.io 服務來推送即時數據

### 技術依賴

1. **Next.js 14**: 前後端框架
2. **Socket.io**: WebSocket 即時推送
3. **Prisma ORM**: 資料庫 ORM（既有）
4. **加密庫**: 用於 API Key 和密碼的加密存儲（例如 bcrypt、crypto 模組）

## Risks *(optional)*

### 技術風險

1. **WebSocket 連線穩定性**: 如果用戶的網路環境不穩定，WebSocket 可能頻繁斷線重連，影響即時數據推送
   - **緩解策略**: 實作自動重連機制（使用指數退避策略：1s, 2s, 4s, 8s...最多 30s，無限次重連），並在斷線時顯示明確的連線狀態提示給用戶

2. **交易所 API 延遲或故障**: 交易所 API 可能在高峰時段延遲或暫時不可用，影響開倉平倉操作
   - **緩解策略**: 實作重試機制（最多 3 次）、顯示明確的錯誤訊息、記錄故障日誌以便分析

3. **部分開倉/平倉失敗**: 在兩個交易所同時操作時，可能出現一個成功一個失敗的情況，導致用戶承擔單邊風險
   - **緩解策略**: 實作回滾機制（best effort）、清楚標記異常狀態、提供手動處理選項

4. **並發競爭條件**: 多個用戶同時使用可能觸發競爭條件（例如同時讀寫資料庫）
   - **緩解策略**: 使用資料庫事務（Transaction）來確保操作的原子性

### 安全風險

1. **API Key 洩漏**: 如果 API Key 加密不當或系統被入侵，用戶的 API Key 可能洩漏，導致資金損失
   - **緩解策略**: 使用業界標準的加密算法（AES-256-GCM，主密鑰存儲在環境變數中）、定期安全審計、限制 API Key 權限（僅交易和查詢）

2. **密碼暴力破解**: 攻擊者可能嘗試暴力破解用戶密碼
   - **緩解策略**: 實作登入失敗次數限制（例如 5 次後鎖定帳號 15 分鐘）、使用強密碼要求

3. **會話劫持**: 用戶的會話 Token 可能被攻擊者竊取
   - **緩解策略**: 使用 HttpOnly Cookie 存儲 Token、實作會話過期機制（24 小時）、使用 HTTPS

### 業務風險

1. **市場風險**: 套利機會的預期收益可能因市場快速變化而無法實現
   - **緩解策略**: 明確告知用戶這是市場風險，不做收益保證、建議用戶設定合理的倉位大小

2. **交易執行滑點**: 使用市價單可能產生滑點，實際成交價格與預期不符
   - **緩解策略**: 在開倉前顯示預估滑點、記錄實際成交價格供用戶檢視

3. **用戶操作錯誤**: 用戶可能誤操作（如輸入錯誤的倉位大小）導致損失
   - **緩解策略**: 在確認對話框中清楚顯示所有關鍵資訊、實作「確認」按鈕需要二次確認

## Notes *(optional)*

### 重構策略

本功能是對既有 CLI 專案的重大重構，從單用戶命令列工具轉變為多用戶 Web 平台。重構策略如下：

1. **保留核心邏輯**:
   - 套利機會偵測算法（`OpportunityDetector`）
   - 交易所 API 封裝（`src/connectors/`）
   - Repository 層（`src/repositories/`）

2. **新增 Web 層**:
   - Next.js 14 App Router 作為前後端框架
   - API Routes 處理後端邏輯
   - React 元件構建前端界面

3. **擴展資料庫**:
   - 新增 User、ApiKey 等用戶管理表
   - 保留既有的 ArbitrageOpportunity、OpportunityHistory 等表

4. **引入即時推送**:
   - 整合 Socket.io 來替代 CLI 的輪詢機制

### 開發優先級建議

建議按照以下順序進行開發，確保每個階段都有可交付的 MVP：

**Phase 1**: P1 - 用戶註冊和 API Key 設定
  - 可交付：用戶可以註冊、登入、管理 API Key

**Phase 2**: P2 - 即時套利機會監控
  - 可交付：用戶可以看到即時的套利機會列表

**Phase 3**: P3 - 手動開倉執行
  - 可交付：用戶可以開倉並看到持倉列表

**Phase 4**: P4 - 手動平倉執行
  - 可交付：完整的交易週期（開倉 → 持倉 → 平倉）

**Phase 5**: P5 - 歷史收益和統計
  - 可交付：完整的交易追蹤和分析功能

### UI/UX 考慮

雖然本規格不包含實作細節，但以下 UI/UX 原則應該被考慮：

1. **關鍵資訊突出**: 套利機會列表應該清楚標示「開多交易所」和「開空交易所」，使用顏色或圖示區分
2. **即時更新視覺反饋**: 當數據更新時，應該有視覺提示（如閃爍、顏色變化）讓用戶知道數據是即時的
3. **確認對話框**: 所有涉及資金的操作（開倉、平倉）都必須有清楚的確認對話框，顯示關鍵資訊
4. **錯誤訊息友善**: 錯誤訊息應該用非技術性語言描述問題，並提供建議的解決方案
5. **響應式設計**: 雖然初期以桌面為主，但應該考慮平板裝置的使用體驗

## Clarifications

### Session 2025-10-30

- Q: 當用戶持倉跨越多個 8 小時結算週期時，系統應該如何處理資金費率結算？ → A: 系統在計算 PnL 時才向交易所 API 查詢累積的資金費率收支（回溯計算）
- Q: API Key 加密的密鑰管理方式為何（密鑰如何生成、存儲、輪換）？ → A: 單一主密鑰存儲在環境變數中，使用 AES-256-GCM 加密（適合小團隊內部使用）
- Q: WebSocket 斷線後的重連策略細節為何（重試次數、間隔、何時放棄）？ → A: 無限次重連嘗試，使用指數退避（1s, 2s, 4s...最多 30s），直到用戶關閉頁面
- Q: SC-006「系統可同時支援至少 10 個用戶線上使用」的具體定義和測試方法為何？ → A: 10 個用戶同時透過 WebSocket 接收即時數據，延遲不超過 1 秒，測試方式：使用負載測試工具模擬 10 個並發 WebSocket 連線
- Q: 部分開倉失敗時回滾重試的間隔和策略為何？ → A: 立即重試 + 短間隔（立即、1 秒後、2 秒後），總耗時約 3-4 秒，適合快速回滾最小化風險暴露
